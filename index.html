/* ==========================================
   ====== ğŸš‘ å¼·åˆ¶åµæ¸¬é‡è¨­å¯†ç¢¼ (æ”¹è‰¯ç‰ˆ) ======
   ========================================== */
window.addEventListener('load', async () => {
    const hash = window.location.hash;

    // 1. å…ˆæª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤ (ä¾‹å¦‚é€£çµéæœŸ)
    if (hash && hash.includes('error_code=otp_expired')) {
        alert("âš ï¸ å¯†ç¢¼é‡è¨­é€£çµå·²éæœŸæˆ–å¤±æ•ˆï¼\n\nè«‹é‡æ–°æŒ‰ã€Œå¿˜è¨˜å¯†ç¢¼ã€å†ç™¼é€ä¸€å°éƒµä»¶ã€‚");
        // æ¸…é™¤ç¶²å€ä¸Šçš„éŒ¯èª¤è¨Šæ¯
        window.history.replaceState(null, '', window.location.pathname);
        return;
    }

    // 2. æª¢æŸ¥æ˜¯å¦æ­£å¸¸çš„é‡è¨­æµç¨‹
    if (hash && hash.includes('type=recovery')) {
        console.log("æ­£åœ¨è™•ç†å¯†ç¢¼é‡è¨­æµç¨‹...");

        // å»¶é² 1 ç§’ï¼Œç­‰å¾… Supabase è™•ç† Session äº¤æ›
        setTimeout(async () => {
            // é—œéµæª¢æŸ¥ï¼šç¢ºä¿å·²ç¶“å»ºç«‹äº† Session æ‰èƒ½æ›´æ–°
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (!session) {
                // å¦‚æœä¾†åˆ°é€™è£¡ä½†æ²’æœ‰ sessionï¼Œé€šå¸¸ä»£è¡¨é€£çµæœ‰å•é¡Œä½†æ²’è¢« error catch åˆ°
                console.warn("æ‰¾ä¸åˆ° Sessionï¼Œç„¡æ³•æ›´æ–°å¯†ç¢¼");
                return;
            }

            const newPassword = prompt("ğŸ” æª¢æ¸¬åˆ°é‡è¨­å¯†ç¢¼è«‹æ±‚ï¼\n\nè«‹è¼¸å…¥æ‚¨çš„æ–°å¯†ç¢¼ï¼š");
            
            if (newPassword) {
                if(typeof showToast === 'function') showToast("æ­£åœ¨æ›´æ–°å¯†ç¢¼...", "info");
                
                const { error } = await supabaseClient.auth.updateUser({ password: newPassword });

                if (error) {
                    alert("âŒ æ›´æ–°å¤±æ•—ï¼š" + error.message);
                } else {
                    alert("âœ… å¯†ç¢¼å·²æ›´æ–°æˆåŠŸï¼\n\nè«‹ä½¿ç”¨æ–°å¯†ç¢¼é‡æ–°ç™»å…¥ã€‚");
                    window.history.replaceState(null, '', window.location.pathname);
                    window.location.reload();
                }
            }
        }, 1000); // å»¶é•·å°‘å°‘æ™‚é–“è‡³ 1ç§’ï¼Œæ¯”è¼ƒç©©é™£
    }
});
