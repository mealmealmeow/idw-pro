<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æˆ‘ä¸æƒ³åŠªåŠ›äº†</title>
  <!-- å¼•å…¥ xlsx.js å‡½å¼åº«ï¼Œç”¨æ–¼è™•ç† Excel æª”æ¡ˆ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  
  <!-- å¼•å…¥ Google Fonts çš„ LXGW WenKai TC (éœé¶©æ–‡æ¥· TC) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabase = supabase.createClient(
    'https://xosxagywgwcprvopbtwl.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhvc3hhZ3l3Z3djcHJ2b3BidHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNzc2ODgsImV4cCI6MjA3ODk1MzY4OH0.8hL9sC9qErhHI93QaFoy4WQt8tvxemCd2-fqaW6DSRg'
  );
</script>
<div id="auth-container" style="display: flex; align-items: center; gap: 10px; margin-left: auto; margin-right: 1rem;">
  <span id="user-email" style="font-size: 0.9rem; display: none;"></span>
  <button id="btn-login" class="action-btn" style="font-size: 0.9rem; padding: 0.4rem 1rem; background: #4CAF50;">ç™»å…¥é›²ç«¯</button>
  <button id="btn-logout" class="action-btn" style="font-size: 0.9rem; padding: 0.4rem 1rem; background: #795548; display: none;">ç™»å‡º</button>
</div>

<div class="font-controls">
  ...
</div>
<style>
  /* --- æ–‡é’é¢¨è‰²å½©èˆ‡å­—é«”å®šç¾© --- */
  :root {
    --primary-bg: #f7f3eb;       /* ä¸»èƒŒæ™¯è‰² - æº«æ½¤ç±³ç™½åç° */
    --secondary-bg: #fcfaf6;     /* å¡ç‰‡èƒŒæ™¯ - æŸ”å’Œå¥¶æ²¹ç™½ */
    --text-color: #5b5044;       /* ä¸»è¦æ–‡å­— - æ·±å•¡ç° */
    --border-color: #e1d8c8;     /* é‚Šæ¡†è‰² - æ·ºäºéº»è‰² */
    --accent-color: #5A8F7B;     /* ä¸»é¡Œè‰²/å¼·èª¿è‰² - æ²‰éœç°ç¶  */
    --accent-color-soft: #cfe3d9;
    --title-color: #3d5c4f;      /* æ¨™é¡Œè‰² - æ·±ç°ç¶  */
    --header-bg: linear-gradient(120deg, #5A8F7B, #93b8a5); /* é é¦–èƒŒæ™¯æ¼¸å±¤ */
    --nav-bg: #f1ece4;           /* å°èˆªèƒŒæ™¯ - äºéº»è‰² */
    --nav-active-bg: #5A8F7B;    /* å°èˆªå•Ÿç”¨èƒŒæ™¯ - ä¸»é¡Œè‰² */
    --nav-active-color: #fff;    /* å°èˆªå•Ÿç”¨æ–‡å­— - ç™½è‰² */
    --problem-color: #c86a5a;    /* å•é¡Œ/å¾…æ”¹é€² - æŸ”å’Œç£šç´… */
    --excellent-color: #7a9e78;  /* å„ªé»/ä½³ä½œ - æ²‰ç©©æ©„æ¬–ç¶  */
    --copy-success-bg: #5f9f80;  /* è¤‡è£½æˆåŠŸ - ç¨äº®ç¶ è‰² */
    --modal-bg: rgba(0,0,0,0.28);
    --modal-card-bg: #fffdf8;
    --shadow-color: rgba(52, 43, 32, 0.10); /* é™°å½±é¡è‰² */
    --btn-brown-bg: #a18b73;     /* å•¡è‰²æŒ‰éˆ•èƒŒæ™¯ */
    --btn-brown-hover: #8f7a63;
    --dashed-box-bg: #f9fbff;    /* è™›ç·šæ¡†èƒŒæ™¯è‰² */
    --empty-state-bg: #f7f2ea;   /* ç©ºç‹€æ…‹èƒŒæ™¯è‰² */
    --empty-state-text: #93897a; /* ç©ºç‹€æ…‹æ–‡å­—é¡è‰² */
    --missing-bg: #fff0f0;       /* æœªå¡«å¯«å­¸ç”ŸèƒŒæ™¯è‰² - æ·¡ç²‰ç´… */
    --missing-text: #c86a5a;     /* æœªå¡«å¯«å­¸ç”Ÿæ–‡å­—é¡è‰² */
    --danger-bg-soft: #fef2f2;
    --danger-border-soft: #fecaca;
    --progress-tracker-bg: #fdfae5;
    --progress-tracker-border: #f0e6c5;
    --progress-kpi-color: #4CAF50;
    --progress-pending-color: #f44336;


    --radius-lg: 14px;
    --radius-md: 10px;
    --radius-sm: 6px;
    --transition-fast: 0.18s ease-out;
    --transition-normal: 0.25s ease-out;
  }
  
  html { 
    scroll-behavior: smooth; 
    font-size: 16px;
  }

  body {
    font-family: 'LXGW WenKai TC', -apple-system, BlinkMacSystemFont, "Segoe UI",
                 system-ui, sans-serif;
    line-height: 1.7;
    letter-spacing: 0.04em;
    background: radial-gradient(circle at top left, #faf3e4, #f5f3ef 55%, #f1f5f4);
    color: var(--text-color);
    margin: 0;
    padding: 0;
    font-size: 1rem;
  }

  /* ===== å®¹å™¨ & Header ===== */

  .main-container { 
    max-width: 1100px; 
    margin: 2rem auto 2.5rem; 
    background-color: var(--secondary-bg); 
    box-shadow: 0 18px 45px var(--shadow-color); 
    border-radius: 20px; 
    border: 1px solid rgba(255,255,255,0.7);
    backdrop-filter: blur(10px);
  }

  header { 
    padding: 1.6rem 2rem 1.4rem; 
    background: var(--header-bg); 
    color: white; 
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    box-shadow: 0 10px 26px rgba(0,0,0,0.16);
    position: relative;
    z-index: 10;
  }

  header::after {
    content: "";
    position: absolute;
    inset: auto 1.8rem -0.65rem;
    height: 14px;
    border-radius: 999px;
    background: rgba(0,0,0,0.08);
    filter: blur(6px);
    opacity: 0.6;
    pointer-events: none;
  }

  h1 { 
    margin: 0; 
    font-size: 2.25rem; 
    font-weight: 500; 
    letter-spacing: 0.16em;
  }

  /* ===== å­—é«”æ§åˆ¶ ===== */

  .font-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: rgba(255,255,255,0.12);
    padding: 0.3rem 0.4rem;
    border-radius: 999px;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.35);
  }

  .font-control-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.7);
    color: white;
    border-radius: 999px;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.9rem;
    width: 2.35rem;
    height: 2.35rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform var(--transition-fast), box-shadow var(--transition-fast),
                background-color var(--transition-fast), border-color var(--transition-fast);
    box-shadow: 0 5px 10px rgba(0,0,0,0.15);
  }

  .font-control-btn:hover {
    background-color: rgba(255,255,255,0.18);
    box-shadow: 0 7px 14px rgba(0,0,0,0.22);
    transform: translateY(-1px);
  }

  .font-control-btn:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 3px 7px rgba(0,0,0,0.2);
  }

  h2 { 
    color: var(--title-color); 
    border-bottom: 1px solid rgba(90,143,123,0.25); 
    padding-bottom: 0.75rem; 
    margin-top: 0; 
    font-weight: 500; 
    font-size: 1.8rem; 
  }
  h3 { 
    color: var(--title-color); 
    font-weight: 500; 
    font-size: 1.45rem; 
  }

  /* ===== ä¸Šæ–¹å°èˆª tabs ===== */

  .page-nav { 
    display: flex; 
    background-color: var(--nav-bg); 
    border-bottom: 1px solid var(--border-color); 
    flex-wrap:wrap; 
    position: sticky;
    top: 0;
    z-index: 5;
    overflow-x: auto;
  }

  .nav-btn { 
    flex: 1 0 auto; 
    padding: 0.9rem 1rem; 
    text-align: center; 
    font-size: 1.02rem; 
    cursor: pointer; 
    border: none; 
    background: transparent; 
    color: #6c776f; 
    transition: background-color var(--transition-normal), color var(--transition-normal),
                box-shadow var(--transition-normal), transform var(--transition-fast); 
    border-bottom: 3px solid transparent; 
    font-family: inherit;
    min-width: 150px;
    position: relative;
    white-space: nowrap;
  }

  .nav-btn::after {
    content: "";
    position: absolute;
    inset: auto 15% -3px;
    height: 0;
    border-radius: 999px;
    background: rgba(90,143,123,0.45);
    opacity: 0;
    transition: opacity var(--transition-fast), height var(--transition-fast);
  }

  .nav-btn:hover {
    background-color: rgba(255,255,255,0.7);
    color: var(--title-color);
  }

  .nav-btn.active { 
    background: linear-gradient(135deg, var(--nav-active-bg), #6caa91); 
    color: var(--nav-active-color); 
    border-bottom-color: #e7dccc;
    box-shadow: 0 5px 15px rgba(0,0,0,0.18);
  }

  .nav-btn.active::after {
    height: 4px;
    opacity: 1;
  }

  .page-content { 
    display: none; 
    background: radial-gradient(circle at top, #fdfbf7 0, #fbf8f3 45%, #f7f3eb 100%);
  }

  .page-content.active { 
    display: block; 
  }

  /* ===== section å€å¡Š ===== */

  .section-box { 
    padding: 2rem; 
    border-bottom: 1px solid rgba(225,216,200,0.6); 
    background-color: rgba(252,250,246,0.88);
  }

  .section-box:nth-child(odd) {
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(251,246,238,0.9));
  }
  
  .section-box:last-child {
    border-bottom: none;
  }

  .input-group { 
    margin-bottom: 1.25rem; 
  }

  .input-group label { 
    display: block; 
    font-weight: 600; 
    margin-bottom: 0.55rem; 
    font-size: 1.05rem; 
    color: #716659;
  }

  .input-group input[type="text"], 
  .input-group input[type="number"], 
  .input-group textarea, 
  .input-group select {
    width: 100%; 
    padding: 0.75rem 1rem; 
    border: 1px solid var(--border-color); 
    border-radius: var(--radius-md); 
    font-size: 0.96rem; 
    box-sizing: border-box; 
    background-color: #fefcf9; 
    font-family: inherit;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast),
                background-color var(--transition-fast), transform var(--transition-fast);
  }

  .input-group textarea { 
    resize: vertical; 
    min-height: 90px; 
  }

  .input-group input:focus, 
  .input-group textarea:focus, 
  .input-group select:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(90, 143, 123, 0.25), 0 10px 20px rgba(0,0,0,0.08);
    background-color: #ffffff;
    transform: translateY(-1px);
  }

  .two-column-grid {
    display: grid;
    grid-template-columns: 1.1fr 0.9fr;
    gap: 2rem;
    align-items: start;
  }

  .two-column-grid .input-group {
    margin-bottom: 0; 
  }

  .two-column-grid .input-group textarea {
    min-height: 150px; 
  }

  @media (max-width: 768px) {
    .two-column-grid {
      grid-template-columns: 1fr;
      gap: 1.25rem;
    }
    .two-column-grid .input-group textarea {
      min-height: 120px;
    }
  }

  /* ===== è©•åˆ† layout ===== */

  .score-layout-grid {
    display: grid;
    grid-template-columns: 2fr 1.1fr;
    gap: 2rem;
    align-items: start;
  }

  .score-main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
  }

  .score-side-column {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .score-main-grid .input-group,
  .score-side-column .input-group {
    margin-bottom: 0;
  }

  .typo-score-input-group {
    border: 2px dashed rgba(90,143,123,0.55);
    padding: 1rem;
    border-radius: var(--radius-md);
    background: linear-gradient(135deg, #f7fafb, #fefbf8);
    box-shadow: 0 6px 14px rgba(0,0,0,0.05);
  }

  .score-total-box input[readonly] {
    background-color: #f6f1e7;
    font-weight: bold;
    font-size: 1.1rem;
    text-align: center;
    padding: 0.9rem 1rem;
    letter-spacing: 0.12em;
  }

  @media (max-width: 900px) {
    .score-layout-grid {
      grid-template-columns: 1fr;
    }
  }
  @media (max-width: 768px) {
    .score-main-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  /* ===== details / summary ===== */

  details { 
    background: #fdfdfc; 
    border: 1px solid rgba(225,216,200,0.9); 
    border-radius: var(--radius-md); 
    margin-bottom: 1rem;
    box-shadow: 0 8px 18px rgba(0,0,0,0.04);
    overflow: hidden;
  }

  summary { 
    padding: 1rem 1.25rem; 
    font-weight: 500; 
    font-size: 1.2rem; 
    color: var(--title-color); 
    cursor: pointer; 
    list-style: none; 
    display: flex; 
    justify-content:space-between; 
    align-items:center; 
    background: linear-gradient(90deg, rgba(250,247,241,0.95), rgba(239,247,243,0.9));
  }

  summary::-webkit-details-marker { 
    display: none; 
  }

  summary::after { 
    content: 'ï¼‹'; 
    font-size: 1.4rem; 
    transition: transform var(--transition-fast), color var(--transition-fast); 
    color: var(--accent-color); 
  }

  details[open] > summary::after { 
    transform: rotate(45deg); 
    color: #44725f;
  }

  details[open] > summary { 
    border-bottom: 1px solid rgba(225,216,200,0.9); 
    box-shadow: inset 0 -5px 10px rgba(0,0,0,0.03);
  }

  .critique-items-container { 
    padding: 1.25rem; 
    background: #fefcf9;
  }
  
  summary > h2, summary > h3 {
    display: inline;
    margin: 0;
    font-size: inherit;
    color: inherit;
    font-weight: inherit;
    border-bottom: none;
    padding-bottom: 0;
  }

  /* ===== è©•èª checkbox å¡ç‰‡ ===== */
  #checklist-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
  }
  @media (max-width: 768px) {
      #checklist-container {
          grid-template-columns: 1fr;
      }
  }

  .check-item { 
    border: 1px solid rgba(225,216,200,0.9); 
    border-radius: var(--radius-md); 
    padding: 1rem 1rem 0.8rem; 
    margin-bottom: 0.9rem; 
    background: #fffdf9; 
    box-shadow: 0 8px 18px rgba(0,0,0,0.04); 
    transition: box-shadow var(--transition-fast), transform var(--transition-fast),
                background-color var(--transition-fast), border-color var(--transition-fast);
  }

  .check-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 26px rgba(0,0,0,0.08);
    border-color: rgba(90,143,123,0.45);
    background-color: #ffffff;
  }

  .check-item-header { 
    display: flex; 
    align-items: center; 
    cursor: pointer; 
    gap: 0.4rem;
  }

  .check-item-header input[type="checkbox"] { 
    margin-right: 0.4rem; 
    width: 1.1rem; 
    height: 1.1rem; 
    flex-shrink: 0; 
    accent-color: var(--accent-color); 
    border-radius: 4px;
  }

  .check-item-header label { 
    flex: 1; 
    font-size: 0.98rem;
    font-weight: 500; 
  }

  .check-item.is-problem label { 
    color: var(--problem-color); 
  }

  .check-item.is-excellent label { 
    color: var(--excellent-color); 
  }

  .interactive-module { 
    display: none; 
    background-color: #f7faf7; 
    border: 1px dashed rgba(90,143,123,0.5); 
    border-radius: var(--radius-md); 
    padding: 0.9rem; 
    margin-top: 0.8rem; 
  }

  .interactive-module .module-row { 
    display: flex; 
    align-items: center; 
    gap: 0.7rem; 
    margin-bottom: 0.7rem; 
    flex-wrap: wrap; 
  }

  .interactive-module .module-row label { 
    font-weight: normal; 
    margin-bottom: 0; 
    flex-shrink: 0; 
  }

  .interactive-module select, 
  .interactive-module input[type="text"] { 
    flex-grow: 1; 
    padding: 0.5rem 0.8rem; 
    border: 1px solid var(--border-color); 
    border-radius: var(--radius-sm); 
    min-width: 150px; 
    background-color: #ffffff;
  }

  .interactive-module .other-input { 
    display: none; 
    margin-top: 0.3rem; 
  }

  .editable-comment { 
    display: none; 
    margin-top: 0.8rem; 
  }

  .editable-comment textarea { 
    width: 100%; 
    min-height: 120px; 
    padding: 0.75rem; 
    font-size: 0.94rem; 
    line-height: 1.7; 
    border: 1px dashed var(--accent-color); 
    border-radius: var(--radius-md); 
    background: #fcfffd; 
    box-sizing: border-box; 
  }

  /* ===== Output Panel ===== */

  #paired-output-section { 
    padding: 2rem; 
    background: linear-gradient(145deg, #f7f3eb, #f2f6f5); 
  }

  .paired-grid { 
    display: grid; 
    grid-template-columns: 1.05fr 1fr; 
    gap: 1.25rem; 
  }
  
  .panel { 
    border: 1px solid rgba(225,216,200,0.9); 
    border-radius: 16px; 
    background: #fefdfb; 
    padding: 1.1rem; 
    display: flex; 
    flex-direction: column;
    box-shadow: 0 14px 30px rgba(0,0,0,0.08);
  }

  .panel details { 
    border: none; 
    background: transparent; 
    margin-bottom: 0; 
    box-shadow: none;
  }

  .panel details > summary { 
    padding: 0.5rem 0.5rem 0.2rem; 
    font-size: 1.35rem; 
    background: transparent; 
  }

  .panel details[open] > summary { 
    border-bottom: 1px solid var(--border-color); 
    box-shadow: none; 
  }

  .panel .panel-content-wrapper { 
    padding: 0.9rem 0.15rem 0.3rem 0.15rem; 
  }
  
  .panel h3 { 
    margin: 0; 
  }

  .panel .panel-actions { 
    display:flex; 
    gap:0.5rem; 
    padding:0.3rem 0.3rem 0.7rem; 
    flex-wrap: wrap; 
    justify-content: flex-end;
  }

  .panel textarea { 
    width: 100%; 
    flex: 1 1 auto; 
    min-height: 350px; 
    padding: 1rem; 
    border: 1px solid rgba(225,216,200,0.9); 
    border-radius: 10px; 
    font-size: 0.98rem; 
    line-height: 1.8; 
    resize: vertical; 
    box-sizing:border-box; 
    background: #fffdfa; 
    font-family: inherit;
    transition: box-shadow var(--transition-fast), border-color var(--transition-fast),
                background-color var(--transition-fast);
  }

  .panel textarea:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(90,143,123,0.25);
    background-color: #ffffff;
  }

  @media (max-width: 980px) { 
    .paired-grid { grid-template-columns: 1fr; } 
  }

  @media (max-width: 600px) {
    html { font-size: 15px; }
    body { background-color: var(--secondary-bg); }
    .main-container { 
      margin: 0; 
      box-shadow: none; 
      border-radius: 0; 
      border: none; 
    }
    .section-box, #paired-output-section { 
      padding: 1.25rem 1rem; 
    }
    h1 { font-size: 1.9rem; }
    header { padding: 1rem 1.25rem; }
  }

  /* ===== æŒ‰éˆ•é€šç”¨æ¨£å¼ ===== */

  .action-btn, .secondary-btn, .danger-btn, .light-btn, .btn { 
    border-radius: 999px; 
    border: none;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.98rem;
    padding: 0.7rem 1.5rem;
    transition: background-color var(--transition-fast), box-shadow var(--transition-fast),
                transform var(--transition-fast), opacity var(--transition-fast);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    white-space: nowrap;
  }

  .action-btn { 
    color: white; 
    background: linear-gradient(135deg, #5A8F7B, #78a693); 
    box-shadow: 0 10px 20px rgba(41,81,64,0.35);
  }

  .action-btn:hover { 
    opacity: 0.95; 
    transform: translateY(-1px);
    box-shadow: 0 14px 26px rgba(41,81,64,0.38);
  }

  .action-btn:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 5px 12px rgba(41,81,64,0.45);
  }

  .action-btn.clear-all { 
    background: linear-gradient(130deg, #c86a5a, #de8373); 
    box-shadow: 0 10px 20px rgba(133,54,41,0.35);
  }

  .action-btn.copied { 
    background: linear-gradient(135deg, var(--copy-success-bg), #92c3aa); 
  }

  .secondary-btn { 
    background: linear-gradient(135deg, var(--btn-brown-bg), var(--btn-brown-hover)); 
    color:#fff; 
    box-shadow: 0 8px 16px rgba(87,69,50,0.35);
  }

  .secondary-btn:hover { 
    opacity: 0.95; 
    transform: translateY(-1px); 
    box-shadow: 0 12px 22px rgba(87,69,50,0.42);
  }

  .danger-btn { 
    background: linear-gradient(135deg, #c86a5a, #de8b7c); 
    color:#fff; 
    padding:0.45rem 0.9rem; 
    box-shadow: 0 7px 15px rgba(133,54,41,0.4);
  }

  .danger-btn:hover { 
    opacity: 0.97; 
    transform: translateY(-1px);
  }

  .light-btn { 
    background: linear-gradient(135deg, #cfe3d9, #9fbfaf); 
    color:#305244; 
    padding:0.55rem 1.1rem; 
    box-shadow: 0 7px 14px rgba(60,90,80,0.28);
  }

  .light-btn.brown { 
    background: linear-gradient(135deg, #dac5a8, #b29372); 
    color:#3f3327; 
  }

  .light-btn:hover { 
    opacity:0.96; 
    transform: translateY(-1px); 
  }

  .btn-primary { 
    background: linear-gradient(135deg, #5A8F7B, #78a693); 
    color:#fff;
  }

  .btn-secondary { 
    background: linear-gradient(135deg, #a18b73, #8d775f); 
    color:#fff;
  }

  .btn-danger { 
    background: linear-gradient(135deg, #c86a5a, #de8475); 
    color:#fff;
  }

  /* ===== Overview / ç©ºç‹€æ…‹ ===== */

  .overview-container { 
    padding: 2rem; 
  }

  .btn-group { 
    display: flex; 
    gap: 0.7rem; 
    flex-wrap: wrap; 
  }
  
  .overview-panel { 
    display: grid; 
    gap: 1rem; 
  }

  .overview-item { 
    border:1px solid var(--border-color); 
    border-radius:var(--radius-md); 
    overflow:hidden; 
    box-shadow: 0 9px 20px rgba(0,0,0,0.06);
    background: #fefbf7;
  }

  .overview-item summary { 
    font-weight: 500; 
    font-size: 1.02rem; 
  }

  .overview-item.is-problem summary { 
    color: var(--problem-color); 
  }

  .overview-item.is-excellent summary { 
    color: var(--excellent-color); 
  }

  .badge { 
    font-size:0.72rem; 
    padding:0.18rem 0.6rem; 
    border-radius:999px; 
    background:var(--nav-bg); 
    color:var(--text-color); 
    margin-left: 0.35rem;
  }

  .overview-body { 
    padding: 1.25rem; 
    background-color: #fdfcf9; 
  }

  .overview-row { 
    display:grid; 
    gap:0.5rem; 
    margin-bottom:0.75rem; 
  }

  .overview-row label { 
    font-weight:normal; 
  }

  .overview-row input[type="text"], 
  .overview-row textarea { 
    width:100%; 
    padding:0.6rem 0.8rem; 
    border:1px solid var(--border-color); 
    border-radius:var(--radius-sm); 
    font-family: inherit; 
    background-color: #ffffff;
    font-size:0.95rem;
  }

  .overview-row textarea { 
    min-height:110px; 
    font-size:0.95rem; 
    line-height:1.6; 
    box-sizing:border-box; 
    resize:vertical; 
  }

  #add-critique-section { 
    border: 2px dashed var(--accent-color); 
    background: var(--dashed-box-bg); 
    box-shadow: 0 8px 18px rgba(0,0,0,0.04);
  }

  #add-critique-section summary { 
    font-size: 1.25rem; 
    font-weight: 500; 
  }

  .add-critique-form { 
    padding: 1.25rem; 
    display: grid; 
    gap: 1rem; 
  }

  .add-critique-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); 
    gap: 1rem; 
  }

  .radio-group { 
    display: flex; 
    gap: 1.25rem; 
    align-items: center; 
  }

  .radio-group label { 
    font-weight: normal; 
    margin-bottom: 0; 
  }

  .radio-group input { 
    margin-right: 0.3rem; 
    accent-color: var(--accent-color); 
  }

  .typo-saved-box { 
    border:1px solid var(--border-color); 
    border-radius:var(--radius-md); 
    padding:1.25rem; 
    background:#f7fafc; 
    margin-top:1rem; 
    box-shadow: 0 8px 18px rgba(0,0,0,0.04);
  }

  .typo-saved-box h3 { 
    margin: 0 0 1rem 0; 
    font-size: 1.2rem; 
  }

  .typo-saved-list { 
    list-style:none; 
    padding:0; 
    margin:0; 
    max-height:220px; 
    overflow:auto; 
  }

  .typo-saved-list li { 
    display:flex; 
    align-items:center; 
    gap:0.5rem; 
    padding:0.45rem 0.7rem; 
    border:1px solid #e7edf5; 
    background:#ffffff; 
    border-radius:6px; 
    margin-bottom:0.45rem; 
  }

  .typo-saved-list .word { 
    flex:1; 
  }

  .io-box {
    border: 2px dashed var(--accent-color);
    background: var(--dashed-box-bg);
    padding: 1.25rem;
    margin-top: 1.25rem;
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .io-box-title {
    font-size: 1.1rem;
    color: var(--title-color);
    font-weight: 500;
    margin: 0 0 0.3rem 0;
  }

  .io-details {
      border: 2px dashed var(--accent-color);
      background: var(--dashed-box-bg);
      border-radius: var(--radius-md);
      margin-top: 1.25rem;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
  }

  .io-details > summary {
      font-size: 1.1rem;
      color: var(--title-color);
      font-weight: 500;
  }

  .io-details-content {
      padding: 0 1.25rem 1.25rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
  }

  /* ===== Modal ===== */

  .modal-backdrop {
    position: fixed; 
    inset: 0; 
    background: var(--modal-bg); 
    display: none; 
    align-items: center; 
    justify-content: center; 
    z-index: 9999;
    backdrop-filter: blur(3px);
  }

  .modal-backdrop.active { 
    display: flex; 
  }

  .modal-card {
    width: min(92vw, 420px); 
    background: var(--modal-card-bg); 
    border-radius: 18px; 
    box-shadow: 0 24px 55px rgba(0,0,0,0.30);
    padding: 1.25rem 1.5rem 1.2rem; 
    display: flex; 
    flex-direction: column; 
    gap: 1rem;
    border: 1px solid rgba(255,255,255,0.85);
  }

  .modal-title { 
    font-weight: 600; 
    font-size: 1.15rem; 
    color: var(--title-color); 
  }

  .modal-actions { 
    display: flex; 
    gap: 0.7rem; 
    justify-content: flex-end; 
    flex-wrap: wrap; 
  }

  .btn { 
    padding: 0.55rem 1.3rem; 
  }

  .empty-state-message {
    padding: 1.2rem;
    text-align: center;
    background: var(--empty-state-bg);
    border-radius: var(--radius-md);
    color: var(--empty-state-text);
    margin-top: 1rem;
    border: 1px dashed var(--border-color);
    font-size: 0.92rem;
  }
  
  /* ===== ç¬¬ä¸‰é ï¼šå­¸ç”Ÿç¸½è¦½ ===== */

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  #overview-class-display {
    font-size: 1.25rem;
    color: var(--title-color);
    margin: 0;
  }

  #progress-tracker {
      background-color: var(--progress-tracker-bg);
      border: 1px solid var(--progress-tracker-border);
      border-radius: var(--radius-md);
      padding: 0.8rem 1.2rem;
      margin-bottom: 1.25rem;
      text-align: center;
      font-size: 1.1rem;
      font-weight: bold;
      display: flex;
      justify-content: center;
      gap: 2rem;
      flex-wrap: wrap;
  }
  #progress-tracker .kpi { color: var(--progress-kpi-color); }
  #progress-tracker .pending { color: var(--progress-pending-color); }

  #student-overview-table-wrapper {
    overflow-x: auto;
    background-color: #fdfbf8;
    border-radius: 12px;
    border: 1px solid rgba(225,216,200,0.9);
    box-shadow: 0 10px 24px rgba(0,0,0,0.06);
  }

  #student-overview-table {
    width: 100%;
    min-width: 1100px; 
    border-collapse: collapse;
    font-size: 0.85em;
  }

  #student-overview-table th, 
  #student-overview-table td {
    border: 1px solid rgba(225,216,200,0.9);
    padding: 0.55rem 0.75rem;
    text-align: center;
    vertical-align: top;
    white-space: nowrap;
  }

  #student-overview-table th {
    background: linear-gradient(135deg, #f1ece4, #e8f0ea);
    color: var(--title-color);
    position: sticky;
    top: 0;
    z-index: 3;
  }

  #student-overview-table th:nth-child(1),
  #student-overview-table td:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 2;
      width: 60px;
      min-width: 60px;
  }
  #student-overview-table th:nth-child(2),
  #student-overview-table td:nth-child(2) {
      position: sticky;
      left: 60px; /* Width of the first column */
      z-index: 2;
      width: 120px;
      min-width: 120px;
  }
  #student-overview-table th:nth-child(1),
  #student-overview-table th:nth-child(2) {
      z-index: 4;
  }
  #student-overview-table td:nth-child(1),
  #student-overview-table td:nth-child(2) {
      background-color: #fdfbf8;
  }
  .row-missing td:nth-child(1),
  .row-missing td:nth-child(2) {
      background-color: var(--danger-bg-soft);
  }


  #student-overview-table td input[type="number"] {
    width: 60px;
    padding: 0.35rem 0.3rem;
    text-align: center;
    border: 1px solid transparent;
    border-radius: 4px;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    transition: background-color var(--transition-fast), border-color var(--transition-fast),
                box-shadow var(--transition-fast);
  }

  #student-overview-table td input[type="number"]:focus {
    outline: none;
    background-color: #fff;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(90, 143, 123, 0.2);
  }

  #student-overview-table .total-score-cell {
      font-weight: bold;
      background-color: #f6f1e7;
  }

  #student-overview-table th:nth-child(3), #student-overview-table td:nth-child(3),
  #student-overview-table th:nth-child(4), #student-overview-table td:nth-child(4),
  #student-overview-table th:nth-child(5), #student-overview-table td:nth-child(5),
  #student-overview-table th:nth-child(6), #student-overview-table td:nth-child(6),
  #student-overview-table th:nth-child(7), #student-overview-table td:nth-child(7) {
    width: 75px;
    min-width: 75px;
  }

  #student-overview-table td:nth-child(9),
  #student-overview-table td:nth-child(10) {
    text-align: left;
    min-width: 300px;
    max-width: 450px;
    white-space: normal;
  }

  #student-overview-table textarea {
    width: 100%;
    border: none;
    background-color: transparent;
    resize: none;
    font-family: inherit;
    font-size: inherit;
    line-height: 1.6;
    color: inherit;
    padding: 0;
    margin: 0;
    overflow-y: hidden;
    box-sizing: border-box;
    transition: background-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  #student-overview-table textarea:focus {
    outline: none;
    background-color: #fff;
    box-shadow: 0 0 0 2px var(--accent-color) inset;
    border-radius: 4px;
  }

  .row-missing {
    background-color: var(--danger-bg-soft);
  }
  .row-missing .unfilled-cell {
      color: var(--problem-color);
      font-style: italic;
  }

  .row-missing .total-score-cell {
    border-color: var(--danger-border-soft);
    color: var(--problem-color);
    font-weight: bold;
  }

  /* ===== ç¬¬äºŒé åˆ†é¡æ‘ºç–Š ===== */

  .category-group {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    margin-bottom: 1.25rem;
    background-color: #fdfcf9;
    box-shadow: 0 10px 22px rgba(0,0,0,0.05);
  }

  .category-group > summary {
    background: linear-gradient(135deg, #f4ede2, #ecf3ef);
    padding: 0.85rem 1.25rem;
    border-radius: var(--radius-md) var(--radius-md) 0 0;
  }

  .category-group > summary > h3 {
    font-size: 1.35rem;
  }

  .category-group[open] > summary {
    border-bottom: 1px solid var(--border-color);
  }

  .category-content {
    padding: 1.25rem;
  }

  .category-content .overview-item {
    margin-bottom: 1rem;
  }

  .category-content .overview-item:last-child {
    margin-bottom: 0;
  }

  /* ===== ç¬¬å››ã€å…­é ï¼šåˆ†æ ===== */

  .analysis-grid {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
    gap: 1.5rem;
    align-items: flex-start;
  }

  @media (max-width: 900px) {
    .analysis-grid {
      grid-template-columns: 1fr;
    }
  }

  .analysis-card {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1.1rem 1.25rem 1.2rem;
    background-color: #fdfcf9;
    box-shadow: 0 10px 22px rgba(0,0,0,0.05);
  }

  .analysis-card h3 {
    margin-top: 0;
    margin-bottom: 0.75rem;
  }

  .analysis-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .analysis-table th,
  .analysis-table td {
    border: 1px solid var(--border-color);
    padding: 0.4rem 0.6rem;
    text-align: left;
  }

  .analysis-table th {
    background-color: #f1ece4;
  }

  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    background-color: #f7fafc;
    padding: 1rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    font-size: 1rem;
  }
  
  /* ===== ç¬¬äº”é ï¼šå…©æ¬„ä½ˆå±€ ===== */
  .ai-page-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    align-items: flex-start;
  }

  .ai-page-grid > div {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  @media (max-width: 900px) {
    .ai-page-grid {
      grid-template-columns: 1fr;
    }
  }

  /* ===== ç¬¬å…­é ï¼šæ–°ç‰ˆ AI å›é¥‹ç”Ÿæˆ ===== */
  .ai-feedback-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
    gap: 0.5rem 1rem;
  }

  .ai-feedback-section-header h3 {
    margin: 0;
    font-size: 1.3rem;
  }

  .ai-feedback-section-header .header-tag {
    font-size: 0.8rem;
    padding: 0.2rem 0.6rem;
    border-radius: 99px;
    background-color: var(--accent-color-soft);
    color: var(--accent-color);
    font-weight: bold;
  }

  .ai-feedback-section-header .header-note {
    font-size: 0.9rem;
    color: #888;
  }

  /* ===== Floating Navigation ===== */
  #floating-nav {
      position: fixed;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      z-index: 1000;
      display: none; /* Initially hidden, shown by JS for page 1 */
      flex-direction: column;
      gap: 8px;
      background-color: rgba(255, 253, 248, 0.85);
      backdrop-filter: blur(8px);
      padding: 8px;
      border-radius: 99px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      border: 1px solid rgba(225, 216, 200, 0.7);
  }

  #floating-nav a {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--accent-color);
      color: white;
      text-decoration: none;
      font-size: 1.1rem;
      font-weight: bold;
      transition: all var(--transition-fast);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  #floating-nav a:hover {
      background-color: var(--title-color);
      transform: scale(1.1);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
  }
  
  @media (max-width: 1200px) {
      #floating-nav {
          display: none; /* Hide on smaller screens to avoid overlap */
      }
  }

</style>
</head>
<body>

  <div class="main-container">
    <header>
      <h1>æˆ‘ä¸æƒ³åŠªåŠ›äº†</h1>
      <div class="font-controls">
        <button class="font-control-btn" onclick="adjustFontSize('decrease')" title="ç¸®å°å­—é«”">A-</button>
        <button class="font-control-btn" onclick="adjustFontSize('reset')" title="é‡è¨­å­—é«”å¤§å°">é‡è¨­</button>
        <button class="font-control-btn" onclick="adjustFontSize('increase')" title="æ”¾å¤§å­—é«”">A+</button>
      </div>
    </header>
    
    <nav class="page-nav">
      <button id="nav-page1" class="nav-btn active" onclick="showPage('page1')">è©•èªç”Ÿæˆå™¨</button>
      <button id="nav-page2" class="nav-btn" onclick="showPage('page2')">è©•èªç¸½è¦½èˆ‡ä¿®è¨‚</button>
      <button id="nav-page3" class="nav-btn" onclick="showPage('page3')">å­¸ç”Ÿç¸½è¦½</button>
      <button id="nav-page4" class="nav-btn" onclick="showPage('page4')">è©•èªåˆ†æ</button>
      <button id="nav-page5" class="nav-btn" onclick="showPage('page5')">AI è©•èªåº«ç”Ÿæˆ</button>
      <button id="nav-page6" class="nav-btn" onclick="showPage('page6')">AI ç”Ÿæˆå›é¥‹</button>
    </nav>

    <main>
      <!-- ==================== ç¬¬ä¸€é ï¼šè©•èªç”Ÿæˆå™¨ ==================== -->
      <div id="page1" class="page-content active">
        
        <div class="section-box" id="step-1-section">
          <h2>æ­¥é©Ÿä¸€ï¼šåŸºæœ¬è³‡æ–™</h2>
          <div class="two-column-grid">
            <div>
              <div class="input-group">
                <label for="student-names">å­¸ç”Ÿåå–®ï¼ˆæ¯è¡Œä¸€ä½ï¼Œå¯åŒ…å«å­¸è™Ÿï¼‰</label>
                <textarea id="student-names" rows="8" placeholder="01-é™³å¤§æ–‡&#10;02 å¼µå°ç¾&#10;æå‰æ˜"></textarea>
              </div>
              <div class="btn-group" style="margin-top: 0.5rem;">
                <button class="light-btn" onclick="downloadStudentListTemplate()">ä¸‹è¼‰ç¯„æœ¬</button>
                <label class="light-btn brown" for="import-student-list" style="cursor: pointer;">åŒ¯å…¥å­¸ç”Ÿåå–® (Excel)</label>
                <input type="file" id="import-student-list" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none;">
              </div>
            </div>
            <div>
              <div class="input-group">
                <label for="topic">ä½œæ–‡é¡Œç›®</label>
                <input type="text" id="topic" placeholder="ä¾‹å¦‚ï¼šè¨˜ä¸€æ¬¡é›£å¿˜çš„ç¶“æ­·">
              </div>
              <div class="input-group">
                <label for="student-class">ç­åˆ¥ / çµ„åˆ¥ (å¯é¸)</label>
                <input type="text" id="student-class" placeholder="ä¾‹å¦‚ï¼š6A, S.3A">
              </div>
            </div>
          </div>
        </div>

        <div class="section-box" id="step-2-section">
          <h2>æ­¥é©ŸäºŒï¼šé¸æ“‡å­¸ç”Ÿèˆ‡ç‰¹åˆ¥ç•™è¨€</h2>
          <div class="two-column-grid">
            <div>
              <div class="input-group">
                <label for="student-select">é¸æ“‡å­¸ç”Ÿ</label>
                <select id="student-select"><option value="">è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥å­¸ç”Ÿåå–®</option></select>
              </div>
              <p style="font-size:0.9em; color:#888; margin-top: 0.5rem; margin-bottom: 1.25rem;">åˆ‡æ›å­¸ç”Ÿæ™‚ï¼Œå¦‚å·²æœ‰è³‡æ–™ï¼Œæœƒè‡ªå‹•è¼‰å…¥ï¼›å¦‚æœªæœ‰ï¼Œå‰‡ç‚ºæ–°è©•èªã€‚</p>
              <div class="btn-group">
                <button class="secondary-btn" onclick="navigateToStudent('prev')">è¼‰å…¥ä¸Šä¸€ä½å­¸ç”Ÿ</button>
                <button class="secondary-btn" onclick="navigateToStudent('next')">è¼‰å…¥ä¸‹ä¸€ä½å­¸ç”Ÿ</button>
              </div>
            </div>
            <div class="input-group">
              <label for="unique-comment">ç‰¹åˆ¥ç•™è¨€ï¼ˆåªçµ¦æ­¤å­¸ç”Ÿï¼‰</label>
              <textarea id="unique-comment" rows="8" placeholder="ä¾‹å¦‚ï¼šæœ¬æ¬¡ä½œæ–‡ç«‹æ„æ·±åˆ»ï¼Œèƒ½çœŸèª è¡¨é”å€‹äººæ„Ÿå—ã€‚"></textarea>
            </div>
          </div>
        </div>

        <div class="section-box" id="step-3-section">
          <h2>æ­¥é©Ÿä¸‰ï¼šä½œæ–‡è©•åˆ†ï¼ˆ1-10åˆ†ï¼‰</h2>
          <p style="font-size:0.9em; color:#888; margin-top:-0.7rem;">ç¸½åˆ†å…¬å¼ =ï¼ˆå…§å®¹Ã—4ï¼‰+ï¼ˆè¡¨é”Ã—3ï¼‰+ï¼ˆçµæ§‹Ã—2ï¼‰+ï¼ˆæ¨™é»Ã—1ï¼‰+ éŒ¯åˆ¥å­—åˆ†ã€‚è‹¥éœ€æ‰£åˆ†ï¼Œè«‹åœ¨ã€ŒéŒ¯åˆ¥å­—ã€æ¬„è¼¸å…¥è² æ•¸ã€‚</p>
          <div class="score-layout-grid">
            <div class="score-main-grid">
              <div class="input-group"><label for="score-content">å…§å®¹</label><input type="number" id="score-content" placeholder="1-10åˆ†"></div>
              <div class="input-group"><label for="score-expression">è¡¨é”</label><input type="number" id="score-expression" placeholder="1-10åˆ†"></div>
              <div class="input-group"><label for="score-structure">çµæ§‹</label><input type="number" id="score-structure" placeholder="1-10åˆ†"></div>
              <div class="input-group"><label for="score-punctuation">æ¨™é»åŠå­—é«”</label><input type="number" id="score-punctuation" placeholder="1-10åˆ†"></div>
            </div>
            <div class="score-side-column">
              <div class="input-group typo-score-input-group"><label for="score-typos">éŒ¯åˆ¥å­— (åŠ /æ¸›)</label><input type="number" id="score-typos" placeholder="å¯ç©ºç™½"></div>
              <div class="score-total-box">
                <div class="input-group"><label for="score-total">ç¸½åˆ†</label><input type="number" id="score-total" placeholder="ç¸½åˆ†" readonly></div>
              </div>
            </div>
          </div>
        </div>

        <div class="section-box" id="step-3-1-section">
          <details>
            <summary><h2>æ­¥é©Ÿ 3.1ï¼šéŒ¯åˆ¥å­—ç´€éŒ„èˆ‡å¸¸è¦‹åº«</h2></summary>
            <div style="padding: 1.25rem;">
              <div id="typo-module" style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end;">
                <div class="input-group" style="flex:1; min-width:160px; margin-bottom:0;">
                  <label for="typo-wrong">éŒ¯å­—ï¼ˆå¯ç•™ç©ºï¼‰</label>
                  <input type="text" id="typo-wrong" placeholder="ä¾‹å¦‚ï¼šæƒ…æ³ï¼ˆéŒ¯ï¼‰">
                </div>
                <div class="input-group" style="flex:1; min-width:160px; margin-bottom:0;">
                  <label for="typo-correct">æ­£å­—ï¼ˆå¯ç•™ç©ºï¼‰</label>
                  <input type="text" id="typo-correct" placeholder="æƒ…æ³ï¼ˆæ­£ï¼‰">
                </div>
                <button class="action-btn" onclick="addTypo()">æ–°å¢åˆ°æœ¬æ¬¡</button>
                <button class="secondary-btn" onclick="saveTypoToCommon()">å­˜å…¥å¸¸è¦‹</button>
              </div>

              <ul id="typo-list" style="list-style:none; padding:0; margin-top:0.75rem;"></ul>

              <div class="typo-saved-box">
                <h3 class="io-box-title">å¸¸è¦‹éŒ¯åˆ¥å­—åº«</h3>
                <ul id="typo-saved-list" class="typo-saved-list"></ul>
              </div>
              
              <details class="io-details">
                <summary><h3>å­—åº«ç®¡ç† (å°å…¥/å°å‡º)</h3></summary>
                <div class="io-details-content">
                  <div class="btn-group">
                    <button class="light-btn" onclick="downloadTypoTemplate()">ä¸‹è¼‰ç¯„æœ¬(Excel)</button>
                    <button class="light-btn" onclick="exportCommonTyposToExcel()">å°å‡ºå­—åº«(Excel)</button>
                    <label class="light-btn" for="import-common-excel" style="display:inline-block; cursor:pointer;">å°å…¥å­—åº«(Excel)</label>
                    <input type="file" id="import-common-excel" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none;">
                  </div>
                  <div class="btn-group">
                    <button class="light-btn brown" onclick="exportCommonTyposToJSON()">å°å‡ºå­—åº«(JSON)</button>
                    <label class="light-btn brown" for="import-common-json" style="display:inline-block; cursor:pointer;">å°å…¥å­—åº«(JSON)</label>
                    <input type="file" id="import-common-json" accept=".json" style="display:none;">
                  </div>
                </div>
              </details>
            </div>
          </details>
        </div>

        <div class="section-box" id="step-4-section">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <h2>æ­¥é©Ÿå››ï¼šè©•èªé …ç›®é¸æ“‡èˆ‡ç·¨ä¿®</h2>
            <div class="btn-group">
              <button class="light-btn" onclick="toggleAllDetails('checklist-container', true)">å…¨éƒ¨å±•é–‹</button>
              <button class="light-btn brown" onclick="toggleAllDetails('checklist-container', false)">å…¨éƒ¨æ”¶åˆ</button>
            </div>
          </div>
          <div id="checklist-container" style="margin-top: 1rem;"></div>
        </div>

        <div id="paired-output-section">
          <div class="paired-grid">
            <div class="panel">
              <details>
                <summary><h3>å®Œæ•´ç‰ˆæœ¬ï¼ˆæ®µè½å¼ï¼‰</h3></summary>
                <div class="panel-content-wrapper">
                  <div class="panel-actions" style="justify-content: flex-end;">
                    <button class="action-btn" onclick="copyOutput('full-output', this)">è¤‡è£½å®Œæ•´ç‰ˆæœ¬</button>
                  </div>
                  <textarea id="full-output" placeholder="æ­¤è™•è‡ªå‹•ç”Ÿæˆå®Œæ•´ç‰ˆæœ¬..." oninput="handleManualEdit('full')"></textarea>
                </div>
              </details>
            </div>

            <div class="panel">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>å­¸ç”Ÿç‰ˆæœ¬ï¼ˆé»åˆ—å¼ï¼‰</h3>
                <div class="panel-actions">
                  <button class="action-btn" onclick="copyOutput('student-report-output', this)">è¤‡è£½å­¸ç”Ÿç‰ˆæœ¬</button>
                </div>
              </div>
              <textarea id="student-report-output" placeholder="æ­¤è™•è‡ªå‹•ç”Ÿæˆå­¸ç”Ÿç‰ˆæœ¬..." oninput="handleManualEdit('student')"></textarea>
            </div>
          </div>
        </div>

        <div class="section-box" style="background: transparent; border-top: none; text-align: center; padding-top: 1rem; padding-bottom: 2rem;">
          <div class="btn-group" style="justify-content: center;">
            <button class="action-btn" onclick="saveCurrentStudentData()">ğŸ’¾ å„²å­˜ç•¶å‰å­¸ç”Ÿè©•èª</button>
            <button class="action-btn clear-all" onclick="confirmUI('ç¢ºå®šæ¸…ç©ºç•¶å‰æ‰€æœ‰è¼¸å…¥ã€å‹¾é¸èˆ‡æœ¬æ¬¡éŒ¯åˆ¥å­—æ¸…å–®ï¼Ÿï¼ˆç­åˆ¥ã€é¡Œç›®ã€å¸¸è¦‹éŒ¯åˆ¥å­—åº«ä¸å—å½±éŸ¿ï¼‰', () => clearAllCore())">æ¸…ç©ºå…¨éƒ¨é¸é …åŠå…§å®¹</button>
          </div>
        </div>
      </div>

      <!-- ==================== ç¬¬äºŒé ï¼šè©•èªç¸½è¦½èˆ‡ä¿®è¨‚ ==================== -->
      <div id="page2" class="page-content">
        <div class="overview-container">
          <h2>è©•èªç¸½è¦½èˆ‡ä¿®è¨‚</h2>
          
          <details id="add-critique-section">
            <summary>æ–°å¢è©•èªé …ç›®</summary>
            <div class="add-critique-form">
              <div class="add-critique-grid">
                <div class="input-group">
                  <label for="new-critique-title">è©•èªæ¨™é¡Œ*</label>
                  <input type="text" id="new-critique-title" placeholder="ä¾‹å¦‚ï¼šäººç‰©å½¢è±¡é®®æ˜">
                </div>
                <div class="input-group">
                  <label>è©•èªé¡å‹*</label>
                  <div class="radio-group">
                    <label><input type="radio" name="new-critique-type" value="excellent" checked> å„ªé»</label>
                    <label><input type="radio" name="new-critique-type" value="problem"> å¾…æ”¹é€²</label>
                  </div>
                </div>
                <div class="input-group">
                  <label for="new-critique-category-select">ç¯„ç–‡åˆ†é¡*</label>
                  <select id="new-critique-category-select"></select>
                </div>
                <div class="input-group" id="new-critique-category-new-wrapper" style="display:none;">
                  <label for="new-critique-category-new">æ–°åˆ†é¡åç¨±*</label>
                  <input type="text" id="new-critique-category-new" placeholder="è«‹è¼¸å…¥æ–°çš„åˆ†é¡åç¨±">
                </div>
              </div>
              
              <div id="new-critique-fields">
                <div class="input-group" data-type-scope="excellent">
                  <label>å„ªé»ç¸½çµ</label>
                  <textarea data-field="strengthSummary" placeholder="å°å„ªé»çš„æ¦‚æ‹¬æ€§æè¿°"></textarea>
                </div>
                <div class="input-group" data-type-scope="problem" style="display:none;">
                  <label>å•é¡Œ</label>
                  <textarea data-field="problemCore" placeholder="å°å•é¡Œæ ¸å¿ƒçš„æ¦‚æ‹¬æ€§æè¿°"></textarea>
                </div>
                <div class="input-group" data-type-scope="problem" style="display:none;">
                  <label>å®œï¼ˆå¯ç”¨ [é¸é …] ä½œç‚ºä¸‹æ‹‰é¸å–®çš„ä½”ä½ç¬¦ï¼‰</label>
                  <textarea data-field="suggestion" placeholder="æ”¹å–„å»ºè­°"></textarea>
                </div>
                <div class="input-group">
                  <label>ä¾‹å­ï¼ˆæ¯è¡Œä¸€æ¢ï¼‰</label>
                  <textarea data-field="example" placeholder="å…·é«”ä¾‹å­ï¼Œç”¨ä»¥èªªæ˜è§€é»"></textarea>
                </div>
                <div class="input-group">
                  <label>ä¸‹æ‹‰é¸é …çš„æè¿°æ–‡å­—</label>
                  <textarea data-field="optionsLabel" placeholder="ä¾‹å¦‚ï¼šå›°é›£æƒ…ç¯€"></textarea>
                </div>
                <div class="input-group">
                  <label>ä¸‹æ‹‰é¸é … (æ¯è¡Œä¸€é …ï¼Œç•™ç©ºå‰‡ç„¡)</label>
                  <textarea data-field="options" placeholder="å¤©æ°£çªè®Š&#10;é«”åŠ›é€æ”¯&#10;å…¶ä»–"></textarea>
                </div>
              </div>

              <button class="action-btn" onclick="addNewCritique()">æ–°å¢é …ç›®</button>
            </div>
          </details>

          <p style="margin-top:1.5rem;">æ­¤é ç‚ºè©•èªåº«çš„ä¾†æºã€‚æ‚¨å¯åœ¨æ­¤è™•ç·¨è¼¯ã€æ–°å¢æˆ–åˆªé™¤è©•èªé …ç›®ã€‚æ‰€æœ‰ä¿®æ”¹å°‡è‡ªå‹•ä¿å­˜ã€‚</p>

          <details class="io-details">
            <summary><h3>è©•èªåº«ç®¡ç† (å°å…¥/å°å‡º)</h3></summary>
            <div class="io-details-content">
                <div class="btn-group">
                    <button class="action-btn" onclick="downloadCritiqueTemplate()">ä¸‹è¼‰ç¯„æœ¬(Excel)</button>
                    <button class="action-btn" onclick="exportCritiquesToExcel()">å°å‡ºè©•èªåº«(Excel)</button>
                    <label class="action-btn" for="import-critique-excel" style="cursor:pointer;">å°å…¥è©•èªåº«(Excel)</label>
                    <input type="file" id="import-critique-excel" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none;"/>
                </div>
                <div class="btn-group">
                    <button class="secondary-btn" onclick="exportCritiquesToJSON()">å°å‡ºè©•èªåº«(JSON)</button>
                    <label class="secondary-btn" for="import-critique-json" style="cursor:pointer;">å°å…¥è©•èªåº«(JSON)</label>
                    <input type="file" id="import-critique-json" accept=".json" style="display:none;"/>
                </div>
            </div>
          </details>

          <div class="btn-group" style="margin-top: 1.5rem; margin-bottom: 1rem;">
            <button class="light-btn" onclick="toggleAllDetails('overview-list', true)">å…¨éƒ¨å±•é–‹</button>
            <button class="light-btn brown" onclick="toggleAllDetails('overview-list', false)">å…¨éƒ¨æ”¶åˆ</button>
          </div>
          <div id="overview-list" class="overview-panel"></div>
        </div>
      </div>

      <!-- ==================== ç¬¬ä¸‰é ï¼šå­¸ç”Ÿç¸½è¦½ ==================== -->
      <div id="page3" class="page-content">
        <div class="overview-container">
          <div class="page-header">
            <h2>å­¸ç”Ÿè©•èªè¨˜éŒ„ç¸½è¦½</h2>
            <div class="btn-group">
              <button class="action-btn" onclick="exportOverviewToExcel()">ğŸ“Š åŒ¯å‡ºç‚º Excel</button>
              <button class="secondary-btn" onclick="exportOverviewToWord()">ğŸ“„ åŒ¯å‡ºå­¸ç”Ÿç‰ˆ Wordï¼ˆæ¯ä½å­¸ç”Ÿä¸€é ï¼‰</button>
              <!-- é€²åº¦åŒ¯å…¥åŒ¯å‡ºï¼ˆExcelï¼‰ -->
              <button class="light-btn brown" onclick="exportProgressToExcel()">ğŸ“Š åŒ¯å‡ºé€²åº¦</button>
              <label class="light-btn" for="import-progress-excel" style="cursor:pointer;">ğŸ“‚ åŒ¯å…¥é€²åº¦</label>
              <input type="file" id="import-progress-excel" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none;">
            </div>
          </div>
          <h3 id="overview-class-display"></h3>
          <div id="progress-tracker"></div>
          <div id="student-overview-table-wrapper">
              <table id="student-overview-table">
                  <thead>
                      <tr>
                          <th>å­¸è™Ÿ</th>
                          <th>å§“å</th>
                          <th>å…§å®¹</th>
                          <th>è¡¨é”</th>
                          <th>çµæ§‹</th>
                          <th>æ¨™é»</th>
                          <th>éŒ¯åˆ¥å­—</th>
                          <th>ç¸½åˆ†</th>
                          <th>å®Œæ•´ç‰ˆè©•èª</th>
                          <th>å­¸ç”Ÿç‰ˆè©•èª</th>
                      </tr>
                  </thead>
                  <tbody>
                      <!-- å­¸ç”Ÿè³‡æ–™å°‡ç”± JavaScript å‹•æ…‹å¡«å…¥ -->
                  </tbody>
              </table>
          </div>
        </div>
      </div>

      <!-- ==================== ç¬¬å››é ï¼šè©•èªåˆ†æ ==================== -->
      <div id="page4" class="page-content">
        <div class="overview-container">
          <div class="page-header">
            <h2>è©•èªåˆ†æï¼ˆå…¨ç­æ¦‚æ³ï¼‰</h2>
            <div class="btn-group">
              <button class="action-btn" onclick="exportAnalysisToExcel()">ğŸ“Š åŒ¯å‡ºåˆ†æ Excel</button>
              <button class="secondary-btn" onclick="exportAnalysisToWord()">ğŸ“„ åŒ¯å‡ºåˆ†æ Word</button>
            </div>
          </div>
          <p style="font-size:0.9rem;color:#777;">
            é€™ä¸€é æœƒæ ¹æ“šä½ å·²å„²å­˜çš„å­¸ç”Ÿè³‡æ–™ï¼Œè¨ˆç®—å¹³å‡åˆ†æ•¸åŠæœ€å¸¸è¦‹çš„è©•èªé …ç›®ï¼Œæ–¹ä¾¿ä½ è¨­è¨ˆé‡å°æ€§çš„è£œæ•‘æ•™å­¸æˆ–å»¶ä¼¸æ•™æã€‚
          </p>
          <div class="analysis-grid">
            <div class="analysis-card">
              <h3>åˆ†æ•¸æ¦‚è¦½ï¼ˆå¹³å‡å€¼ï¼‰</h3>
              <div id="analysis-score-summary"></div>
            </div>
            <div class="analysis-card">
              <h3>æœ€å¸¸è¦‹è©•èªé …ç›® TOP 10</h3>
              <div id="analysis-top-critique"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== ç¬¬äº”é ï¼šAI è©•èªåº«ç”Ÿæˆ ==================== -->
      <div id="page5" class="page-content">
        <div class="overview-container">
          <h2>AI è¼”åŠ©è©•èªåº«ç”Ÿæˆ</h2>
          <p style="font-size:0.9rem;color:#777;">
            æ­¤é é¢å¹«åŠ©æ‚¨ç”Ÿæˆä¸€æ®µå°ˆç‚º AI è¨­è¨ˆçš„æŒ‡ä»¤ (Prompt)ï¼Œç”¨ä»¥å¿«é€Ÿæ“´å……æ‚¨çš„å€‹äººè©•èªåº«ã€‚<br>
            è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š<br>
            1. æ–¼å·¦æ¬„å¡«å¯«ä½œæ–‡çš„ç›¸é—œè³‡è¨Šã€‚<br>
            2. æŒ‰ä¸‹ã€Œç”Ÿæˆ Prompt é è¦½ã€æŒ‰éˆ•ï¼Œä¸¦è¤‡è£½ç”Ÿæˆçš„æŒ‡ä»¤ã€‚<br>
            3. å°‡æŒ‡ä»¤è²¼åˆ° AI å°è©±æ¡†ä¸­ï¼Œç­‰å¾… AI å›è¦† JSON å…§å®¹ã€‚<br>
            4. å°‡ AI å›è¦†çš„å®Œæ•´ JSON å…§å®¹è²¼å›å³æ¬„çš„è¼¸å…¥æ¡†ä¸­ï¼Œä¸¦æŒ‰ä¸‹ã€Œæ‡‰ç”¨ JSONã€æŒ‰éˆ•ï¼Œå³å¯è‡ªå‹•æ›´æ–°æ‚¨çš„è©•èªåº«ã€‚
          </p>

          <div class="ai-page-grid">
            <div>
              <div class="section-box">
                <h3>æ­¥é©Ÿä¸€ï¼šè¨­å®šç”Ÿæˆæ¢ä»¶</h3>
                <div class="add-critique-grid">
                  <div class="input-group">
                    <label for="ai-student-level">å­¸ç”Ÿç´šåˆ¥</label>
                    <select id="ai-student-level">
                      <option value="junior">åˆç´šå­¸ç”Ÿï¼ˆä¸­ä¸€è‡³ä¸­ä¸‰ï¼‰</option>
                      <option value="intermediate" selected>ä¸­ç´šå­¸ç”Ÿï¼ˆä¸­å››è‡³ä¸­äº”ï¼‰</option>
                      <option value="advanced">é«˜ç´šå­¸ç”Ÿï¼ˆä¸­å…­ï¼‰</option>
                    </select>
                  </div>
                  <div class="input-group">
                    <label for="ai-topic">ä½œæ–‡é¡Œç›®</label>
                    <input type="text" id="ai-topic" placeholder="ä¾‹å¦‚ï¼šä¸€ä»¶ç™¼äººæ·±çœçš„äº‹">
                  </div>
                  <div class="input-group">
                    <label for="ai-focus">è©•èªé‡é»</label>
                    <select id="ai-focus">
                      <option value="balanced">å¹³è¡¡ (å„ªé»èˆ‡å¾…æ”¹é€²å¹³è¡¡)</option>
                      <option value="encourage">è‘—é‡é¼“å‹µ (è¼ƒå¤šå„ªé»)</option>
                      <option value="improve">è‘—é‡æé» (è¼ƒå¤šå¾…æ”¹é€²)</option>
                    </select>
                  </div>
                  <div class="input-group">
                    <label for="ai-excellent-count">å„ªé»è©•èªæ•¸é‡ (å¯é¸)</label>
                    <input type="number" id="ai-excellent-count" placeholder="ä¾‹å¦‚ï¼š5">
                  </div>
                  <div class="input-group">
                    <label for="ai-problem-count">å¾…æ”¹é€²è©•èªæ•¸é‡ (å¯é¸)</label>
                    <input type="number" id="ai-problem-count" placeholder="ä¾‹å¦‚ï¼š7">
                  </div>
                </div>
                <div class="input-group" style="margin-top: 1rem;">
                  <label for="ai-highlights">ç‰¹åˆ¥æƒ³ highlight çš„åœ°æ–¹ï¼ˆå¯é¸ï¼‰</label>
                  <textarea id="ai-highlights" rows="3" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•é‹ç”¨å°æ¯”æ‰‹æ³•ã€å¦‚ä½•æ·±åŒ–æ–‡ç« ä¸»æ—¨ã€æå¯«é»ƒæ˜çš„æ™¯è‰²ç­‰"></textarea>
                </div>
              </div>

              <div class="section-box">
                <h3>æ­¥é©ŸäºŒï¼šç”Ÿæˆä¸¦è¤‡è£½ Prompt</h3>
                <div class="btn-group" style="margin-bottom: 1rem;">
                  <button class="action-btn" onclick="generateAIPrompt()">ç”Ÿæˆ Prompt é è¦½</button>
                  <button class="secondary-btn" onclick="copyOutput('ai-prompt-preview', this)">è¤‡è£½ Prompt</button>
                </div>
                <textarea id="ai-prompt-preview" rows="15" readonly placeholder="é»æ“Šã€Œç”Ÿæˆ Prompt é è¦½ã€æŒ‰éˆ•å¾Œï¼Œæ­¤è™•æœƒé¡¯ç¤ºçµ¦ AI çš„å®Œæ•´æŒ‡ä»¤..."></textarea>
              </div>
            </div>
            <div>
              <div class="section-box">
                <h3>æ­¥é©Ÿä¸‰ï¼šè²¼ä¸Š AI å›æ‡‰ä¸¦æ›´æ–°è©•èªåº«</h3>
                <p>è«‹å°‡å¾ AI ç²å–çš„å®Œæ•´ JSON é™£åˆ—å…§å®¹ï¼ˆç”± `[` é–‹å§‹ï¼Œåˆ° `]` çµæŸï¼‰è²¼åˆ°ä¸‹æ–¹ã€‚</p>
                <textarea id="ai-json-input" rows="10" placeholder="[&#10;  {&#10;    &quot;id&quot;: &quot;...&quot;,&#10;    &quot;category&quot;: &quot;...&quot;,&#10;    ...&#10;  },&#10;  ...&#10;]"></textarea>
                <div class="btn-group" style="margin-top: 1rem;">
                  <button class="action-btn" onclick="applyAIJson()">æ‡‰ç”¨ JSON æ›´æ–°è©•èªåº«</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== ç¬¬å…­é ï¼šAI ç”Ÿæˆå›é¥‹ (æ–°ç‰ˆ) ==================== -->
      <div id="page6" class="page-content">
        <div class="overview-container">
          <h2>AI ç”Ÿæˆå›é¥‹æ–‡ä»¶</h2>
          <p style="font-size:0.9rem;color:#777;">
            æ­¤é é¢å¹«åŠ©æ‚¨åŸºæ–¼å…¨ç­çš„å¯«ä½œè¡¨ç¾ï¼Œç”Ÿæˆä¸€ä»½çµ¦äºˆè€å¸«åŠå­¸ç”Ÿçš„ç¶œåˆå›é¥‹æ–‡ä»¶ã€‚<br>
            è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š<br>
            1. åœ¨ä¸‹æ–¹é¸æ“‡ AI éœ€è¦åˆ†æçš„è³‡æ–™ï¼Œä»¥åŠå¸Œæœ›å®ƒç”¢å‡ºçš„å›é¥‹å…§å®¹ã€‚<br>
            2. ï¼ˆå¯é¸ä½†å»ºè­°ï¼‰åŒ¯å‡ºã€Œå…¨ç­è©•èª Excelã€ä¸¦ä¸Šå‚³çµ¦ AIã€‚<br>
            3. ç”Ÿæˆä¸¦è¤‡è£½ Promptï¼Œè²¼åˆ°æ‚¨çš„ AI å·¥å…·ä¸­ã€‚<br>
            4. å°‡ AI å›è¦†çš„ JSON å…§å®¹è²¼å›ä¸‹æ–¹ï¼Œä¸¦ç”Ÿæˆæœ€çµ‚çš„ Word æ–‡ä»¶ã€‚
          </p>

          <div class="section-box">
            <div class="ai-feedback-section-header">
              <h3>æ­¥é©Ÿä¸€ï¼šé¸æ“‡è®“ AI åƒè€ƒ/ç”¢å‡ºçš„å…§å®¹</h3>
              <span class="header-note">å‹¾å¾—è¶Šå¤šï¼Œprompt æœƒè¶Šé•·ï¼›å¯æŒ‰éœ€è¦é¸æ“‡</span>
            </div>
            
            <div class="two-column-grid" style="margin-top: 1.5rem; gap: 2.5rem;">
              <div>
                <div class="ai-feedback-section-header">
                  <h4>AI è®€å–çš„è³‡æ–™ä¾†æº</h4>
                  <span class="header-tag">ä¾› AI åˆ†æ</span>
                </div>
                <div id="ai-feedback-sources" class="checkbox-group" style="margin-top: 0.75rem;">
                  <label><input type="checkbox" id="ai-source-excel" checked> å…¨ç­è©•èª Excel (å„å­¸ç”Ÿåˆ†æ•¸ + å­¸ç”Ÿç‰ˆè©•èª)</label>
                  <label><input type="checkbox" id="ai-source-stats" checked> æœ¬ç³»çµ±è‡ªå‹•è¨ˆç®—çš„ã€Œåˆ†æ•¸æ¦‚è¦½+è©•èªTOP10ã€</label>
                  <label><input type="checkbox" id="ai-source-basic" checked> é¡Œç›®ã€å¹´ç´šã€ç­åˆ¥ç­‰åŸºæœ¬è³‡æ–™</label>
                </div>
                <p style="font-size:0.85rem; color:#888; margin-top:0.5rem;">å»ºè­°ï¼šè‡³å°‘ä¿ç•™ã€Œå…¨ç­è©•èª Excelã€åŠã€Œé¡Œç›®/ç´šåˆ¥ã€ï¼ŒAI æ‰èƒ½é‡å°ä½ çš„ç­å»åˆ†æã€‚</p>
              </div>
              <div>
                <div class="ai-feedback-section-header">
                  <h4>è«‹ AI ç”Ÿæˆçš„å›é¥‹æ¨¡çµ„</h4>
                  <span class="header-tag">AI å¿…é ˆè¼¸å‡ºçš„ JSON æ¬„ä½</span>
                </div>
                <div id="ai-feedback-modules" class="checkbox-group" style="margin-top: 0.75rem;">
                  <label><input type="checkbox" id="ai-module-overview" checked> ç¸½çµèˆ‡æ¦‚è¦½ (è€å¸«çš„è©±)</label>
                  <label><input type="checkbox" id="ai-module-topic" checked> å¯©é¡Œèˆ‡ç«‹æ„åˆ†æ</label>
                  <label><input type="checkbox" id="ai-module-material-theme" checked> é¸æç«‹æ„èˆ‰éš…</label>
                  <label><input type="checkbox" id="ai-module-excellent-students" checked> å„ªç§€åŒå­¸ç‰¹é» (å­¸ç”Ÿç‰ˆ)</label>
                  <label><input type="checkbox" id="ai-module-tiers" checked> åˆ†å±¤ä½œå“ç¤ºä¾‹èˆ‡è¬›è©•</label>
                  <label><input type="checkbox" id="ai-module-practice" checked> è·Ÿé€²ç·´ç¿’èˆ‡ç¤ºä¾‹</label>
                  <label><input type="checkbox" id="ai-module-plan" checked> æ•™å­¸è¨ˆåŠƒèˆ‡å»ºè­° (åƒ…è€å¸«ç‰ˆ)</label>
                </div>
              </div>
            </div>

            <div class="input-group" style="margin-top: 2rem;">
              <label for="ai-feedback-extra-hints">é¡å¤–æç¤º (å¯é¸)</label>
              <textarea id="ai-feedback-extra-hints" rows="3" placeholder="ä¾‹å¦‚ï¼šé€™ç­åŒå­¸æ™®éæ¬ è‡ªä¿¡ï¼Œå¸Œæœ›èªæ°£æº«å’Œï¼›ä¸Šå“ä½œå“å¯å¤šä¸€äº›æå¯«ç´°ç¯€ï¼›çŸ­å¯«ç·´ç¿’åªè¦ 80-100 å­—ç­‰"></textarea>
            </div>
          </div>

          <div class="section-box">
            <h3>æ­¥é©ŸäºŒï¼šç”¢å‡ºçµ¦ AI çš„è³‡æ–™èˆ‡ Prompt</h3>
            <div style="margin-top: 1.5rem;">
              <h4 style="font-size: 1.1rem;">1. åŒ¯å‡ºã€Œå…¨ç­è©•èª Excelã€ä¾› AI ä¸‹è¼‰é–±è®€</h4>
              <div class="btn-group">
                <button class="action-btn" onclick="exportStudentDataForAI()">ğŸ“Š åŒ¯å‡ºå­¸ç”Ÿè©•èª Excel</button>
              </div>
              <p style="font-size:0.85rem; color:#888; margin-top:0.5rem;">åŒ¯å‡ºå¾Œï¼Œå¯å°‡ Excel ä¸Šå‚³åˆ° AI (è‹¥å¹³å°æ”¯æ´)ï¼Œæˆ–è¤‡è£½éƒ¨åˆ†å…§å®¹è²¼çµ¦å°è©±æ¡†ã€‚</p>
            </div>
            <div style="margin-top: 2rem;">
              <h4 style="font-size: 1.1rem;">2. ç”Ÿæˆçµ¦ AI çš„ Prompt (æ–‡å­—æŒ‡ä»¤)</h4>
              <div class="btn-group" style="margin-bottom: 1rem;">
                <button class="action-btn" onclick="generateFeedbackPromptV2()">ç”Ÿæˆå›é¥‹ Prompt</button>
                <button class="secondary-btn" onclick="copyOutput('ai-feedback-prompt-preview', this)">è¤‡è£½ Prompt</button>
              </div>
              <textarea id="ai-feedback-prompt-preview" rows="15" readonly placeholder="é»æ“Šã€Œç”Ÿæˆå›é¥‹ Promptã€æŒ‰éˆ•å¾Œï¼Œé€™è£æœƒé¡¯ç¤ºçµ¦ AI çš„å®Œæ•´æŒ‡ä»¤..."></textarea>
            </div>
          </div>

          <div class="section-box">
            <h3>æ­¥é©Ÿä¸‰ï¼šè²¼ä¸Š AI å›æ‡‰ä¸¦ç”Ÿæˆ Word æ–‡ä»¶</h3>
            <p>è«‹å°‡å¾ AI ç²å–çš„å®Œæ•´ JSON ç‰©ä»¶å…§å®¹ï¼ˆç”± `{` é–‹å§‹ï¼Œåˆ° `}` çµæŸï¼‰è²¼åˆ°ä¸‹æ–¹ã€‚æ­¤ JSON å°‡ç”¨æ–¼ç”Ÿæˆä¸‹æ–¹å…©å€‹ç‰ˆæœ¬çš„ Word æ–‡ä»¶ã€‚</p>
            <textarea id="ai-feedback-json-input" rows="10" placeholder="{&#10;  &quot;classOverview&quot;: { ... },&#10;  &quot;topicAnalysis&quot;: { ... },&#10;  ...&#10;}"></textarea>
            <div class="btn-group" style="margin-top: 1rem;">
              <button class="action-btn" onclick="generateTeacherWord()">ğŸ“„ ç”Ÿæˆä¸¦åŒ¯å‡º Word (è€å¸«ç‰ˆ)</button>
              <button class="secondary-btn" onclick="generateStudentWord()">ğŸ“„ ç”Ÿæˆä¸¦åŒ¯å‡º Word (å­¸ç”Ÿç‰ˆ)</button>
            </div>
          </div>

        </div>
      </div>

    </main>
  </div>

  <!-- Floating Navigation -->
  <nav id="floating-nav">
    <a href="#step-2-section" title="è·³è½‰åˆ°é¸æ“‡å­¸ç”Ÿ">ç”Ÿ</a>
    <a href="#step-3-section" title="è·³è½‰åˆ°ä½œæ–‡è©•åˆ†">åˆ†</a>
    <a href="#step-3-1-section" title="è·³è½‰åˆ°éŒ¯åˆ¥å­—">å­—</a>
    <a href="#step-4-section" title="è·³è½‰åˆ°è©•èªé …ç›®">è©•</a>
  </nav>

  <!-- è‡ªè£½ç¢ºèªå°è©±æ¡† -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-title" id="modal-title">è«‹ç¢ºèª</div>
      <div id="modal-text" style="white-space: pre-wrap;">è³‡æ–™å°šæœªåŒ¯å‡ºï¼Œé—œé–‰é é¢å°‡æœƒéºå¤±æ‰€æœ‰é€²åº¦ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="modal-cancel">å–æ¶ˆ</button>
        <button class="btn btn-danger" id="modal-ok">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- è©•èªè³‡æ–™ä¾†æº -->
  <div id="critique-data" style="display:none;">
    <div data-id="c1" data-category="æ‰£é¡Œèˆ‡ç«‹æ„" data-type="excellent" data-strength-summary="èƒ½ç·Šæ‰£é¡Œç›®è¦æ±‚ï¼Œç«‹æ„æ˜ç¢ºï¼Œä¸­å¿ƒæ€æƒ³æ¸…æ™°ã€‚" data-example="æ–‡ç« é¡Œç‚ºã€Œä¸€æ¬¡é›£å¿˜çš„ç¶“æ­·ã€ï¼Œå…§æ–‡ç¢ºå¯¦åœç¹è©²æ¬¡ç¶“æ­·çš„å§‹æœ«èˆ‡æ„Ÿå—æå¯«ï¼Œæ²’æœ‰é›¢é¡Œã€‚"><h4>æ‰£é¡Œæº–ç¢ºï¼Œç«‹æ„æ˜ç¢º</h4></div>
    <div data-id="c2" data-category="æ‰£é¡Œèˆ‡ç«‹æ„" data-type="problem" data-problem-core="ç«‹æ„ä¸å¤ æ·±åˆ»ï¼Œæœªèƒ½å¾äº‹ä»¶ä¸­æç…‰å‡ºæ›´æ·±å±¤çš„æ„ç¾©ã€‚" data-suggestion="å¯æ€è€ƒäº‹ä»¶èƒŒå¾Œå¸¶ä¾†çš„åæ€æˆ–å•Ÿç™¼ï¼Œæ·±åŒ–ä¸»é¡Œã€‚" data-example="åªåœç•™åœ¨ã€Œè¨˜ä¸€æ¬¡æ„‰å¿«çš„æ—…è¡Œã€ï¼Œæœªæ˜‡è¯è‡³ã€Œæ—…è¡Œçš„æ„ç¾©ã€æˆ–ã€Œå€‹äººæˆé•·ã€ç­‰å±¤é¢ã€‚"><h4>ç«‹æ„è†šæ·º</h4></div>
    <div data-id="c3" data-category="å–æèˆ‡åˆ»ç•«" data-type="excellent" data-strength-summary="é¸æå…¸å‹ï¼Œèƒ½æœ‰æ•ˆè¡¨ç¾ä¸­å¿ƒæ€æƒ³ã€‚" data-example="ç‚ºè¡¨ç¾æ¯è¦ªçš„é—œæ„›ï¼Œé¸å–äº†ã€Œç—…ä¸­ç…§é¡§ã€å’Œã€Œé›¨ä¸­é€å‚˜ã€å…©å€‹ç¶“å…¸äº‹ä¾‹ï¼Œå…·ä»£è¡¨æ€§ã€‚"><h4>é¸æå…¸å‹</h4></div>
    <div data-id="c4" data-category="å–æèˆ‡åˆ»ç•«" data-type="excellent" data-strength-summary="å–„ç”¨å¤šç¨®æå¯«æ‰‹æ³•ï¼Œä½¿[é¸é …]å½¢è±¡æ›´è¦‹çªå‡ºã€‚" data-options="äººç‰©&#10;æ™¯ç‰©" data-options-label="æå¯«å°è±¡" data-example="é‹ç”¨äº†å¤–è²Œã€å‹•ä½œå’Œèªè¨€æå¯«ï¼ŒæŠŠè€å¸«çš„åš´å²èˆ‡æ…ˆæ„›åˆ»ç•«å¾—æ·‹æ¼“ç›¡-è‡´ã€‚"><h4>æå¯«ç´°ç·»ï¼Œå½¢è±¡é®®æ˜</h4></div>
    <div data-id="c5" data-category="å–æèˆ‡åˆ»ç•«" data-type="problem" data-problem-core="å–æä¸ç•¶ï¼Œæ‰€é¸ææ–™æœªèƒ½æœ‰åŠ›åœ°æ”¯æŒä¸­å¿ƒæ€æƒ³ã€‚" data-suggestion="æ‡‰åœç¹ä¸­å¿ƒæ€æƒ³ç¯©é¸ææ–™ï¼Œåˆªå»ç„¡é—œç·Šè¦çš„æç¯€ã€‚" data-example="æ–‡ç« ä¸»æ—¨æ˜¯ã€Œå‹¤å¥®ã€ï¼Œä½†èŠ±è²»å¤§é‡ç¯‡å¹…æå¯«å…¬åœ’çš„æ™¯è‰²ï¼Œå–§è³“å¥ªä¸»ã€‚"><h4>å–æä¸ç•¶</h4></div>
    <div data-id="c6" data-category="å–æèˆ‡åˆ»ç•«" data-type="problem" data-problem-core="æå¯«æµæ–¼è¡¨é¢ï¼Œæœªèƒ½æ·±å…¥åˆ»ç•«[é¸é …]çš„ç‰¹é»ã€‚" data-suggestion="å¯å˜—è©¦é‹ç”¨æ¯”å–»ã€æ“¬äººç­‰ä¿®è¾­ï¼Œæˆ–å¾å¤šè§’åº¦ï¼ˆå¦‚è¦–è¦ºã€è½è¦ºã€å—…è¦ºï¼‰é€²è¡Œæå¯«ã€‚" data-options="äººç‰©&#10;æ™¯ç‰©" data-options-label="æå¯«å°è±¡" data-example="å¯«è²“åªå¯«ã€Œå¾ˆå¯æ„›ã€ï¼Œæœªæœ‰å…·é«”æå¯«å…¶æ¯›è‰²ã€çœ¼ç¥æˆ–å‹•æ…‹ã€‚"><h4>æå¯«ç©ºæ³›</h4></div>
    <div data-id="c7" data-category="çµæ§‹èˆ‡é‹ªæ’" data-type="excellent" data-strength-summary="çµæ§‹åš´è¬¹ï¼Œå±¤æ¬¡åˆ†æ˜ï¼Œæ®µè½ä¹‹é–“éæ¸¡è‡ªç„¶ã€‚" data-example="ä»¥æ™‚é–“ç‚ºåºï¼Œå¾æ—©ä¸Šåˆ°æ™šä¸Šï¼Œæ¢ç†æ¸…æ™°ã€‚"><h4>çµæ§‹åš´è¬¹</h4></div>
    <div data-id="c8" data-category="çµæ§‹èˆ‡é‹ªæ’" data-type="excellent" data-strength-summary="å–„æ–¼é‹ç”¨[é¸é …]çš„å¯«ä½œé †åºï¼Œä½¿æ–‡ç« è„ˆçµ¡æ¸…æ™°ã€‚" data-options="é †æ•˜&#10;å€’æ•˜&#10;æ’æ•˜" data-options-label="æ•˜äº‹æ‰‹æ³•" data-example="é–‹é¦–å³é»æ˜ç»“å±€ï¼Œå†ç”¨å€’æ•˜æ³•å¨“å¨“é“ä¾†ï¼Œå¼•äººå…¥å‹ã€‚"><h4>æ•˜äº‹æœ‰åº</h4></div>
    <div data-id="c9" data-category="çµæ§‹èˆ‡é‹ªæ’" data-type="problem" data-problem-core="çµæ§‹é¬†æ•£ï¼Œæ®µè½é–“ç¼ºä¹é€£è²«æ€§ã€‚" data-suggestion="å¯å¤šç”¨éæ¸¡å¥æˆ–é—œè¯è©ï¼Œæˆ–æŒ‰ä¸€å®šé †åºï¼ˆå¦‚æ™‚é–“ã€ç©ºé–“ï¼‰é‡æ–°çµ„ç¹”æ®µè½ã€‚" data-example="ä¸Šä¸€æ®µå¯«å­¸æ ¡ç”Ÿæ´»ï¼Œä¸‹ä¸€æ®µçªç„¶è·³åˆ°å®¶åº­ç‘£äº‹ï¼Œç¼ºä¹éæ¸¡ã€‚"><h4>çµæ§‹é¬†æ•£</h4></div>
    <div data-id="c10" data-category="çµæ§‹èˆ‡é‹ªæ’" data-type="problem" data-problem-core="æ–‡ç« åœ¨ç”±é€åˆ¥ç¾å ´éæ¸¡è‡³ã€Œå›æ†¶ç‰‡æ®µã€çš„æ®µè½æ™‚ï¼Œæƒ…æ„Ÿè½‰æŠ˜éå¿«ï¼Œç¼ºä¹é‹ªå¢Šã€‚" data-suggestion="å¯åŠ ä¸Šä¸€å…©å¥å…§å¿ƒéæ¸¡å¥ï¼Œè®“æƒ…æ„Ÿé€£æ¥æ›´é †æš¢ã€‚" data-example="å¯«å®Œé“åˆ¥å ´é¢å¾Œï¼Œå¯åŠ ä¸€å¥ã€Œé‚£å¤©ä¹‹å¾Œï¼Œæˆ‘å¸¸æƒ³èµ·æˆ‘å€‘ä¸€èµ·æ”¾å­¸çš„åˆå¾Œã€ï¼Œè‡ªç„¶å¼•å‡ºå›æ†¶ã€‚"><h4>ç¯‡ç« è½‰æŠ˜ç•¥æ„Ÿçªå…€</h4></div>
    <div data-id="c11" data-category="èªè¨€èˆ‡è¡¨é”" data-type="excellent" data-strength-summary="èªè¨€æµæš¢ï¼Œè¡¨é”æº–ç¢ºï¼Œè©å½™è±å¯Œã€‚" data-example="ç”¨è©ç²¾ç…‰ï¼Œæ²’æœ‰è´…è¨€ã€‚"><h4>èªè¨€æµæš¢</h4></div>
    <div data-id="c12" data-category="èªè¨€èˆ‡è¡¨é”" data-type="excellent" data-strength-summary="å–„æ–¼é‹ç”¨[é¸é …]ç­‰ä¿®è¾­æ‰‹æ³•ï¼Œä½¿èªè¨€æ›´ç”Ÿå‹•å½¢è±¡ã€‚" data-options="æ¯”å–»&#10;æ“¬äºº&#10;æ’æ¯”&#10;èª‡å¼µ" data-options-label="ä¿®è¾­æ‰‹æ³•" data-example="ã€Œå¤ªé™½åƒå€‹å¤§ç«çƒã€ï¼Œæ¯”å–»è²¼åˆ‡ã€‚"><h4>å–„ç”¨ä¿®è¾­</h4></div>
    <div data-id="c13" data-category="èªè¨€èˆ‡è¡¨é”" data-type="problem" data-problem-core="èªè¨€æ¬ é€šé †ï¼Œæœ‰ç—…å¥ï¼Œå½±éŸ¿æ–‡æ„è¡¨é”ã€‚" data-suggestion="å¯«ä½œå¾Œå®œå¤šè®€å¹¾éï¼Œæª¢æŸ¥ä¸¦ä¿®æ­£èªå¥ä¸é€šé †ä¹‹è™•ã€‚" data-example="ã€Œæˆ‘çš„å¿ƒæƒ…ååˆ†é«˜èˆˆã€‚ã€ï¼ˆã€Œå¿ƒæƒ…ã€èˆ‡ã€Œé«˜èˆˆã€æ­é…ä¸ç•¶ï¼‰"><h4>èªå¥ä¸é€š</h4></div>
    <div data-id="c14" data-category="èªè¨€èˆ‡è¡¨é”" data-type="problem" data-problem-core="è©å½™è²§ä¹ï¼Œç”¨è©é‡è¤‡å–®èª¿ã€‚" data-suggestion="å¯å¤šç©ç´¯åŒç¾©è©ã€è¿‘ç¾©è©ï¼Œä¸¦åœ¨å¯«ä½œä¸­å˜—è©¦æ›¿æ›ä½¿ç”¨ã€‚" data-example="å…¨æ–‡å¤šæ¬¡ä½¿ç”¨ã€Œé–‹å¿ƒã€ï¼Œå¯ç”¨ã€Œæ„‰å¿«ã€ã€ã€Œèˆˆå¥®ã€ã€ã€Œé›€èºã€ç­‰è©ä»£æ›¿ã€‚"><h4>ç”¨è©å–®èª¿</h4></div>
    <div data-id="c15" data-category="èªè¨€èˆ‡è¡¨é”" data-type="problem" data-problem-core="éŒ¯åˆ¥å­—è¼ƒå¤šï¼Œæ¨™é»ç¬¦è™Ÿé‹ç”¨ä¸ç•¶ã€‚" data-suggestion="éœ€åŠ å¼·å°å­—è©çš„æŒæ¡ï¼Œä¸¦æ³¨æ„æ¨™é»ç¬¦è™Ÿçš„æ­£ç¢ºç”¨æ³•ã€‚" data-example="ã€Œçš„ã€åœ°ã€å¾—ã€ä¸åˆ†ï¼›ä¸€å¥è©±çµå°¾æ²’æœ‰å¥è™Ÿã€‚"><h4>å­—è©æ¨™é»éŒ¯èª¤</h4></div>
  </div>

<script>
let allStudentRecords = [];

document.addEventListener('DOMContentLoaded', () => {
  showWelcomeMessage(); 
  loadFontSize();
  loadCommonTypos();
  buildChecklist();
  buildOverviewPage();
  attachGlobalListeners();
  updateStudentDropdown(); 
  updateAllOutputs();
});

// Welcome message
function showWelcomeMessage() {
    confirmUI('åˆæœ‰å°å¯æ„›åœ¨ç­‰æ‚¨ç¿»ç‰Œäº†ï¼', null, 'æº«é¦¨æç¤º');
}

// Before-leave confirmation
window.addEventListener('beforeunload', (event) => {
    // æª¢æŸ¥æ˜¯å¦æœ‰å·²å„²å­˜çš„å­¸ç”Ÿè³‡æ–™
    const hasData = allStudentRecords.some(r => r.data);
    if (hasData) {
        const confirmationMessage = 'è³‡æ–™å°šæœªåŒ¯å‡ºï¼Œé—œé–‰é é¢å°‡æœƒéºå¤±æ‰€æœ‰é€²åº¦ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
        event.preventDefault(); // éµå¾ªè¦ç¯„
        event.returnValue = confirmationMessage; // å°æ–¼èˆŠç‰ˆç€è¦½å™¨
        return confirmationMessage; // å°æ–¼ç¾ä»£ç€è¦½å™¨
    }
});


/* ====== å°å‹ Confirm UI ====== */
const modal = {
  el: null, okBtn: null, cancelBtn: null, textEl: null, titleEl: null, resolve: null,
  init() {
    this.el = document.getElementById('modal');
    this.okBtn = document.getElementById('modal-ok');
    this.cancelBtn = document.getElementById('modal-cancel');
    this.textEl = document.getElementById('modal-text');
    this.titleEl = document.getElementById('modal-title');
    this.okBtn.addEventListener('click', ()=>{ this.hide(); if (this.resolve) this.resolve(true); });
    this.cancelBtn.addEventListener('click', ()=>{ this.hide(); if (this.resolve) this.resolve(false); });
    this.el.addEventListener('click', (e)=>{ if (e.target===this.el) { this.hide(); if (this.resolve) this.resolve(false); }});
  },
  show(message, title = 'è«‹ç¢ºèª') {
    if (!this.el) this.init();
    this.textEl.textContent = message || 'è«‹ç¢ºèª';
    this.titleEl.textContent = title;
    this.el.classList.add('active');
    this.el.setAttribute('aria-hidden', 'false');
    return new Promise(res => { this.resolve = res; });
  },
  hide() {
    this.el.classList.remove('active');
    this.el.setAttribute('aria-hidden', 'true');
  }
};
function confirmUI(message, onOk, title) {
  modal.show(message, title).then(ok => { if (ok && typeof onOk === 'function') onOk(); });
}

/* ====== å­—é«”å¤§å°èª¿æ•´åŠŸèƒ½ ====== */
const FONT_SCALE_KEY = 'globalFontScale';
const FONT_SCALE_STEP = 0.05;
const MIN_FONT_SCALE = 0.8;
const MAX_FONT_SCALE = 1.3;
const DEFAULT_FONT_SCALE = 1.0;

function adjustFontSize(direction) {
    const root = document.documentElement;
    let currentScale = parseFloat(root.style.getPropertyValue('--font-scale') || DEFAULT_FONT_SCALE);

    if (direction === 'increase') {
        currentScale = Math.min(MAX_FONT_SCALE, currentScale + FONT_SCALE_STEP);
    } else if (direction === 'decrease') {
        currentScale = Math.max(MIN_FONT_SCALE, currentScale - FONT_SCALE_STEP);
    } else {
        currentScale = DEFAULT_FONT_SCALE;
    }
    
    root.style.setProperty('--font-scale', currentScale);
    root.style.fontSize = `calc(16px * ${currentScale})`;
    saveFontSize(currentScale);
}

function saveFontSize(scale) {
    try {
        localStorage.setItem(FONT_SCALE_KEY, scale);
    } catch (e) {
        console.warn("ç„¡æ³•å„²å­˜å­—é«”å¤§å°è¨­å®šåˆ° localStorage:", e);
    }
}

function loadFontSize() {
    try {
        const savedScale = localStorage.getItem(FONT_SCALE_KEY);
        const scale = parseFloat(savedScale) || DEFAULT_FONT_SCALE;
        const root = document.documentElement;
        root.style.setProperty('--font-scale', scale);
        root.style.fontSize = `calc(16px * ${scale})`;
    } catch (e) {
        console.warn("ç„¡æ³•å¾ localStorage è®€å–å­—é«”å¤§å°è¨­å®š:", e);
    }
}

/* ---------------- é é¢åˆ‡æ›èˆ‡é€šç”¨åŠŸèƒ½ ---------------- */
const CATEGORIES = { "æ‰£é¡Œèˆ‡ç«‹æ„": [], "å–æèˆ‡åˆ»ç•«": [], "çµæ§‹èˆ‡é‹ªæ’": [], "èªè¨€èˆ‡è¡¨é”": [] };

let currentTypos = [];
let commonTypos = [];

function showPage(pageId) {
  document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(n => n.classList.remove('active'));
  document.getElementById('nav-' + pageId).classList.add('active');

  const floatingNav = document.getElementById('floating-nav');
  if (floatingNav) {
    floatingNav.style.display = (pageId === 'page1') ? 'flex' : 'none';
  }

  if (pageId === 'page2') {
    buildOverviewPage();
  } else if (pageId === 'page3') {
    renderStudentOverviewTable(); 
  } else if (pageId === 'page4') {
    renderAnalysisPage();
  } else if (pageId === 'page6') {
    const records = allStudentRecords.filter(r => r.data);
    if (records.length === 0) {
      document.getElementById('ai-feedback-prompt-preview').placeholder = "è«‹å…ˆåœ¨ã€Œå­¸ç”Ÿç¸½è¦½ã€é é¢å„²å­˜è‡³å°‘ä¸€ä½å­¸ç”Ÿçš„è©•èªæ•¸æ“šï¼Œæ‰èƒ½ç”Ÿæˆåˆ†æèˆ‡ Promptã€‚";
    } else {
      document.getElementById('ai-feedback-prompt-preview').placeholder = "é»æ“Šã€Œç”Ÿæˆå›é¥‹ Promptã€æŒ‰éˆ•å¾Œï¼Œé€™è£æœƒé¡¯ç¤ºçµ¦ AI çš„å®Œæ•´æŒ‡ä»¤...";
    }
  }
}

function toggleAllDetails(containerId, openState) {
  const container = document.getElementById(containerId);
  if (container) {
    container.querySelectorAll('details').forEach(detail => {
      detail.open = openState;
    });
  }
}

/* ---------------- ç¬¬ä¸€é ï¼šè©•èªç”Ÿæˆå™¨ ---------------- */

function buildChecklist() {
  const dataContainer = document.getElementById('critique-data');
  const checklistContainer = document.getElementById('checklist-container');

  const checkedStates = {};
  const editedTexts = {};
  document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(cb => {
    checkedStates[cb.id] = cb.checked;
    if (cb.checked) {
      const textarea = document.getElementById(`text-${cb.id}`);
      if (textarea) editedTexts[cb.id] = textarea.value;
    }
  });

  checklistContainer.innerHTML = '';
  const tempCategories = {};

  dataContainer.querySelectorAll('div[data-id]').forEach(el => {
    const category = el.dataset.category || "æœªåˆ†é¡";
    if (!tempCategories[category]) {
      tempCategories[category] = []; 
    }
    tempCategories[category].push(el);
  });

  let hasContent = false;
  for (const categoryName in tempCategories) {
    if (tempCategories[categoryName].length === 0) continue;
    hasContent = true;
    const details = document.createElement('details');
    details.innerHTML = `<summary>${categoryName}</summary>`;
    const itemsContainer = document.createElement('div');
    itemsContainer.className = 'critique-items-container';

    tempCategories[categoryName].forEach(critiqueEl => {
      const id = critiqueEl.dataset.id;
      const type = critiqueEl.dataset.type;
      const title = getCritiqueData(id, 'title');
      const hasOptions = (critiqueEl.dataset.options || '').trim() !== '';

      const itemDiv = document.createElement('div');
      itemDiv.className = `check-item ${type === 'problem' ? 'is-problem' : 'is-excellent'}`;

      const headerDiv = document.createElement('div');
      headerDiv.className = 'check-item-header';
      headerDiv.innerHTML = `<input type="checkbox" id="${id}"><label for="${id}">${title}</label>`;
      itemDiv.appendChild(headerDiv);

      if (hasOptions) itemDiv.appendChild(createInteractiveModule(id));

      const editableCommentDiv = document.createElement('div');
      editableCommentDiv.className = 'editable-comment';
      editableCommentDiv.innerHTML = `<textarea id="text-${id}" placeholder="æ­¤è™•é¡¯ç¤ºå­¸ç”Ÿç‰ˆé è¦½ï¼ˆå·²ç´°åŒ–ä¾‹å­ï¼‰â€¦"></textarea>`;
      itemDiv.appendChild(editableCommentDiv);

      itemsContainer.appendChild(itemDiv);

      const checkbox = document.getElementById(id);
      if (checkedStates[id]) {
        checkbox.checked = true;
        handleCheckboxChange(checkbox, false);
        const textarea = document.getElementById(`text-${id}`);
        if (textarea && editedTexts[id]) textarea.value = editedTexts[id];
      }
    });

    details.appendChild(itemsContainer);
    checklistContainer.appendChild(details);
  }

  if (!hasContent) {
    checklistContainer.innerHTML = `<div class="empty-state-message" style="grid-column: 1 / -1;">è©•èªåº«ç›®å‰ç‚ºç©ºã€‚<br>è«‹å‰å¾€ã€Œè©•èªç¸½è¦½èˆ‡ä¿®è¨‚ã€åˆ†é æ–°å¢æˆ–å°å…¥è©•èªé …ç›®ã€‚</div>`;
  }
}

function createInteractiveModule(id) {
  const moduleDiv = document.createElement('div');
  moduleDiv.id = `module-${id}`;
  moduleDiv.className = 'interactive-module';
  
  const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
  const options = getCritiqueOptions(id) || [];
  const labelText = critiqueEl.dataset.optionsLabel || 'è«‹é¸æ“‡ï¼š';

  function ensureOther(list) {
    return list.includes('å…¶ä»–') ? list : [...list, 'å…¶ä»–'];
  }
  
  const list = ensureOther(options);
  
  const content = `<div class="module-row"><label>${labelText}</label>
    <select id="${id}-select"><option value=""></option>${list.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>
  </div>
  <div class="module-row other-input" id="${id}-other" style="display:none;"><input type="text" id="${id}-other-text" placeholder="è«‹è¼¸å…¥å…¶ä»–å…§å®¹"></div>`;

  moduleDiv.innerHTML = content;
  return moduleDiv;
}

function getCritiqueOptions(id) {
  const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
  const raw = el?.dataset.options || '';
  if (!raw) return null;
  return raw.split('\n').map(s=>s.trim()).filter(Boolean);
}

function populateEditableTextarea(id) {
  const textarea = document.getElementById(`text-${id}`);
  if (!textarea) return;
  textarea.value = composeStudentFromConcise(id);
}

function concretizeExample(id, rawExample) {
  const trimmed = (rawExample || '').trim();
  if (!trimmed) {
    const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (critiqueEl) {
        const pTags = critiqueEl.querySelectorAll('p');
        if (pTags.length > 0) {
            return Array.from(pTags).map(p => p.textContent.trim()).filter(Boolean).slice(0, 2);
        }
    }
    return [];
  }
  let lines = trimmed.split('\n').map(s=>s.trim()).filter(Boolean);
  return lines.slice(0, 2);
}

function parseStudentName(rawName) {
    const match = rawName.trim().match(/^(\d+)[-\s._]*(.*)$/);
    if (match) {
        return {
            number: parseInt(match[1], 10),
            name: match[2].trim(),
            originalName: rawName.trim()
        };
    }
    return {
        number: null,
        name: rawName.trim(),
        originalName: rawName.trim()
    };
}

function updateStudentDropdown() {
  const namesText = document.getElementById('student-names').value;
  const studentSelect = document.getElementById('student-select');
  const parsedNames = namesText.split('\n').map(name => parseStudentName(name)).filter(p => p.name);

  const oldRecords = [...allStudentRecords];
  allStudentRecords = parsedNames.map(p => {
    const existingRecord = oldRecords.find(r => r.originalName === p.originalName);
    return existingRecord || { ...p, data: null };
  });

  const currentSelected = studentSelect.value;
  studentSelect.innerHTML = parsedNames.length === 0 ? '<option value="">è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥å­¸ç”Ÿåå–®</option>' : '';
  
  let newSelectionExists = false;
  parsedNames.forEach(p => {
    const option = document.createElement('option');
    option.value = p.originalName;
    option.textContent = p.originalName;
    studentSelect.appendChild(option);
    if (p.originalName === currentSelected) {
        newSelectionExists = true;
    }
  });

  if (newSelectionExists) {
      studentSelect.value = currentSelected;
  }
  
  updateAllOutputs();
  renderStudentOverviewTable();
}

function attachGlobalListeners() {
  document.getElementById('student-names').addEventListener('input', updateStudentDropdown);

  document.getElementById('student-select').addEventListener('change', (e) => {
    loadStudentData(e.target.value);
  });

  document.body.addEventListener('input', (e) => {
    if (e.target.matches('#page1 input, #page1 textarea, #page1 select')) {
      if (e.target.closest('.interactive-module')) {
        const checkItem = e.target.closest('.check-item');
        if (checkItem) {
          const checkbox = checkItem.querySelector('input[type="checkbox"]');
          if (checkbox && checkbox.checked) populateEditableTextarea(checkbox.id);
        }
      }
      if (e.target.closest('.score-layout-grid')) calculateTotalScore();
      updateAllOutputs();
    }
  });

  document.body.addEventListener('change', (e) => {
    if (e.target.type === 'checkbox' && e.target.closest('#checklist-container')) {
      handleCheckboxChange(e.target);
    }
    if (e.target.tagName === 'SELECT' && e.target.closest('.interactive-module')) {
      const idPrefix = e.target.id.replace('-select', '');
      toggleOtherBlock(idPrefix, e.target.value);

      const checkItem = e.target.closest('.check-item');
      if (checkItem) {
        const cb = checkItem.querySelector('input[type="checkbox"]');
        if (cb && cb.checked) populateEditableTextarea(cb.id);
      }
      updateAllOutputs();
    }
  });

  const floatingNav = document.getElementById('floating-nav');
  if (floatingNav) {
    floatingNav.addEventListener('click', (event) => {
      const link = event.target.closest('a');
      if (link) {
        event.preventDefault();
        const targetId = link.getAttribute('href');
        const targetElement = document.querySelector(targetId);
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }
    });
  }

  const topicInput = document.getElementById('topic');
  const aiTopicInput = document.getElementById('ai-topic');
  topicInput.addEventListener('input', () => {
      if (aiTopicInput.value !== topicInput.value) {
          aiTopicInput.value = topicInput.value;
      }
  });
  aiTopicInput.addEventListener('input', () => {
      if (topicInput.value !== aiTopicInput.value) {
          topicInput.value = aiTopicInput.value;
      }
  });

  document.getElementById('import-common-excel').addEventListener('change', handleTypoImportExcel);
  document.getElementById('import-common-json').addEventListener('change', handleTypoImportJSON);
  document.getElementById('import-student-list').addEventListener('change', handleStudentListImport);
  document.getElementById('import-progress-excel').addEventListener('change', handleProgressImportExcel);
  
  bindOverviewEvents();

  ['full-output','student-report-output'].forEach(id=>{
    const ta = document.getElementById(id);
    ta?.addEventListener('focus', ()=> { ta.dataset.userEditing = '1'; });
    ta?.addEventListener('blur', ()=> { delete ta.dataset.userEditing; updateAllOutputs(); });
  });

  const scoreInputOrder = ['score-content', 'score-expression', 'score-structure', 'score-punctuation', 'score-typos'];
  scoreInputOrder.forEach(id => {
      const input = document.getElementById(id);
      if (input) {
          input.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                  e.preventDefault();
                  const currentIndex = scoreInputOrder.indexOf(id);
                  if (currentIndex > -1 && currentIndex < scoreInputOrder.length - 1) {
                      document.getElementById(scoreInputOrder[currentIndex + 1]).focus();
                  }
              }
          });
      }
  });
}

function toggleOtherBlock(idPrefix, value) {
  const block = document.getElementById(`${idPrefix}-other`);
  if (!block) return;
  block.style.display = (value === 'å…¶ä»–' || value === 'other') ? 'flex' : 'none';
  if (value !== 'å…¶ä»–' && value !== 'other') {
    const input = document.getElementById(`${idPrefix}-other-text`);
    if (input) input.value = '';
  }
}

function calculateTotalScore() {
  const content = parseFloat(document.getElementById('score-content').value) || 0;
  const expression = parseFloat(document.getElementById('score-expression').value) || 0;
  const structure = parseFloat(document.getElementById('score-structure').value) || 0;
  const punctuation = parseFloat(document.getElementById('score-punctuation').value) || 0;
  const typos = parseFloat(document.getElementById('score-typos').value) || 0;

  const total = (content * 4) + (expression * 3) + (structure * 2) + (punctuation * 1) + typos;
  document.getElementById('score-total').value = total;
  return total;
}

function handleCheckboxChange(checkbox, doUpdate = true) {
  const id = checkbox.id;
  const isChecked = checkbox.checked;
  const checkItem = checkbox.closest('.check-item');
  const interactiveModule = checkItem.querySelector('.interactive-module');
  const editableComment = checkItem.querySelector('.editable-comment');

  if (interactiveModule) interactiveModule.style.display = isChecked ? 'block' : 'none';
  if (editableComment) editableComment.style.display = isChecked ? 'block' : 'none';

  if (isChecked) populateEditableTextarea(id);
  if (doUpdate) updateAllOutputs();
}

function getCritiqueData(id, type) {
  const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
  if (!critiqueEl) return '';

  switch (type) {
    case 'title': return critiqueEl.querySelector('h4')?.textContent || critiqueEl.dataset.title || '';
    case 'fullText': return Array.from(critiqueEl.querySelectorAll('p')).map(p => p.textContent).join('\n\n');
    case 'concise': return {
      problemCore: critiqueEl.dataset.problemCore || '',
      suggestion: critiqueEl.dataset.suggestion || '',
      strengthSummary: critiqueEl.dataset.strengthSummary || '',
      example: critiqueEl.dataset.example || ''
    };
    default: return '';
  }
}

function getConciseData(id) {
  const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
  if (!el) return null;
  return {
    problemCore: el.dataset.problemCore || '',
    suggestion: el.dataset.suggestion || '',
    strengthSummary: el.dataset.strengthSummary || '',
    example: el.dataset.example || ''
  };
}

function getInteractiveValue(id, includePlaceholder = true) {
    let value = '';
    const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
    const placeholder = critiqueEl?.dataset.optionsLabel || 'é¸é …';

    const select = document.getElementById(`${id}-select`);
    const otherInput = document.getElementById(`${id}-other-text`);

    if (select) {
        value = select.value;
        if (value === 'å…¶ä»–' && otherInput) {
            value = otherInput.value.trim();
        }
    }
    
    return includePlaceholder ? (value || placeholder) : value;
}

function buildTypoSectionRaw(typosList) {
  const list = Array.isArray(typosList) ? typosList : currentTypos;
  if (!list.length) return [];
  return list.map((t, idx) => {
    const wrong = t.wrong ? `ã€Œ${t.wrong}ã€` : '';
    const correct = t.correct ? `ã€Œ${t.correct}ã€` : 'ã€Œï¼ˆæœªå¡«æ­£å­—ï¼‰ã€';
    return `${idx + 1}. ${wrong}â†’${correct}`;
  });
}

function buildTypoSection(isStudent = false, typosList = null) {
  const rawLines = buildTypoSectionRaw(typosList);
  if (!rawLines.length) return '';
  const header = isStudent ? 'ã€âœï¸éŒ¯åˆ¥å­—ã€‘' : 'ã€éŒ¯åˆ¥å­—ã€‘';
  const body = (isStudent ? rawLines.map(s => `- ${s}`) : rawLines).join('\n');
  return [header, body].filter(s => s && s.trim()).join('\n');
}

function normalizeSpacing(text) {
  if (!text) return '';
  let t = text.split('\n').map(s=>s.replace(/\s+$/,'')).join('\n').trim();
  t = t.replace(/\n{3,}/g, '\n\n');
  t = t.replace(/^\n+/, '').replace(/\n+$/, '');
  return t;
}

function toFullWidthPunctuation(str) {
    if (typeof str !== 'string') return str;
    const map = {
        ',': 'ï¼Œ', '.': 'ã€‚', '?': 'ï¼Ÿ', '!': 'ï¼', ':': 'ï¼š', ';': 'ï¼›',
        '(': 'ï¼ˆ', ')': 'ï¼‰', '[': 'ã€', ']': 'ã€‘'
    };
    return str.replace(/[[],.?_!:]/g, m => map[m] || m);
}

function updateAllOutputs() {
  const studentClass = document.getElementById('student-class').value.trim();
  const topic = document.getElementById('topic').value.trim();
  const selectedStudentOriginalName = document.getElementById('student-select').value;
  const uniqueComment = document.getElementById('unique-comment').value.trim();

  const scoreContent = document.getElementById('score-content').value;
  const scoreExpression = document.getElementById('score-expression').value;
  const scoreStructure = document.getElementById('score-structure').value;
  const scorePunctuation = document.getElementById('score-punctuation').value;
  const scoreTypos = document.getElementById('score-typos').value;
  const scoreTotal = document.getElementById('score-total').value;

  let scoreSummaryText = '';
  if (scoreContent || scoreExpression || scoreStructure || scorePunctuation || scoreTypos) {
    scoreSummaryText = [
      'ã€ğŸ“è©•åˆ†ã€‘',
      `å…§å®¹ï¼š${scoreContent || '-'} | è¡¨é”ï¼š${scoreExpression || '-'} | çµæ§‹ï¼š${scoreStructure || '-'} | æ¨™é»åŠå­—é«”ï¼š${scorePunctuation || '-'} | éŒ¯åˆ¥å­—ï¼š${scoreTypos || '-'}`,
      `ç¸½åˆ†ï¼š${scoreTotal || '-'}`
    ].join('\n');
  }

  const checked = document.querySelectorAll('#checklist-container input[type="checkbox"]:checked');
  const excellentCritiques = [];
  const problemCritiques = [];
  checked.forEach(cb => {
    const id = cb.id;
    const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (!el) return;
    const type = el.dataset.type;
    if (type === 'excellent') excellentCritiques.push({ id });
    else problemCritiques.push({ id });
  });

  const typoTextFullRaw = buildTypoSection(false);
  const typoTextStudentRaw = buildTypoSection(true);

  generateFullVersion(studentClass, selectedStudentOriginalName, topic, uniqueComment, excellentCritiques, problemCritiques, scoreSummaryText, typoTextFullRaw);
  generateStudentReport(studentClass, selectedStudentOriginalName, topic, uniqueComment, excellentCritiques, problemCritiques, scoreSummaryText, typoTextStudentRaw);
}

function generatePureFullVersion(excellents, problems) {
  let parts = [];
  if (excellents.length > 0) {
    parts.push('ã€å„ªé»ã€‘');
    excellents.forEach((c, i) => {
      const id = c.id;
      const title = getCritiqueData(id, 'title');
      const concise = getConciseData(id);
      if (!concise) return;
      const v = getInteractiveValue(id, false);
      const examples = concretizeExample(id, concise.example);
      const seg = [];
      seg.push(`ï¼ˆ${i+1}ï¼‰${title}`);
      let strengthSummary = concise.strengthSummary || '';
      if (v) strengthSummary = strengthSummary.replace(/[é¸é …]/g, `ã€Œ${v}ã€`);
      if (strengthSummary) seg.push(`${strengthSummary}`);
      if (examples.length) seg.push(`ä¾‹å¦‚ï¼š${examples.join(' ')}`);
      parts.push(seg.join('\n'));
    });
  }

  if (problems.length > 0) {
    parts.push('', 'ã€å¾…æ”¹é€²ã€‘');
    problems.forEach((c, i) => {
      const id = c.id;
      const concise = getConciseData(id);
      if (!concise) return;
      const v = getInteractiveValue(id, false);
      const examples = concretizeExample(id, concise.example);
      const seg = [];
      seg.push(`ï¼ˆ${i+1}ï¼‰`);
      let problemText = concise.problemCore || '';
      if (v) problemText = problemText.replace(/[é¸é …]/g, `ã€Œ${v}ã€`);
      if (problemText) seg.push(`å•é¡Œï¼š${problemText}`);
      let suggestion = concise.suggestion || '';
      if (v) suggestion = suggestion.replace(/[é¸é …]/g, `ã€Œ${v}ã€`);
      if (suggestion) seg.push(`å®œï¼š${suggestion}`);
      if (examples.length) seg.push(`ä¾‹å¦‚ï¼Œ${examples.join(' ')}`);
      parts.push(seg.join(' '));
    });
  }
  return toFullWidthPunctuation(normalizeSpacing(parts.join('\n')));
}

function generatePureStudentReport(excellents, problems) {
  let out = [];
  if (excellents.length > 0) {
    out.push('ã€ğŸ˜åšå¾—å¥½ã€‘');
    excellents.forEach((c, index) => {
      const ta = document.getElementById(`text-${c.id}`);
      let text = ta && ta.value ? ta.value : composeStudentFromConcise(c.id);
      out.push(`(${index + 1}) ${text}`);
    });
  }

  if (problems.length > 0) {
    out.push('', 'ã€å¾…æ”¹é€²â—ã€‘');
    problems.forEach((c, index) => {
      const ta = document.getElementById(`text-${c.id}`);
      let text = ta && ta.value ? ta.value : composeStudentFromConcise(c.id);
      out.push(`(${index + 1}) ${text}`);
    });
  }
  return toFullWidthPunctuation(normalizeSpacing(out.join('\n')));
}

function generateFullVersion(studentClass, student, topic, unique, excellents, problems, score, typoTextFullRaw) {
  const ta = document.getElementById('full-output');
  if (ta?.dataset.userEditing) return;

  let parts = [];
  parts.push(`ç­åˆ¥ï¼š${studentClass || 'N/A'}`);
  parts.push(`å­¸ç”Ÿï¼š${student || 'N/A'}`);
  parts.push(`é¡Œç›®ï¼š${topic || 'N/A'}`);

  if (unique) parts.push('', 'ã€ç‰¹åˆ¥ç•™è¨€ã€‘', unique);
  
  const pureComment = generatePureFullVersion(excellents, problems);
  if(pureComment) parts.push('', pureComment);

  if (typoTextFullRaw) parts.push('', typoTextFullRaw);
  if (score) parts.push('', score);

  ta.value = toFullWidthPunctuation(normalizeSpacing(parts.join('\n')));
}

function generateStudentReport(studentClass, student, topic, unique, excellents, problems, scoreTextRaw, typoTextRaw) {
  const ta = document.getElementById('student-report-output');
  if (ta?.dataset.userEditing) return;

  let out = [];
  out.push(`ç­åˆ¥ï¼š${studentClass || 'N/A'}`);
  out.push(`å­¸ç”Ÿï¼š${student || 'N/A'}`);
  out.push(`é¡Œç›®ï¼š${topic || 'N/A'}`);

  if (unique) out.push('', 'ã€ç‰¹åˆ¥ç•™è¨€ã€‘', unique);

  const pureComment = generatePureStudentReport(excellents, problems);
  if(pureComment) out.push('', pureComment);

  if (typoTextRaw) out.push('', typoTextRaw);
  if (scoreTextRaw) out.push('', scoreTextRaw);

  ta.value = toFullWidthPunctuation(normalizeSpacing(out.join('\n')));
}

function composeStudentFromConcise(id) {
  const c = getConciseData(id);
  if (!c) return '';
  const isExcellent = document.querySelector(`#critique-data div[data-id="${id}"]`)?.dataset.type === 'excellent';
  const v = getInteractiveValue(id, false);
  const exampleLines = concretizeExample(id, c.example);
  const parts = [];
  const title = getCritiqueData(id, 'title');
  parts.push(`${title}`);

  if (isExcellent) {
    let strengthSummary = c.strengthSummary || '';
    if (v) strengthSummary = strengthSummary.replace(/[é¸é …]/g, `ã€Œ${v}ã€`);
    if (strengthSummary) parts.push(`- å„ªé»ï¼š${strengthSummary}`);
    if (exampleLines.length > 0) exampleLines.forEach(line => parts.push(`- ${line}`));
  } else {
    let problemText = c.problemCore || '';
    if (v) problemText = problemText.replace(/[é¸é …]/g, `ã€Œ${v}ã€`);
    if (problemText) parts.push(`- å•é¡Œï¼š${problemText}`);

    let suggestion = c.suggestion || '';
    if (v) suggestion = suggestion.replace(/[é¸é …]/g, `ã€Œ${v}ã€`);
    if (suggestion) parts.push(`- å®œï¼š${suggestion}`);
    
    if (exampleLines.length > 0) exampleLines.forEach(line => parts.push(`- ä¾‹ï¼š${line}`));
  }
  return parts.join('\n');
}

function copyOutput(textareaId, buttonElement) {
  const textarea = document.getElementById(textareaId);
  if (!textarea.value) return;
  textarea.select();
  navigator.clipboard.writeText(textarea.value).then(() => {
    notifyCopySuccess(buttonElement, "å·²è¤‡è£½");
  }).catch(() => {
    try { document.execCommand('copy'); notifyCopySuccess(buttonElement, "å·²è¤‡è£½"); } catch (e) { notifyCopySuccess(buttonElement, "è¤‡è£½å¤±æ•—"); }
  });
}

function notifyCopySuccess(buttonElement, message) {
  const originalText = buttonElement.innerText;
  buttonElement.innerText = message;
  buttonElement.classList.add('copied');
  setTimeout(() => {
    buttonElement.innerText = originalText;
    buttonElement.classList.remove('copied');
  }, 2000);
}

function addTypo() {
  const wrong = (document.getElementById('typo-wrong').value || '').trim();
  const correct = (document.getElementById('typo-correct').value || '').trim();
  if (!correct) return;

  currentTypos.push({ wrong, correct });
  document.getElementById('typo-wrong').value = '';
  document.getElementById('typo-correct').value = '';
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
}

function removeTypo(idx) {
  currentTypos.splice(idx, 1);
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
}

function renderTypoList() {
  const ul = document.getElementById('typo-list');
  if (!ul) return;
  ul.innerHTML = '';
  currentTypos.forEach((t, i) => {
    const wrongPart = t.wrong ? `ã€Œ${t.wrong}ã€` : '';
    const li = document.createElement('li');
    li.style.cssText = 'display:flex; gap:8px; align-items:center; padding:6px 10px; background:#f9f9fb; border:1px solid #eee; border-radius:6px; margin-bottom:8px;';
    li.innerHTML = `
      <span style="flex:1;">æœ¬æ¬¡ï¼š ${wrongPart}â†’ã€Œ${t.correct || 'ï¼ˆæœªå¡«æ­£å­—ï¼‰'}ã€</span>
      <button class="action-btn" style="background:var(--btn-brown-bg); padding:6px 10px; border-radius:4px;" onclick="savePairIfNotInCommon(${i})">åŠ å…¥å¸¸è¦‹åº«</button>
      <button class="action-btn" style="background:#c86a5a; padding:6px 10px; border-radius:4px;" onclick="removeTypo(${i})">åˆªé™¤</button>
    `;
    ul.appendChild(li);
  });
}

function savePairIfNotInCommon(idx) {
  const pair = currentTypos[idx];
  if (!pair) return;
  const exists = commonTypos.some(t => t.wrong === pair.wrong && t.correct === pair.correct);
  if (!exists && pair.correct) {
    commonTypos.push({ id: `c_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, wrong: pair.wrong, correct: pair.correct });
    persistCommonTypos(true);
    renderCommonTypoList();
  } else {
    renderCommonTyposCheckedState();
  }
}

function saveTypoToCommon() {
  const wrong = (document.getElementById('typo-wrong').value || '').trim();
  const correct = (document.getElementById('typo-correct').value || '').trim();
  if (!correct) return;

  let item = commonTypos.find(t => t.wrong === wrong && t.correct === correct);
  if (!item) {
    item = { id: `c_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, wrong, correct };
    commonTypos.push(item);
    persistCommonTypos(true);
  }

  const existsInCurrent = currentTypos.some(t => t.wrong === wrong && t.correct === correct);
  if (!existsInCurrent) {
    currentTypos.push({ wrong, correct });
  }

  renderCommonTypoList();
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();

  document.getElementById('typo-wrong').value = '';
  document.getElementById('typo-correct').value = '';
}

function renderCommonTypoList() {
  const ul = document.getElementById('typo-saved-list');
  if (!ul) return;
  ul.innerHTML = '';
  commonTypos = commonTypos.filter(t => (t.correct||'').trim());
  persistCommonTypos(true);

  commonTypos.forEach(t => {
    const isInCurrent = currentTypos.findIndex(x => x.wrong === t.wrong && x.correct === t.correct) >= 0;
    const wrongPart = t.wrong ? `ã€Œ${t.wrong}ã€` : '';
    const li = document.createElement('li');
    li.innerHTML = `
      <input type="checkbox" ${isInCurrent ? 'checked' : ''} onchange="toggleCommonToCurrent('${t.id}', this.checked)" style="accent-color: var(--accent-color);">
      <span class="word">${wrongPart}â†’ã€Œ${t.correct}ã€</span>
      <button class="danger-btn" onclick="confirmUI('åˆªé™¤æ­¤æ¢å¸¸è¦‹éŒ¯åˆ¥å­—ï¼Ÿ', ()=> deleteCommonTypo('${t.id}'))">åˆªé™¤</button>
    `;
    ul.appendChild(li);
  });
}

function renderCommonTyposCheckedState() {
  document.querySelectorAll('#typo-saved-list li').forEach(li => {
    const cb = li.querySelector('input[type="checkbox"]');
    if (!cb) return;
    const label = li.querySelector('.word');
    if (!label) return;
    const text = label.textContent || '';
    const match = text.match(/ã€Œ(.*?)ã€â†’ã€Œ(.*?)ã€/);
    if (!match) return;
    const wrong = match[1];
    const correct = match[2];
    const checked = currentTypos.some(x => x.wrong === wrong && x.correct === correct);
    cb.checked = checked;
  });
}

function toggleCommonToCurrent(id, checked) {
  const item = commonTypos.find(t => t.id === id);
  if (!item) return;
  if (checked) {
    const exists = currentTypos.some(x => x.wrong === item.wrong && x.correct === item.correct);
    if (!exists) currentTypos.push({ wrong: item.wrong, correct: item.correct });
  } else {
    const idx = currentTypos.findIndex(x => x.wrong === item.wrong && x.correct === item.correct);
    if (idx >= 0) currentTypos.splice(idx, 1);
  }
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
}

function deleteCommonTypo(id) {
  const idx = commonTypos.findIndex(t => t.id === id);
  if (idx >= 0) {
    const { wrong, correct } = commonTypos[idx];
    const idxCur = currentTypos.findIndex(x => x.wrong === wrong && x.correct === correct);
    if (idxCur >= 0) currentTypos.splice(idxCur, 1);
    commonTypos.splice(idx, 1);
    persistCommonTypos(true);
    renderCommonTypoList();
    renderTypoList();
    updateAllOutputs();
  }
}

function persistCommonTypos(writeStorage=false) {
  try {
    if (writeStorage) {
      localStorage.setItem('commonTypos', JSON.stringify(commonTypos));
    }
  } catch (e) {
    console.warn("ç„¡æ³•å„²å­˜å¸¸è¦‹éŒ¯åˆ¥å­—åˆ° localStorage:", e.message);
  }
}

function loadCommonTypos() {
  try {
    const raw = localStorage.getItem('commonTypos');
    if (raw) {
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) {
        commonTypos = arr
          .map((t, idx) => ({ id: t.id || `c_${Date.now()}_${idx}`, wrong: (t.wrong||'').trim(), correct: (t.correct||'').trim() }))
          .filter(t => t.correct);
      }
    }
  } catch (e) {
     console.warn("ç„¡æ³•å¾ localStorage è¼‰å…¥å¸¸è¦‹éŒ¯åˆ¥å­—:", e.message);
  }
  renderCommonTypoList();
}

/* -------------------------------------------------------- */
/* --- å­¸ç”Ÿè³‡æ–™å„²å­˜ã€è®€å–èˆ‡ç¸½è¦½ç›¸é—œåŠŸèƒ½ --- */
/* -------------------------------------------------------- */

function navigateToStudent(direction) {
  const select = document.getElementById('student-select');
  const options = select.options;
  if (options.length <= 1) return;

  let currentIndex = select.selectedIndex;
  let newIndex;

  if (direction === 'next') {
    newIndex = currentIndex + 1;
    if (newIndex >= options.length) {
      newIndex = 0; 
    }
  } else { 
    newIndex = currentIndex - 1;
    if (newIndex < 0) {
      newIndex = options.length - 1; 
    }
  }

  select.selectedIndex = newIndex;
  select.dispatchEvent(new Event('change'));
}

function saveCurrentStudentData() {
  const studentOriginalName = document.getElementById('student-select').value;
  if (!studentOriginalName) {
    alert('è«‹å…ˆå¾ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ä¸€ä½å­¸ç”Ÿã€‚');
    return;
  }

  const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
  if (!studentRecord) {
    alert('éŒ¯èª¤ï¼šåœ¨è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°è©²å­¸ç”Ÿã€‚');
    return;
  }

  const checkedCritiques = [];
  const excellentCritiques = [];
  const problemCritiques = [];
  document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
    const id = cb.id;
    const data = { id: id };
    const select = document.getElementById(`${id}-select`);
    if (select && select.value) {
      data.selectValue = select.value;
      if (select.value === 'å…¶ä»–') {
        const otherInput = document.getElementById(`${id}-other-text`);
        data.otherValue = otherInput ? otherInput.value : '';
      }
    }
    checkedCritiques.push(data);
    
    const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (el) {
        if (el.dataset.type === 'excellent') excellentCritiques.push({ id });
        else problemCritiques.push({ id });
    }
  });

  const uniqueCommentText = document.getElementById('unique-comment').value.trim();
  const uniqueCommentBlock = uniqueCommentText ? `ã€ç‰¹åˆ¥ç•™è¨€ã€‘\n${uniqueCommentText}\n\n` : '';

  const pureFull = generatePureFullVersion(excellentCritiques, problemCritiques);
  const pureStudent = generatePureStudentReport(excellentCritiques, problemCritiques);

  const selectedTitles = checkedCritiques
      .map(c => getCritiqueData(c.id, 'title'))
      .filter(Boolean)
      .join('ï¼›');

  studentRecord.data = {
    class: document.getElementById('student-class').value,
    topic: document.getElementById('topic').value,
    uniqueComment: document.getElementById('unique-comment').value,
    scores: {
      content: document.getElementById('score-content').value,
      expression: document.getElementById('score-expression').value,
      structure: document.getElementById('score-structure').value,
      punctuation: document.getElementById('score-punctuation').value,
      typos: document.getElementById('score-typos').value,
      total: document.getElementById('score-total').value,
    },
    typos: [...currentTypos],
    checkedCritiques: checkedCritiques,
    selectedTitles: selectedTitles,
    fullComment: document.getElementById('full-output').value,
    studentComment: document.getElementById('student-report-output').value,
    pureFullComment: `${uniqueCommentBlock}${pureFull}`.trim(),
    pureStudentComment: `${uniqueCommentBlock}${pureStudent}`.trim(),
  };

  renderStudentOverviewTable();

  confirmUI(
    `å·²æˆåŠŸå„²å­˜ ${studentOriginalName} çš„è©•èªè³‡æ–™ï¼\n\næ˜¯å¦è¦æ¸…ç©ºç•¶å‰å…§å®¹ï¼Œä»¥æº–å‚™è¼¸å…¥ä¸‹ä¸€ä½å­¸ç”Ÿï¼Ÿ`,
    () => {
      clearAllCore();
      const targetSection = document.getElementById('step-2-section');
      if (targetSection) {
        targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
  );
}

function loadStudentData(studentOriginalName) {
  const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
  
  clearAllCore(false); 

  if (!studentRecord || !studentRecord.data) {
    const studentClass = document.getElementById('student-class').value;
    const topic = document.getElementById('topic').value;
    clearAllCore(true);
    document.getElementById('student-class').value = studentClass;
    document.getElementById('topic').value = topic;
    updateAllOutputs();
    return;
  }

  const data = studentRecord.data;
  
  document.getElementById('student-class').value = data.class || '';
  document.getElementById('topic').value = data.topic || '';
  document.getElementById('unique-comment').value = data.uniqueComment || '';
  Object.keys(data.scores).forEach(key => {
    const el = document.getElementById(`score-${key.toLowerCase()}`);
    if (el) el.value = data.scores[key] || '';
  });

  currentTypos = data.typos ? [...data.typos] : [];
  renderTypoList();
  renderCommonTyposCheckedState();

  if (data.checkedCritiques) {
    data.checkedCritiques.forEach(item => {
      const cb = document.getElementById(item.id);
      if (cb) {
        cb.checked = true;
        handleCheckboxChange(cb, false); 
        if (item.selectValue) {
          const select = document.getElementById(`${item.id}-select`);
          if (select) {
            select.value = item.selectValue;
            toggleOtherBlock(item.id, item.selectValue);
            if (item.selectValue === 'å…¶ä»–' && item.otherValue) {
              const otherInput = document.getElementById(`${item.id}-other-text`);
              if (otherInput) otherInput.value = item.otherValue;
            }
          }
        }
      }
    });
  }

  document.getElementById('full-output').value = data.fullComment || '';
  document.getElementById('student-report-output').value = data.studentComment || '';
  
  updateAllOutputs();
}

function handleTableEdit(textarea) {
    const studentOriginalName = textarea.dataset.studentName;
    const field = textarea.dataset.field;
    const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
    
    if (studentRecord && studentRecord.data) {
        studentRecord.data[field] = textarea.value;
    }
}

function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

function handleOverviewScoreChange(input) {
    const studentOriginalName = input.dataset.studentName;
    const scoreType = input.dataset.scoreType;
    const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
    if (!studentRecord || !studentRecord.data) return;

    studentRecord.data.scores[scoreType] = input.value;

    const s = studentRecord.data.scores;
    const content = parseFloat(s.content) || 0;
    const expression = parseFloat(s.expression) || 0;
    const structure = parseFloat(s.structure) || 0;
    const punctuation = parseFloat(s.punctuation) || 0;
    const typos = parseFloat(s.typos) || 0;
    const newTotal = (content * 4) + (expression * 3) + (structure * 2) + (punctuation * 1) + typos;
    
    studentRecord.data.scores.total = newTotal;

    const totalCell = document.getElementById(`total-score-${escapeHtmlAttr(studentOriginalName)}`);
    if (totalCell) {
        totalCell.textContent = newTotal;
    }
}

function renderStudentOverviewTable() {
  const tbody = document.querySelector("#student-overview-table tbody");
  const classDisplay = document.getElementById("overview-class-display");
  const progressTracker = document.getElementById("progress-tracker");
  if (!tbody || !classDisplay || !progressTracker) return;

  tbody.innerHTML = '';
  const parsedNames = allStudentRecords;

  if (parsedNames.length === 0) {
    classDisplay.textContent = '';
    progressTracker.innerHTML = '';
    tbody.innerHTML = `<tr><td colspan="10" class="empty-state-message">å°šæœªå„²å­˜ä»»ä½•å­¸ç”Ÿè¨˜éŒ„ã€‚</td></tr>`;
    return;
  }

  const completedRecords = parsedNames.filter(r => r.data && (r.data.scores.total !== '' && r.data.scores.total != null));
  const pendingRecords = parsedNames.filter(r => !completedRecords.includes(r));

  const completedCount = completedRecords.length;
  const pendingCount = pendingRecords.length;
  if (pendingCount === 0 && completedCount > 0) {
      progressTracker.innerHTML = `<span class="kpi">ğŸ‰ åŠŸå¾·åœ“æ»¿ï¼æº–æ™‚æ”¶å·¥ï¼ğŸ‰</span>`;
  } else {
      progressTracker.innerHTML = `
          <span class="kpi">ä»Šæ—¥åŠŸå¾· = ${completedCount} æœ¬</span>
          <span class="pending">é›¢ä¸‹ç­é‚„æœ‰... ${pendingCount} æœ¬</span>
      `;
  }

  const sorter = (a, b) => {
    if (a.number !== null && b.number !== null) return a.number - b.number;
    if (a.number !== null) return -1;
    if (b.number !== null) return 1;
    return a.name.localeCompare(b.name, 'zh-Hant');
  };
  completedRecords.sort(sorter);
  pendingRecords.sort(sorter);

  const firstWithData = completedRecords[0] || pendingRecords[0];
  const className = (firstWithData && firstWithData.data && firstWithData.data.class) ? (firstWithData.data.class || 'æœªæŒ‡å®šç­åˆ¥') : 'æœªæŒ‡å®šç­åˆ¥';
  classDisplay.textContent = `ç­åˆ¥ï¼š${className}`;

  const renderRow = (record, hasData) => {
    const d = (hasData && record.data) ? record.data : {};
    const s = d.scores || {};
    const tr = document.createElement('tr');
    const safeOriginalName = escapeHtmlAttr(record.originalName);

    if (!hasData) {
      tr.classList.add('row-missing');
      tr.innerHTML = `
        <td>${record.number || ''}</td>
        <td>
          <a href="javascript:void(0)" onclick="jumpToStudentFromOverview('${safeOriginalName}')" style="color:#2563eb; text-decoration:underline;">
             ${escapeHtmlAttr(record.name) || ''}
          </a>
        </td>
        <td class="unfilled-cell">æœªå¡«</td>
        <td class="unfilled-cell">æœªå¡«</td>
        <td class="unfilled-cell">æœªå¡«</td>
        <td class="unfilled-cell">æœªå¡«</td>
        <td class="unfilled-cell">æœªå¡«</td>
        <td class="total-score-cell">æœªå¡«</td>
        <td></td>
        <td></td>
      `;
    } else {
      tr.innerHTML = `
        <td>${record.number || ''}</td>
        <td>
          <a href="javascript:void(0)" 
             onclick="jumpToStudentFromOverview('${safeOriginalName}')"
             style="color:#2563eb; text-decoration:underline;">
             ${escapeHtmlAttr(record.name) || ''}
          </a>
        </td>
        <td><input type="number" value="${escapeHtmlAttr(s.content)}" data-student-name="${safeOriginalName}" data-score-type="content" oninput="handleOverviewScoreChange(this)"></td>
        <td><input type="number" value="${escapeHtmlAttr(s.expression)}" data-student-name="${safeOriginalName}" data-score-type="expression" oninput="handleOverviewScoreChange(this)"></td>
        <td><input type="number" value="${escapeHtmlAttr(s.structure)}" data-student-name="${safeOriginalName}" data-score-type="structure" oninput="handleOverviewScoreChange(this)"></td>
        <td><input type="number" value="${escapeHtmlAttr(s.punctuation)}" data-student-name="${safeOriginalName}" data-score-type="punctuation" oninput="handleOverviewScoreChange(this)"></td>
        <td><input type="number" value="${escapeHtmlAttr(s.typos)}" data-student-name="${safeOriginalName}" data-score-type="typos" oninput="handleOverviewScoreChange(this)"></td>
        <td class="total-score-cell" id="total-score-${safeOriginalName}">${escapeHtmlAttr(s.total) || ''}</td>
        <td><textarea data-student-name="${safeOriginalName}" data-field="pureFullComment" oninput="handleTableEdit(this); autoResizeTextarea(this);">${escapeHtmlAttr(d.pureFullComment)}</textarea></td>
        <td><textarea data-student-name="${safeOriginalName}" data-field="pureStudentComment" oninput="handleTableEdit(this); autoResizeTextarea(this);">${escapeHtmlAttr(d.pureStudentComment)}</textarea></td>
      `;
    }
    tbody.appendChild(tr);
  };

  completedRecords.forEach(r => renderRow(r, true));
  pendingRecords.forEach(r => renderRow(r, false));

  setTimeout(() => {
    tbody.querySelectorAll('textarea').forEach(autoResizeTextarea);
  }, 0);
}


function jumpToStudentFromOverview(originalName) {
  showPage('page1');

  const sel = document.getElementById('student-select');
  if (!sel) return;

  sel.value = originalName;
  sel.dispatchEvent(new Event('change'));

  const target = document.getElementById('step-2-section');
  if (target) {
    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

/* ---------------- ç¬¬å››é ï¼šè©•èªåˆ†æ ---------------- */

function renderAnalysisPage() {
  const scoreDiv = document.getElementById('analysis-score-summary');
  const topDiv = document.getElementById('analysis-top-critique');
  scoreDiv.innerHTML = '';
  topDiv.innerHTML = '';

  const analysisData = getAnalysisData();
  if (!analysisData) {
    scoreDiv.innerHTML = `<div class="empty-state-message">ç›®å‰å°šæœªæœ‰å·²å„²å­˜çš„å­¸ç”Ÿè©•èªï¼Œç„¡æ³•è¨ˆç®—å¹³å‡åˆ†æ•¸ã€‚</div>`;
    topDiv.innerHTML = `<div class="empty-state-message">å°šæœªæœ‰ä»»ä½•å‹¾é¸è©•èªé …ç›®ï¼Œç„¡æ³•çµ±è¨ˆå¸¸è¦‹é …ç›®ã€‚</div>`;
    return;
  }

  const { scoreSummary, topEntries } = analysisData;

  const scoreRows = scoreSummary.map(row => `
    <tr>
      <td>${escapeHtml(row.æŒ‡æ¨™)}</td>
      <td>${row.å¹³å‡åˆ† != null ? row.å¹³å‡åˆ†.toFixed(2) : '-'}</td>
    </tr>
  `).join('');

  scoreDiv.innerHTML = `
    <table class="analysis-table">
      <thead><tr><th>æŒ‡æ¨™</th><th>å¹³å‡åˆ†</th></tr></thead>
      <tbody>${scoreRows}</tbody>
    </table>
    <p style="font-size:0.85rem;color:#777;margin-top:0.75rem;">
      â€» å¹³å‡åˆ†åªæœƒè¨ˆç®—å·²å¡«å¯«è©²æ¬„åˆ†æ•¸çš„å­¸ç”Ÿã€‚
    </p>
  `;

  if (!topEntries.length) {
    topDiv.innerHTML = `<div class="empty-state-message">å°šæœªæœ‰ä»»ä½•è©•èªé …ç›®è¢«å‹¾é¸ã€‚</div>`;
    return;
  }

  const topCritiqueRows = topEntries.map(row => `
      <tr>
        <td>${row.æ’å}</td>
        <td>${escapeHtmlAttr(row.è©•èªæ¨™é¡Œ)}</td>
        <td>${row.è¢«é¸æ¬¡æ•¸}</td>
      </tr>
  `).join('');

  topDiv.innerHTML = `
    <table class="analysis-table">
      <thead><tr><th>æ’å</th><th>è©•èªæ¨™é¡Œ</th><th>è¢«é¸æ¬¡æ•¸</th></tr></thead>
      <tbody>${topCritiqueRows}</tbody>
    </table>
    <p style="font-size:0.85rem;color:#777;margin-top:0.75rem;">
      â€» çµ±è¨ˆæ ¹æ“šå­¸ç”Ÿå¯¦éš›å‹¾é¸çš„è©•èªé …ç›®ï¼ˆåŒä¸€é …ç›®åœ¨åŒä¸€å­¸ç”Ÿåªè¨ˆ 1 æ¬¡ï¼‰ã€‚
    </p>
  `;
}

/* ---------------- ç¬¬äº”é ï¼šAI è©•èªåº«ç”Ÿæˆ ---------------- */
function generateAIPrompt() {
    const levelSelect = document.getElementById('ai-student-level');
    const levelText = levelSelect.options[levelSelect.selectedIndex].text;

    const topic = document.getElementById('ai-topic').value.trim();
    if (!topic) {
        alert('è«‹å…ˆå¡«å¯«ä½œæ–‡é¡Œç›®ã€‚');
        document.getElementById('ai-topic').focus();
        return;
    }

    const focusSelect = document.getElementById('ai-focus');
    const focusText = focusSelect.options[focusSelect.selectedIndex].text;

    const excellentCount = document.getElementById('ai-excellent-count').value.trim();
    const problemCount = document.getElementById('ai-problem-count').value.trim();
    const highlights = document.getElementById('ai-highlights').value.trim();

    let totalCountText = '10-15';
    if (excellentCount || problemCount) {
        const total = (parseInt(excellentCount, 10) || 0) + (parseInt(problemCount, 10) || 0);
        if (total > 0) {
            totalCountText = total;
        }
    }

    let countDetails = '';
    if (excellentCount) {
        countDetails += `\n- å„ªé»è©•èª ("excellent") æ•¸é‡ï¼šç´„ ${excellentCount} æ¢`;
    }
    if (problemCount) {
        countDetails += `\n- å¾…æ”¹é€²è©•èª ("problem") æ•¸é‡ï¼šç´„ ${problemCount} æ¢`;
    }

    const prompt = `
# Role and Goal
ä½ æ˜¯ä¸€ä½è³‡æ·±çš„é¦™æ¸¯ä¸­æ–‡å¯«ä½œè€å¸«ï¼Œæ“æœ‰ 20 å¹´æ•™å­¸ç¶“é©—ã€‚ä½ çš„ä»»å‹™æ˜¯ç‚ºä¸€ç¯‡æŒ‡å®šé¡Œç›®çš„ä¸­å­¸ä½œæ–‡ï¼Œç”Ÿæˆä¸€å€‹åŒ…å« ${totalCountText} æ¢è©•èªçš„ JSON è©•èªåº«ã€‚é€™äº›è©•èªå°‡ç”¨æ–¼ä¸€å€‹è©•èªç”Ÿæˆå™¨å·¥å…·ä¸­ã€‚

# Persona
- æ•™å­¸é¢¨æ ¼ï¼šæº«å’Œè€Œå …å®šï¼Œé¼“å‹µç‚ºä¸»ä½†ä¸è¿´é¿å•é¡Œã€‚
- èªè¨€ï¼šä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œé¦™æ¸¯æ…£ç”¨è©å½™ã€‚
- å°ˆé•·ï¼š
  - åˆ†æä½œæ–‡é¡Œç›®çš„æ ¸å¿ƒè¦æ±‚ã€‚
  - è­˜åˆ¥å­¸ç”Ÿå¸¸è¦‹çš„å¯«ä½œå•é¡Œã€‚
  - æä¾›å…·é«”å¯è¡Œçš„æ”¹é€²å»ºè­°ã€‚
  - èˆ‰å‡ºè²¼è¿‘ä¸­å­¸ç”Ÿç”Ÿæ´»çš„ä¾‹å­ã€‚

# Core Task Details
- ä½œæ–‡é¡Œç›®ï¼šã€Œ${topic}ã€
- å­¸ç”Ÿç´šåˆ¥ï¼š${levelText}
- è©•èªé‡é»ï¼š${focusText}${countDetails}
${highlights ? `- ç‰¹åˆ¥é—œæ³¨ï¼š${highlights}` : ''}

# Student Level Guidelines
è«‹æ ¹æ“šæŒ‡å®šçš„å­¸ç”Ÿç´šåˆ¥èª¿æ•´è©•èªçš„æ·±åº¦å’Œé‡é»ï¼š
- åˆç´šå­¸ç”Ÿï¼ˆä¸­ä¸€è‡³ä¸­ä¸‰ï¼‰ï¼šè‘—é‡åŸºæœ¬åŠŸï¼ˆæ®µè½åŠƒåˆ†ã€æ¨™é»ä½¿ç”¨ã€èªå¥é€šé †ï¼‰ã€‚ä¾‹å­è¦æ·ºé¡¯æ˜“æ‡‚ï¼Œè²¼è¿‘æ—¥å¸¸ç”Ÿæ´»ã€‚é¼“å‹µå¤šæ–¼æ‰¹è©•ï¼Œå»ºç«‹å¯«ä½œä¿¡å¿ƒã€‚
- ä¸­ç´šå­¸ç”Ÿï¼ˆä¸­å››è‡³ä¸­äº”ï¼‰ï¼šæ—¢è¦éå›ºåŸºç¤ï¼Œä¹Ÿè¦æå‡è¡¨é”æŠ€å·§ã€‚é©åº¦å¼•å…¥ä¿®è¾­æ‰‹æ³•ã€çµæ§‹å®‰æ’ç­‰æ¦‚å¿µã€‚æä¾›å…·é«”æ”¹é€²æ–¹å‘ã€‚
- é«˜ç´šå­¸ç”Ÿï¼ˆä¸­å…­ï¼‰ï¼šè‘—é‡ç«‹æ„æ·±åº¦å’Œè¡¨é”æŠ€å·§ã€‚å¯æå‡ºè¼ƒé«˜è¦æ±‚ï¼ˆæ–‡é‡‡ã€æ€æƒ³æ·±åº¦ï¼‰ã€‚å¼•å°å­¸ç”Ÿæ€è€ƒæ›´æ·±å±¤æ¬¡çš„å•é¡Œã€‚

# Critique Principles
- é‡å°æ€§ï¼šæ¯å€‹è©•èªéƒ½è¦é‡å°é¡Œç›®ã€Œ${topic}ã€çš„ç‰¹é»å’Œè©²ç´šåˆ¥å­¸ç”Ÿçš„å¸¸è¦‹å¯«ä½œæŒ‘æˆ°ã€‚
- å…·é«”æ€§ï¼šé¿å…ã€Œå¯«å¾—å¾ˆå¥½ã€ã€ã€Œéœ€è¦æ”¹é€²ã€ç­‰ç©ºæ³›è©•èªã€‚è¦å…·é«”ï¼Œä¾‹å¦‚ã€Œé–‹é ­ç”¨è¨­å•å¥æˆåŠŸå¼•èµ·èˆˆè¶£ã€ã€ã€Œå¯åœ¨äººç‰©æå¯«ä¸­åŠ å…¥äº”æ„Ÿç´°ç¯€ã€ã€‚
- å¯æ“ä½œæ€§ï¼šå­¸ç”Ÿçœ‹äº†èƒ½ç«‹å³çŸ¥é“æ€éº¼æ”¹é€²ã€‚
- å¹³è¡¡æ€§ï¼šæ ¹æ“šã€Œè©•èªé‡é»ã€çš„è¦æ±‚ï¼Œå¹³è¡¡å„ªé»å’Œå¾…æ”¹é€²çš„è©•èªæ•¸é‡ã€‚

# Output Format (VERY IMPORTANT)
ä½ çš„å›è¦†å¿…é ˆæ˜¯ã€ä¹Ÿåªèƒ½æ˜¯ä¸€å€‹ JSON é™£åˆ—ã€‚ä¸è¦åŒ…å«ä»»ä½• JSON ä»¥å¤–çš„æ–‡å­—ã€è¨»è§£æˆ– markdown èªæ³•ï¼ˆä¾‹å¦‚ \`\`\`json ... \`\`\`ï¼‰ã€‚ç›´æ¥ä»¥ \`[\` é–‹é ­ï¼Œä»¥ \`]\` çµå°¾ã€‚

æ¯å€‹è©•èªéƒ½æ˜¯ä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š

- \`id\`: (å­—ä¸²) ä¸€å€‹ç¨ä¸€ç„¡äºŒçš„ IDï¼Œæ ¼å¼ç‚º "ai_gen_" + ä¸€ä¸²éš¨æ©Ÿå­—ç¬¦ã€‚
- \`category\`: (å­—ä¸²) è©•èªçš„ç¯„ç–‡ã€‚è«‹å¾ä»¥ä¸‹é¸é …ä¸­é¸æ“‡æœ€åˆé©çš„ä¸€å€‹ï¼š["æ‰£é¡Œèˆ‡ç«‹æ„", "å–æèˆ‡åˆ»ç•«", "çµæ§‹èˆ‡é‹ªæ’", "èªè¨€èˆ‡è¡¨é”"]ã€‚
- \`type\`: (å­—ä¸²) è©•èªé¡å‹ã€‚å¿…é ˆæ˜¯ "excellent" (å„ªé») æˆ– "problem" (å¾…æ”¹é€²)ã€‚
- \`title\`: (å­—ä¸²) è©•èªçš„ç°¡æ½”æ¨™é¡Œï¼Œä¾‹å¦‚ "æå¯«ç´°ç·»ï¼Œå½¢è±¡é®®æ˜"ã€‚
- \`strengthSummary\`: (å­—ä¸²) ç•¶ \`type\` æ˜¯ "excellent" æ™‚å¡«å¯«ã€‚å°å„ªé»çš„æ¦‚æ‹¬æ€§æè¿°ã€‚å¦‚æœè©•èªåŒ…å«å¯è®Šé¸é …ï¼Œè«‹ä½¿ç”¨ \`[é¸é …]\` ä½œç‚ºä½”ä½ç¬¦ã€‚
- \`problemCore\`: (å­—ä¸²) ç•¶ \`type\` æ˜¯ "problem" æ™‚å¡«å¯«ã€‚å°å•é¡Œæ ¸å¿ƒçš„æ¦‚æ‹¬æ€§æè¿°ã€‚å¦‚æœè©•èªåŒ…å«å¯è®Šé¸é …ï¼Œè«‹ä½¿ç”¨ \`[é¸é …]\` ä½œç‚ºä½”ä½ç¬¦ã€‚
- \`suggestion\`: (å­—ä¸²) ç•¶ \`type\` æ˜¯ "problem" æ™‚å¡«å¯«ã€‚é‡å°å•é¡Œæå‡ºçš„æ”¹å–„å»ºè­°ã€‚å¦‚æœè©•èªåŒ…å«å¯è®Šé¸é …ï¼Œè«‹ä½¿ç”¨ \`[é¸é …]\` ä½œç‚ºä½”ä½ç¬¦ã€‚
- \`example\`: (å­—ä¸²) ä¸€å€‹å…·é«”çš„ä¾‹å­ï¼Œç”¨ä»¥èªªæ˜è§€é»ã€‚ä¾‹å­å¿…é ˆèˆ‡é¡Œç›®ã€Œ${topic}ã€ç›¸é—œï¼Œä¸¦è²¼è¿‘é¦™æ¸¯ä¸­å­¸ç”Ÿçš„ç”Ÿæ´»ã€‚
- \`options\`: (å­—ä¸²) å¦‚æœè©•èªä¸­åŒ…å«å¯è®Šéƒ¨åˆ†ï¼ˆåœ¨ summary/problem/suggestion ä¸­ç”¨ \`[é¸é …]\` æ¨™ç¤ºï¼‰ï¼Œæ­¤è™•æä¾›ä¸‹æ‹‰é¸å–®çš„é¸é …ï¼Œç”¨æ›è¡Œç¬¦ \`\\n\` åˆ†éš”ã€‚å¦‚æœæ²’æœ‰ï¼Œå‰‡ç•™ç©ºã€‚
- \`optionsLabel\`: (å­—ä¸²) å¦‚æœ \`options\` æœ‰å…§å®¹ï¼Œæ­¤è™•æä¾›ä¸‹æ‹‰é¸å–®çš„æè¿°æ–‡å­—ï¼Œä¾‹å¦‚ "æå¯«å°è±¡"ã€"ä¿®è¾­æ‰‹æ³•"ã€‚å¦‚æœæ²’æœ‰ï¼Œå‰‡ç•™ç©ºã€‚

## JSON Object Example:
\`\`\`json
{
  "id": "ai_gen_abc123",
  "category": "å–æèˆ‡åˆ»ç•«",
  "type": "problem",
  "title": "äººç‰©æå¯«æ¬ ç«‹é«”",
  "strengthSummary": "",
  "problemCore": "å°[é¸é …]çš„æå¯«è¼ƒç‚ºå–®ä¸€ï¼Œæœªèƒ½å±•ç¾å…¶è¤‡é›œæ€§ã€‚",
  "suggestion": "å¯å˜—è©¦åŠ å…¥äººç‰©çš„å¿ƒç†æ´»å‹•æˆ–çŸ›ç›¾æ™æ‰ï¼Œä½¿å½¢è±¡æ›´é£½æ»¿ã€‚",
  "example": "ä¾‹å¦‚ï¼Œå¯«ä¸€ä½åš´å²çš„è€å¸«ï¼Œé™¤äº†æå¯«ä»–è²¬ç½µå­¸ç”Ÿï¼Œä¹Ÿå¯ä»¥åŠ å…¥ä»–ç§ä¸‹é—œå¿ƒå­¸ç”Ÿçš„ç´°ç¯€ï¼Œå½¢æˆå°æ¯”ã€‚",
  "options": "ä¸»è§’\\né…è§’\\nè€å¸«",
  "optionsLabel": "æå¯«äººç‰©"
}
\`\`\`

è«‹ç¾åœ¨ç‚ºé¡Œç›®ã€Œ${topic}ã€ç”Ÿæˆ ${totalCountText} æ¢è©•èªçš„ JSON é™£åˆ—ã€‚
`;
    document.getElementById('ai-prompt-preview').value = prompt.trim();
}

function applyAIJson() {
    const jsonInput = document.getElementById('ai-json-input').value.trim();
    if (!jsonInput) {
        alert('è«‹å…ˆå°‡å¾ AI ç²å–çš„ JSON å…§å®¹è²¼åˆ°è¼¸å…¥æ¡†ä¸­ã€‚');
        return;
    }

    let importedData;
    try {
        importedData = JSON.parse(jsonInput);
    } catch (e) {
        alert(`JSON æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æã€‚è«‹ç¢ºä¿æ‚¨è¤‡è£½äº†å®Œæ•´çš„ JSON é™£åˆ—å…§å®¹ï¼ˆç”± [ é–‹å§‹ï¼Œåˆ° ] çµæŸï¼‰ã€‚\n\néŒ¯èª¤è¨Šæ¯ï¼š${e.message}`);
        return;
    }

    let critiquesToImport = [];
    if (Array.isArray(importedData)) {
        critiquesToImport = importedData;
    } else {
        alert('å°å…¥å¤±æ•—ï¼šå…§å®¹ä¸æ˜¯ä¸€å€‹æœ‰æ•ˆçš„ JSON é™£åˆ—ã€‚');
        return;
    }

    if (critiquesToImport.length === 0) {
        alert('å°å…¥çš„è³‡æ–™ç‚ºç©ºé™£åˆ—ï¼Œè©•èªåº«æœªä½œæ›´æ”¹ã€‚');
        return;
    }

    const firstItem = critiquesToImport[0];
    const requiredKeys = ['id', 'category', 'type', 'title'];
    const missingKeys = requiredKeys.filter(key => !(key in firstItem));

    if (missingKeys.length > 0) {
        alert(`å°å…¥å¤±æ•—ï¼šJSON ç‰©ä»¶ä¸­ç¼ºå°‘å¿…è¦çš„æ¬„ä½ï¼š${missingKeys.join(', ')}ã€‚\nè«‹æª¢æŸ¥ AI çš„å›è¦†æ˜¯å¦ç¬¦åˆæ ¼å¼è¦æ±‚ã€‚`);
        return;
    }

    confirmUI(`å³å°‡ä½¿ç”¨ ${critiquesToImport.length} æ¢æ–°è©•èªå®Œå…¨è¦†è“‹ç¾æœ‰çš„è©•èªåº«ã€‚æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`, () => {
        applyImportedData({ items: critiquesToImport });
        buildOverviewPage();
        buildChecklist();
        updateAllOutputs();
        showPage('page2'); 
        alert('è©•èªåº«å·²æˆåŠŸæ›´æ–°ï¼');
        document.getElementById('ai-json-input').value = ''; 
    });
}

/* ---------------- ç¬¬å…­é ï¼šAI ç”Ÿæˆå›é¥‹ (æ–°ç‰ˆ) ---------------- */

function exportStudentDataForAI() {
  if (!checkXlsxLibrary()) return;
  const savedRecords = allStudentRecords.filter(r => r.data);
  if (savedRecords.length === 0) {
    alert('æ²’æœ‰ä»»ä½•å·²å„²å­˜çš„å­¸ç”Ÿè¨˜éŒ„å¯ä¾›åŒ¯å‡ºã€‚');
    return;
  }
  
  savedRecords.sort((a, b) => (a.number || 999) - (b.number || 999));

  const dataToExport = savedRecords.map(record => {
    const s = record.data.scores;
    return {
      'å­¸è™Ÿ': record.number,
      'å§“å': record.name,
      'å…§å®¹': s.content, 'è¡¨é”': s.expression, 'çµæ§‹': s.structure, 'æ¨™é»': s.punctuation, 'éŒ¯åˆ¥å­—': s.typos,
      'ç¸½åˆ†': s.total,
      'å­¸ç”Ÿç‰ˆè©•èª': record.data.pureStudentComment,
    };
  });

  const ws = XLSX.utils.json_to_sheet(dataToExport);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'å­¸ç”Ÿè©•èªè³‡æ–™');
  const filename = `å…¨ç­è©•èªè³‡æ–™_ä¾›AIåˆ†æ_${getDateTimeString()}.xlsx`;
  XLSX.writeFile(wb, filename);
  alert(`ä¾› AI åˆ†æçš„ Excel æª”æ¡ˆå·²æˆåŠŸå°å‡ºç‚º ${filename}ï¼`);
}

function generateFeedbackPromptV2() {
  const analysisData = getAnalysisData();
  const topic = document.getElementById('topic').value.trim();
  const className = (allStudentRecords.find(r => r.data)?.data.class) || 'æœªæŒ‡å®šç­åˆ¥';
  const studentLevelSelect = document.getElementById('ai-student-level');
  const studentLevel = studentLevelSelect.options[studentLevelSelect.selectedIndex].text;
  
  if (!topic) {
    alert('è«‹å…ˆåœ¨ç¬¬ä¸€é å¡«å¯«ã€Œä½œæ–‡é¡Œç›®ã€ã€‚');
    showPage('page1');
    document.getElementById('topic').focus();
    return;
  }
  if (!analysisData && (document.getElementById('ai-source-stats').checked || document.getElementById('ai-source-excel').checked)) {
    alert('ç›®å‰å°šæœªæœ‰å·²å„²å­˜çš„å­¸ç”Ÿè©•èªï¼Œç„¡æ³•ç”ŸæˆåŒ…å«æ•¸æ“šåˆ†æçš„ Promptã€‚');
    return;
  }

  const modules = {
    classOverview: document.getElementById('ai-module-overview').checked,
    topicAnalysis: document.getElementById('ai-module-topic').checked,
    materialAndThemeExamples: document.getElementById('ai-module-material-theme').checked,
    excellentStudents: document.getElementById('ai-module-excellent-students').checked,
    workTiers: document.getElementById('ai-module-tiers').checked,
    writingPractices: document.getElementById('ai-module-practice').checked,
    teachingPlan: document.getElementById('ai-module-plan').checked,
  };
  const extraHints = document.getElementById('ai-feedback-extra-hints').value.trim();
  const requestedModules = Object.entries(modules).filter(([,v]) => v).map(([k]) => k);
  if (requestedModules.length === 0) {
    alert('è«‹è‡³å°‘å‹¾é¸ä¸€é …ã€Œè«‹ AI ç”Ÿæˆçš„å›é¥‹æ¨¡çµ„ã€ã€‚');
    return;
  }

  let prompt = `# Role and Goal
ä½ æ˜¯ä¸€ä½è³‡æ·±çš„é¦™æ¸¯ä¸­å­¸ä¸­æ–‡ç§‘è€å¸«ï¼Œç¾æ­£ç‚ºå…¨ç­åŒå­¸å°±æœ€è¿‘ä¸€æ¬¡çš„ä½œæ–‡ç·´ç¿’æ’°å¯«ä¸€ä»½ç¶œåˆæ€§çš„å›é¥‹æ–‡ä»¶ã€‚ä½ çš„ç›®æ¨™æ˜¯æ ¹æ“šæˆ‘æä¾›çš„å…¨ç­æ•´é«”è¡¨ç¾æ•¸æ“šï¼Œç”Ÿæˆä¸€å€‹çµæ§‹åŒ–çš„ JSON ç‰©ä»¶ï¼Œè©²ç‰©ä»¶çš„å…§å®¹å°‡ç”¨æ–¼ç”¢ç”Ÿå…©ä»½ Word æ–‡ä»¶ï¼šä¸€ä»½çµ¦è€å¸«çš„è©³ç´°æ•™å­¸ææ–™ï¼Œå¦ä¸€ä»½çµ¦å­¸ç”Ÿçš„ç°¡æ˜å›é¥‹å–®å¼µã€‚

# Persona
- æ•™å­¸é¢¨æ ¼ï¼šå°ˆæ¥­ã€æº«å’Œã€å…·é¼“å‹µæ€§ã€å±¤æ¬¡åˆ†æ˜ã€‚
- èªè¨€ï¼šä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œé¦™æ¸¯æ…£ç”¨è©å½™ã€‚
- å°ˆé•·ï¼šåˆ†æå­¸ç”Ÿå¯«ä½œçš„å…±æ€§å•é¡Œï¼Œä¸¦æä¾›æ¸…æ™°çš„æ•™å­¸æŒ‡å°å’Œåˆ†å±¤æ¬¡çš„ææ–™ã€‚

# Context: Class Performance Data
- ä½œæ–‡é¡Œç›®ï¼šã€Œ${topic}ã€
- ç­åˆ¥ï¼š${className}
- å­¸ç”Ÿç´šåˆ¥ï¼š${studentLevel}
`;

  if (document.getElementById('ai-source-excel').checked) {
    prompt += `- å…¨ç­è©³ç´°è¡¨ç¾ï¼šæˆ‘å·²ä¸Šå‚³åç‚ºã€Œå…¨ç­è©•èªè³‡æ–™_ä¾›AIåˆ†æ.xlsxã€çš„æª”æ¡ˆï¼Œå…¶ä¸­åŒ…å«æ¯ä½å­¸ç”Ÿçš„åˆ†æ•¸å’Œè©•èªã€‚è«‹å‹™å¿…è©³ç´°åˆ†ææ­¤æª”æ¡ˆï¼Œä»¥äº†è§£å­¸ç”Ÿçš„å…·é«”è¡¨ç¾ï¼Œä¸¦å¾ä¸­æŠ½å–åŒ¿åç¤ºä¾‹ã€‚\n`;
  }
  if (document.getElementById('ai-module-excellent-students').checked) {
    prompt += `- å„ªç§€åŒå­¸åå–®ï¼šè«‹å¾ Excel ä¸­é¸å–åˆ†æ•¸è¼ƒé«˜çš„åŒå­¸ï¼Œä½œç‚ºã€Œå„ªç§€åŒå­¸ç‰¹é»ã€çš„ä¾‹å­ã€‚å¦‚æœ Excel æª”æ¡ˆä¸­æ²’æœ‰å…·é«”å§“åï¼Œè«‹ä½¿ç”¨ã€Œé™³åŒå­¸ã€ã€ã€ŒæåŒå­¸ã€ç­‰é€šç”¨ç¨±è¬‚ã€‚\n`;
  }
  if (analysisData && document.getElementById('ai-source-stats').checked) {
    const scoreText = analysisData.scoreSummary.map(s => `- ${s.æŒ‡æ¨™}ï¼š${s.å¹³å‡åˆ† != null ? s.å¹³å‡åˆ†.toFixed(2) : 'N/A'}`).join('\n');
    const topCritiquesText = analysisData.topEntries.map(t => `- "${t.è©•èªæ¨™é¡Œ}" (å‡ºç¾ ${t.è¢«é¸æ¬¡æ•¸} æ¬¡)`).join('\n');
    prompt += `- ç³»çµ±æ•¸æ“šæ‘˜è¦ï¼š\n`;
    prompt += `  - å·²æ‰¹æ”¹ä½œå“æ•¸é‡ï¼š${analysisData.studentCount}\n`;
    prompt += `  - å…¨ç­åˆ†æ•¸å¹³å‡å€¼ï¼š\n${scoreText.replace(/^-/gm, '    -')}\n`;
    prompt += `  - æœ€å¸¸è¦‹çš„è©•èªé …ç›®ï¼š\n${topCritiquesText.replace(/^-/gm, '    -') || '    - (ç„¡)'}\n`;
  }

  prompt += `\n# Core Task
æ ¹æ“šä»¥ä¸Šæ•¸æ“šï¼Œç‚ºä½œæ–‡ã€Œ${topic}ã€æ’°å¯«ä¸€ä»½ç¶œåˆå›é¥‹ã€‚è«‹åš´æ ¼æŒ‰ç…§ä¸‹æ–¹æŒ‡å®šçš„ JSON çµæ§‹å’Œå…§å®¹è¦æ±‚ï¼Œç”Ÿæˆæ‰€æœ‰è¢«è¦æ±‚çš„éƒ¨åˆ†ã€‚

# General Instructions
- å…§å®¹å¿…é ˆåŒæ™‚å…¼é¡§ã€Œè€å¸«ç‰ˆã€å’Œã€Œå­¸ç”Ÿç‰ˆã€çš„éœ€è¦ã€‚
- ã€Œè€å¸«ç‰ˆã€æ‡‰è©³ç´°ã€å°ˆæ¥­ï¼ŒåŒ…å«æ•™å­¸ç­–ç•¥å’Œæ·±å…¥åˆ†æã€‚
- ã€Œå­¸ç”Ÿç‰ˆã€æ‡‰ç°¡æ½”ã€è¦–è¦ºåŒ–ã€å¤šç”¨é»åˆ—ï¼Œèªæ°£è¦ªåˆ‡é¼“å‹µã€‚
- è«‹åœ¨ç”Ÿæˆçš„æ–‡å­—ä¸­ï¼Œä½¿ç”¨ Markdown çš„ \`**æ–‡å­—**\` ä¾†æ¨™ç¤ºç²—é«”ã€‚
- æ‰€æœ‰ç¤ºä¾‹éƒ½æ‡‰åŒ¿ååŒ–ï¼Œä½†å…§å®¹éœ€åæ˜ çœŸå¯¦å­¸ç”Ÿä½œå“çš„æ°´å¹³ã€‚

# Output Format (VERY IMPORTANT)
ä½ çš„å›è¦†å¿…é ˆæ˜¯ã€ä¹Ÿåªèƒ½æ˜¯ä¸€å€‹ JSON ç‰©ä»¶ã€‚ä¸è¦åŒ…å«ä»»ä½• JSON ä»¥å¤–çš„æ–‡å­—ã€è¨»è§£æˆ– markdown èªæ³•ã€‚ç›´æ¥ä»¥ \`{\` é–‹é ­ï¼Œä»¥ \`}\` çµå°¾ã€‚
å¦‚æœæŸå€‹æ¨¡çµ„æœªè¢«è¦æ±‚ç”Ÿæˆï¼Œè«‹å°‡å…¶å€¼è¨­ç‚º \`null\` æˆ–çœç•¥è©²éµã€‚

## JSON çµæ§‹è©³è§£ (è«‹åš´æ ¼éµå®ˆ):
\`\`\`json
{
  "classOverview": {
    "teacherSummary": "(String) **è€å¸«ç‰ˆ**ï¼šå°ˆæ¥­ã€æ·±å…¥åœ°ç¸½çµå…¨ç­è¡¨ç¾ï¼Œåˆ†æçµæ§‹æ€§å¼±é»ã€æ ¸å¿ƒå•é¡ŒåŠæ•™å­¸åˆ‡å…¥é»ã€‚",
    "studentSummary": "(String) **å­¸ç”Ÿç‰ˆ**ï¼šä»¥ã€Œè€å¸«çš„è©±ã€å½¢å¼æ’°å¯«ï¼Œèªæ°£è¦ªåˆ‡é¼“å‹µï¼Œé»å‡ºå…±åŒé€²æ­¥ä¹‹è™•åŠæŒ‘æˆ°ï¼Œä¸¦çµ¦äºˆæ–¹å‘æ€§å»ºè­°ã€‚"
  },
  "topicAnalysis": {
    "keywords": ["(String) é¡Œç›®é—œéµå­—1", "ä¾ä¾ä¸æ¨", "é›¢æ„", "..."],
    "analysisTeacher": "(String) **è€å¸«ç‰ˆ**ï¼šæ·±å…¥çš„å¯©é¡Œèˆ‡ç«‹æ„æ·±åº¦åˆ†æï¼Œå¯ä½¿ç”¨è¡¨æ ¼å½¢å¼çš„æ–‡å­—ï¼ˆç”¨ Tab æˆ–ç©ºæ ¼åˆ†éš”ï¼‰ï¼Œæ¬„ä½åŒ…æ‹¬ï¼šé—œéµè©ã€å¯«ä½œè¦æ±‚ã€å¸¸è¦‹å¼Šç—…ã€é€²éšæ–¹å‘ã€‚",
    "highlightsAndProblems": {
      "highlights": ["(String) å…¨ç­äº®é»1", "æ–‡ç« çµæ§‹æ™®éå®Œæ•´"],
      "problems": [
        { "problem": "è¡Œç¨‹ç´°ç¯€éæ–¼æµæ°´è³¬", "tip": "åˆªæ¸›æ­è»Šã€åƒé£¯ç­‰ç‘£ç¢éç¨‹..." },
        { "problem": "å‹äººå½¢è±¡æ¨¡ç³Š", "tip": "åŠ å…¥æå¯«å‹äººçš„å¤–è²Œã€ç¿’æ…£å‹•ä½œ..." }
      ]
    }
  },
  "materialAndThemeExamples": [
    {
      "theme": "(String) ç«‹æ„æ–¹å‘1ï¼Œå¦‚ï¼šé›¢åˆ¥æ˜¯æˆé•·çš„å‚¬åŒ–åŠ‘ã€‚",
      "material": "(String) å…·é«”é¸æå»ºè­°1ï¼Œå¦‚ï¼šé€éæå¯«é€åˆ¥å¾Œï¼Œä¸»è§’é–‹å§‹ç¨ç«‹è™•ç†ä»¥å¾€ä¾è³´æœ‹å‹å¹«å¿™çš„äº‹ï¼Œä¾†é«”ç¾æˆé•·ã€‚"
    }
  ],
  "excellentStudents": [
    {
      "name": "(String) å„ªç§€åŒå­¸å§“åï¼ˆå¦‚ï¼šé™³åŒå­¸ï¼‰",
      "strength": "(String) è©²åŒå­¸çš„å„ªé»ç¸½çµï¼Œå¦‚ï¼šæå¯«ç´°è†©ï¼Œå–„æ–¼é‹ç”¨æ„Ÿå®˜åˆ»ç•«é›¢æ„ã€‚"
    }
  ],
  "workTiers": {
    "high": {
      "characteristics": ["(String) ä¸Šå“ä½œå“çš„ç‰¹å¾µ1ï¼ˆé»åˆ—å¼ï¼‰", "èƒ½ç´°ç·»æå¯«å‹äººçš„ç¥æ…‹èˆ‡å‹•ä½œ"],
      "sample": "(String) åŒ¿ååŒ–çš„ä¸Šå“ä½œå“ç¤ºä¾‹æ®µè½ã€‚",
      "commentary": "(String) **è€å¸«ç‰ˆ**ï¼šé‡å°è©²ç¤ºä¾‹çš„æ·±å…¥é»è©•ï¼Œåˆ†æå…¶å„ªé»åŠæŠ€å·§ã€‚",
      "selfChecklist": ["(String) ä¾›å­¸ç”Ÿè‡ªè©•çš„å•é¡Œ1", "æˆ‘çš„çµå°¾æ˜¯å¦æ˜‡è¯äº†ä¸»é¡Œï¼Ÿ"]
    },
    "mid": {
      "characteristics": ["(String) ä¸­å“ä½œå“çš„ç‰¹å¾µ1", "æ•˜äº‹å®Œæ•´ï¼Œæƒ…æ„Ÿå°šå¯"],
      "sample": "(String) åŒ¿ååŒ–çš„ä¸­å“ä½œå“ç¤ºä¾‹æ®µè½ã€‚",
      "commentary": "(String) **è€å¸«ç‰ˆ**ï¼šé‡å°è©²ç¤ºä¾‹çš„é»è©•ï¼ŒæŒ‡å‡ºå¯æ”¹å–„ä¹‹è™•ã€‚",
      "selfChecklist": ["(String) ä¾›å­¸ç”Ÿè‡ªè©•çš„å•é¡Œ1", "æˆ‘çš„ã€Œé›£éã€æœ‰æ²’æœ‰å…·é«”çš„ç´°ç¯€æ”¯æŒï¼Ÿ"]
    },
    "low": {
      "characteristics": ["(String) ä¸‹å“ä½œå“çš„ç‰¹å¾µ1", "éæ–¼å´é‡è¡Œç¨‹è¨˜éŒ„"],
      "sample": "(String) åŒ¿ååŒ–çš„ä¸‹å“ä½œå“ç¤ºä¾‹æ®µè½ã€‚",
      "commentary": "(String) **è€å¸«ç‰ˆ**ï¼šé‡å°è©²ç¤ºä¾‹çš„é»è©•ï¼Œé»å‡ºåŸºæœ¬å•é¡ŒåŠä¿®æ­£æ–¹å‘ã€‚",
      "selfChecklist": ["(String) ä¾›å­¸ç”Ÿè‡ªè©•çš„å•é¡Œ1", "æˆ‘æ˜¯å¦å¯«äº†å¾ˆå¤šèˆ‡ã€Œé€åˆ¥ã€ç„¡é—œçš„ç‘£äº‹ï¼Ÿ"]
    }
  },
  "teachingPlan": {
    "objectives": ["(String) æœ¬æ¬¡è·Ÿé€²æ•™å­¸çš„å­¸ç¿’ç›®æ¨™1", "..."],
    "activities": [
      { "name": "(String) æ´»å‹•åç¨±1", "description": "(String) æ´»å‹•è©³ç´°æè¿°", "duration": "(String) é è¨ˆæ™‚é–“" }
    ],
    "remedialStrategies": ["(String) é‡å°èƒ½åŠ›ç¨éœå­¸ç”Ÿçš„è£œåº•ç­–ç•¥1", "..."],
    "extensionActivities": ["(String) çµ¦èƒ½åŠ›è¼ƒä½³å­¸ç”Ÿçš„å»¶ä¼¸æŒ‘æˆ°1", "..."]
  },
  "writingPractices": [
    {
      "prompt": "(String) **ç·´ç¿’ä¸€** çš„é¡Œç›®ã€‚",
      "guidelines": ["(String) ç·´ç¿’ä¸€çš„å¯«ä½œæŒ‡å¼•1ï¼ˆé»åˆ—å¼ï¼‰", "..."],
      "modelAnswer": "(String) ç·´ç¿’ä¸€çš„åƒè€ƒç¤ºä¾‹ç­”æ¡ˆã€‚",
      "commentary": "(String, Optional) **è€å¸«ç‰ˆ**ï¼šå°ç·´ç¿’ä¸€ç¤ºä¾‹çš„ç°¡è¦é»è©•ã€‚"
    },
    {
      "prompt": "(String) **ç·´ç¿’äºŒ** çš„é¡Œç›®ã€‚",
      "guidelines": ["(String) ç·´ç¿’äºŒçš„å¯«ä½œæŒ‡å¼•1ï¼ˆé»åˆ—å¼ï¼‰", "..."],
      "modelAnswer": "(String) ç·´ç¿’äºŒçš„åƒè€ƒç¤ºä¾‹ç­”æ¡ˆã€‚",
      "commentary": "(String, Optional) **è€å¸«ç‰ˆ**ï¼šå°ç·´ç¿’äºŒç¤ºä¾‹çš„ç°¡è¦é»è©•ã€‚"
    }
  ]
}
\`\`\`
${extraHints ? `\n# é¡å¤–æç¤º\n${extraHints}\n` : ''}
è«‹ç¾åœ¨é–‹å§‹ç”Ÿæˆã€‚`;
  
  document.getElementById('ai-feedback-prompt-preview').value = prompt.trim();
}

function _getAIFeedbackData() {
  const jsonInput = document.getElementById('ai-feedback-json-input').value.trim();
  if (!jsonInput) {
    alert('è«‹å…ˆå°‡å¾ AI ç²å–çš„ JSON å…§å®¹è²¼åˆ°è¼¸å…¥æ¡†ä¸­ã€‚');
    return null;
  }

  let aiData;
  try {
    aiData = JSON.parse(jsonInput);
  } catch (e) {
    alert(`JSON æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æã€‚è«‹ç¢ºä¿æ‚¨è¤‡è£½äº†å®Œæ•´çš„ JSON ç‰©ä»¶å…§å®¹ï¼ˆç”± { é–‹å§‹ï¼Œåˆ° } çµæŸï¼‰ã€‚\n\néŒ¯èª¤è¨Šæ¯ï¼š${e.message}`);
    return null;
  }

  if (typeof aiData !== 'object' || aiData === null || Array.isArray(aiData)) {
    alert('å°å…¥å¤±æ•—ï¼šå…§å®¹ä¸æ˜¯ä¸€å€‹æœ‰æ•ˆçš„ JSON ç‰©ä»¶ã€‚');
    return null;
  }
  
  return aiData;
}

function generateTeacherWord() {
    const aiData = _getAIFeedbackData();
    if (!aiData) return;

    const analysisData = getAnalysisData();
    const topic = document.getElementById('topic').value.trim() || 'æœªå‘½åæ–‡ç« ';
    const className = (allStudentRecords.find(r => r.data)?.data.class) || 'æœªæŒ‡å®šç­åˆ¥';
    const today = new Date();
    const dateStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;

    let content = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office"
              xmlns:w="urn:schemas-microsoft-com:office:word"
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="utf-8" />
          <title>ä½œæ–‡å›é¥‹ (è€å¸«ç‰ˆ) - ${escapeHtmlAttr(topic)}</title>
          <style>
            body { font-family: Calibri, 'Microsoft JhengHei', sans-serif; font-size: 11pt; line-height: 1.8; }
            h1 { font-size: 20pt; text-align: center; font-weight: bold; color: #2F5496; margin-bottom: 0; }
            h2 { font-size: 16pt; font-weight: bold; border-bottom: 2.5px solid #4472C4; padding-bottom: 6pt; margin-top: 28pt; color: #2F5496; }
            h3 { font-size: 14pt; font-weight: bold; margin-top: 20pt; color: #365F91; border-left: 5px solid #5B9BD5; padding-left: 10pt;}
            h4 { font-size: 12pt; font-weight: bold; color: #333; margin-bottom: 4pt; }
            .meta-info { text-align: center; margin-bottom: 24pt; font-size: 11pt; color: #555; }
            .sample-box { border: 1px solid #5B9BD5; padding: 12pt; margin: 12pt 0; border-radius: 4px; background: #F7F9FC; }
            .commentary-box { border: 1.5px dashed #C00000; padding: 12pt; margin-top: 8pt; border-radius: 4px; background: #FFF9F9;}
            table { border-collapse: collapse; width: 100%; margin: 12pt 0; font-size: 10.5pt; }
            th, td { border: 1px solid #888; padding: 8pt; text-align: left; vertical-align: top; }
            th { font-weight: bold; background: #EAEFF7; }
            ul, ol { padding-left: 28pt; margin-top: 5pt; margin-bottom: 5pt; }
            li { margin-bottom: 6pt; }
            p { margin-top: 0; margin-bottom: 8pt; }
            b, strong { font-weight: bold; }
          </style>
        </head>
        <body>
          <h1>ä½œæ–‡ç·´ç¿’ç¶œåˆå›é¥‹ (è€å¸«ç‰ˆ)</h1>
          <div class="meta-info">
            <p><b>é¡Œç›®ï¼š</b>${escapeHtml(topic)}<br>
            <b>ç­åˆ¥ï¼š</b>${escapeHtml(className)}<br>
            <b>æ—¥æœŸï¼š</b>${dateStr}</p>
          </div>
    `;

    // 1. æ•¸æ“šåˆ†æ
    if (analysisData) {
        content += buildAnalysisWordHtmlSection(analysisData);
    }

    // 2. ç¸½é«”æ¦‚è¦½
    if (aiData.classOverview && aiData.classOverview.teacherSummary) {
        content += `<h2>äºŒã€å…¨ç­æ¦‚æ³ç¸½çµ (æ•™å¸«è¦–è§’)</h2>${textToWordHtmlWithLists(aiData.classOverview.teacherSummary)}`;
    }

    // 3. å¯©é¡Œç«‹æ„
    if (aiData.topicAnalysis && aiData.topicAnalysis.analysisTeacher) {
        content += `<h2>ä¸‰ã€å¯©é¡Œèˆ‡ç«‹æ„æ·±åº¦åˆ†æ</h2>${textToWordHtmlWithLists(aiData.topicAnalysis.analysisTeacher)}`;
    }
    
    // 4. ç«‹æ„é¸æèˆ‰éš…
    if (aiData.materialAndThemeExamples && aiData.materialAndThemeExamples.length > 0) {
        content += `<h2>å››ã€ç«‹æ„é¸æèˆ‰éš…</h2><table><tr><th>ç«‹æ„æ–¹å‘</th><th>å…·é«”é¸æå»ºè­°</th></tr>`;
        aiData.materialAndThemeExamples.forEach(item => {
            content += `<tr><td>${escapeHtml(item.theme)}</td><td>${textToWordHtmlWithLists(item.material)}</td></tr>`;
        });
        content += `</table>`;
    }

    // 5. åˆ†å±¤ä½œå“è¬›è©•
    if (aiData.workTiers) {
        content += `<h2>äº”ã€åˆ†å±¤ä½œå“ç¤ºä¾‹èˆ‡è¬›è©•</h2>`;
        const tiers = { high: 'ä¸Šå“', mid: 'ä¸­å“', low: 'ä¸‹å“' };
        for (const key in tiers) {
            if (aiData.workTiers[key]) {
                const tierData = aiData.workTiers[key];
                content += `<h3>${tiers[key]}ä½œå“åˆ†æ</h3>`;
                if (tierData.characteristics) content += `<h4>ä¸»è¦ç‰¹å¾µï¼š</h4>${arrayToWordHtmlList(tierData.characteristics)}`;
                if (tierData.sample) content += `<h4>ç¤ºä¾‹æ®µè½ï¼š</h4><div class="sample-box">${textToWordHtmlWithLists(tierData.sample)}</div>`;
                if (tierData.commentary) content += `<h4>æ•™å­¸é»è©•ï¼š</h4><div class="commentary-box">${textToWordHtmlWithLists(tierData.commentary)}</div>`;
            }
        }
    }

    // 6. æ•™å­¸è¨ˆåŠƒ
    if (aiData.teachingPlan) {
        content += `<h2>å…­ã€è·Ÿé€²æ•™å­¸è¨ˆåŠƒå»ºè­°</h2>`;
        if (aiData.teachingPlan.objectives) content += `<h3>æ•™å­¸ç›®æ¨™</h3>${arrayToWordHtmlList(aiData.teachingPlan.objectives)}`;
        if (aiData.teachingPlan.activities) {
            content += `<h3>èª²å ‚æ´»å‹•</h3><table><tr><th>æ´»å‹•åç¨±</th><th>æè¿°</th><th>é è¨ˆæ™‚é–“</th></tr>`;
            aiData.teachingPlan.activities.forEach(act => {
                content += `<tr><td>${escapeHtml(act.name)}</td><td>${textToWordHtmlWithLists(act.description)}</td><td>${escapeHtml(act.duration)}</td></tr>`;
            });
            content += `</table>`;
        }
        if (aiData.teachingPlan.remedialStrategies) content += `<h3>è£œåº•ç­–ç•¥</h3>${arrayToWordHtmlList(aiData.teachingPlan.remedialStrategies)}`;
        if (aiData.teachingPlan.extensionActivities) content += `<h3>æ‹”å°–æ´»å‹•</h3>${arrayToWordHtmlList(aiData.teachingPlan.extensionActivities)}`;
    }
    
    // 7. çŸ­å¯«ç·´ç¿’
    if (aiData.writingPractices && aiData.writingPractices.length > 0) {
        content += `<h2>ä¸ƒã€è·Ÿé€²ç·´ç¿’è¨­è¨ˆ</h2>`;
        aiData.writingPractices.forEach((practice, index) => {
            content += `<h3>ç·´ç¿’ ${index + 1}</h3>`;
            if (practice.prompt) content += `<h4>ç·´ç¿’é¡Œç›®</h4><div class="sample-box" style="border-style:dashed;">${textToWordHtmlWithLists(practice.prompt)}</div>`;
            if (practice.guidelines) content += `<h4>å¯«ä½œæŒ‡å¼•</h4>${arrayToWordHtmlList(practice.guidelines)}`;
            if (practice.modelAnswer) content += `<h4>åƒè€ƒç¤ºä¾‹</h4><div class="sample-box">${textToWordHtmlWithLists(practice.modelAnswer)}</div>`;
            if (practice.commentary) content += `<h4>ç¤ºä¾‹é»è©•</h4><div class="commentary-box">${textToWordHtmlWithLists(practice.commentary)}</div>`;
        });
    }

    content += `</body></html>`;

    const fileName = `ä½œæ–‡ç¶œåˆå›é¥‹_è€å¸«ç‰ˆ_${getSanitizedTopicFilename()}_${getDateTimeString()}.doc`;
    downloadFile(fileName, content, 'application/msword;charset=utf-8');
    alert(`è€å¸«ç‰ˆ Word æ–‡ä»¶å·²æˆåŠŸåŒ¯å‡ºï¼š${fileName}`);
}

function generateStudentWord() {
    const aiData = _getAIFeedbackData();
    if (!aiData) return;

    const topic = document.getElementById('topic').value.trim() || 'æœªå‘½åæ–‡ç« ';
    const className = (allStudentRecords.find(r => r.data)?.data.class) || 'æœªæŒ‡å®šç­åˆ¥';
    const today = new Date();
    const dateStr = `${today.getFullYear()}å¹´${(today.getMonth() + 1)}æœˆ${today.getDate()}æ—¥`;

    let content = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office"
              xmlns:w="urn:schemas-microsoft-com:office:word"
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="utf-8" />
          <title>ä½œæ–‡å›é¥‹ (å­¸ç”Ÿç‰ˆ) - ${escapeHtmlAttr(topic)}</title>
          <style>
            body { font-family: 'Microsoft JhengHei UI', 'Segoe UI', sans-serif; font-size: 11pt; line-height: 1.8; }
            h1 { font-size: 18pt; text-align: center; color: #0078D4; font-weight: bold; }
            h2 { font-size: 15pt; border-bottom: 2px solid #AEC6CF; padding-bottom: 5pt; margin-top: 24pt; color: #005A9E; font-weight: bold; }
            h3 { font-size: 13pt; margin-top: 18pt; color: #333; border-left: 4px solid #77DD77; padding-left: 8pt; font-weight: bold;}
            .meta-info { text-align: center; margin-bottom: 24pt; font-size: 10pt; color: #666; }
            .box { border: 1px solid #AEC6CF; padding: 10pt; margin: 10pt 0; border-radius: 8px; background: #F8F9FA; }
            .keyword-box { text-align: center; margin: 12pt 0; padding: 8pt; border: 1px dashed #AEC6CF; border-radius: 8px; }
            .keyword { display: inline-block; border: 1px solid #77DD77; color: #287D28; background: #E9F9E9; padding: 4pt 10pt; margin: 3pt; border-radius: 15px; font-weight: bold; }
            table { border-collapse: collapse; width: 100%; margin: 12pt 0; }
            th, td { border: 1px solid #DCDCDC; padding: 8pt; text-align: left; vertical-align: top; }
            th { background: #F1F3F5; border-bottom: 2px solid #999; font-weight: bold; }
            ul, ol { padding-left: 24pt; margin-top: 4pt; margin-bottom: 4pt; }
            li { margin-bottom: 5pt; }
            p { margin-top: 0; margin-bottom: 6pt; }
            b, strong { font-weight: bold; }
          </style>
        </head>
        <body>
          <h1>ğŸ“ ä½œæ–‡ç·´ç¿’å›é¥‹å–®å¼µ ğŸ“</h1>
          <div class="meta-info">
            <p><b>é¡Œç›®ï¼š</b>${escapeHtml(topic)}<br>
            <b>ç­åˆ¥ï¼š</b>${escapeHtml(className)}<br>
            <b>æ—¥æœŸï¼š</b>${dateStr}</p>
          </div>
    `;

    // 1. è€å¸«çš„è©±
    if (aiData.classOverview && aiData.classOverview.studentSummary) {
        content += `<h2>ä¸€ã€è€å¸«çš„è©±</h2><div class="box">${textToWordHtmlWithLists(aiData.classOverview.studentSummary)}</div>`;
    }

    // 2. å¯«ä½œé‡é»åœ–è§£ (ç¶œåˆ)
    if (aiData.topicAnalysis && aiData.topicAnalysis.highlightsAndProblems) {
        const hp = aiData.topicAnalysis.highlightsAndProblems;
        content += `<h2>äºŒã€å¯«ä½œé‡é»åœ–è§£</h2>`;
        if (aiData.topicAnalysis.keywords && aiData.topicAnalysis.keywords.length > 0) {
            content += `<div class="keyword-box"><b>é¡Œç›®é—œéµå­—ï¼š</b><br>${aiData.topicAnalysis.keywords.map(k => `<span class="keyword">${escapeHtml(k)}</span>`).join(' ')}</div>`;
        }
        content += `<table>`;
        if (hp.highlights && hp.highlights.length > 0) {
            content += `<tr><th>å…¨ç­äº®é»</th><td>${arrayToWordHtmlList(hp.highlights)}</td></tr>`;
        }
        if (hp.problems && hp.problems.length > 0) {
            content += `<tr><th>å¸¸è¦‹å•é¡Œèˆ‡å»ºè­°</th><td>`;
            hp.problems.forEach(p => {
                content += `<p><b>å•é¡Œï¼š</b>${escapeHtml(p.problem)}<br><b>è²¼å£«ï¼š</b>${escapeHtml(p.tip)}</p>`;
            });
            content += `</td></tr>`;
        }
        content += `</table>`;
    }

    // 3. å„ªç§€åŒå­¸ç‰¹é»
    if (aiData.excellentStudents && aiData.excellentStudents.length > 0) {
        content += `<h3>ğŸ‘ å„ªç§€åŒå­¸ç‰¹é»</h3><table><tr><th>åŒå­¸</th><th>å„ªé»</th></tr>`;
        aiData.excellentStudents.forEach(s => {
            content += `<tr><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.strength)}</td></tr>`;
        });
        content += `</table>`;
    }
    
    // 4. ä½œå“é½Šé½Šç‡
    if (aiData.workTiers) {
        content += `<h2>ä¸‰ã€ä½œå“é½Šé½Šç‡</h2><p>æˆ‘å€‘ä¾†çœ‹çœ‹ä¸åŒå±¤æ¬¡çš„ä½œå“ç¤ºä¾‹ï¼Œæ€è€ƒä¸€ä¸‹å¯ä»¥å¦‚ä½•å­¸ç¿’å’Œæ”¹é€²ï¼š</p>`;
        content += `<table><tr><th>å±¤ç´š</th><th>ç‰¹é»åŠç¤ºä¾‹</th><th>è‡ªæˆ‘æª¢æŸ¥æ¸…å–®</th></tr>`;
        const tiers = { high: 'ä¸Šå“ (æƒ…æ™¯äº¤èï¼Œç«‹æ„æ·±åˆ»)', mid: 'ä¸­å“ (æ•˜äº‹å®Œæ•´ï¼Œæƒ…æ„Ÿå°šå¯)', low: 'ä¸‹å“ (æµæ°´ä½œæ¥­ï¼Œå½¢è±¡æ¨¡ç³Š)' };
        for (const key in tiers) {
            if (aiData.workTiers[key]) {
                const tierData = aiData.workTiers[key];
                let characteristicsHtml = tierData.characteristics ? arrayToWordHtmlList(tierData.characteristics) : '';
                let sampleHtml = tierData.sample ? `<br><b>ç¤ºä¾‹ï¼š</b><div class="box" style="margin-left:0; margin-right:0;">${textToWordHtmlWithLists(tierData.sample)}</div>` : '';
                let checklistHtml = tierData.selfChecklist ? arrayToWordHtmlList(tierData.selfChecklist) : '';
                content += `<tr>
                    <td><b>${tiers[key]}</b></td>
                    <td>${characteristicsHtml}${sampleHtml}</td>
                    <td>${checklistHtml}</td>
                </tr>`;
            }
        }
        content += `</table>`;
    }

    // 5. é¸æç«‹æ„èˆ‰éš…
    if (aiData.materialAndThemeExamples && aiData.materialAndThemeExamples.length > 0) {
        content += `<h2>å››ã€é¸æç«‹æ„èˆ‰éš…</h2><table><tr><th>ç«‹æ„æ–¹å‘</th><th>å…·é«”é¸æå»ºè­°</th></tr>`;
        aiData.materialAndThemeExamples.forEach(item => {
            content += `<tr><td>${escapeHtml(item.theme)}</td><td>${textToWordHtmlWithLists(item.material)}</td></tr>`;
        });
        content += `</table>`;
    }
    
    // 6. å‹•ç­†è©¦ä¸€è©¦
    if (aiData.writingPractices && aiData.writingPractices.length > 0) {
        content += `<h2>äº”ã€âœï¸ å‹•ç­†è©¦ä¸€è©¦</h2>`;
        aiData.writingPractices.forEach((practice, index) => {
            content += `<h3>ç·´ç¿’ ${index + 1}</h3>`;
            if (practice.prompt) content += `<h4>ç·´ç¿’é¡Œç›®ï¼š</h4><div class="box" style="border-style:dashed;">${textToWordHtmlWithLists(practice.prompt)}</div>`;
            if (practice.guidelines) content += `<h4>å¯«ä½œæŒ‡å¼•ï¼š</h4>${arrayToWordHtmlList(practice.guidelines)}`;
            if (practice.modelAnswer) content += `<h4>åƒè€ƒç¤ºä¾‹ï¼š</h4><div class="box">${textToWordHtmlWithLists(practice.modelAnswer)}</div>`;
        });
    }

    content += `</body></html>`;

    const fileName = `ä½œæ–‡ç¶œåˆå›é¥‹_å­¸ç”Ÿç‰ˆ_${getSanitizedTopicFilename()}_${getDateTimeString()}.doc`;
    downloadFile(fileName, content, 'application/msword;charset=utf-8');
    alert(`å­¸ç”Ÿç‰ˆ Word æ–‡ä»¶å·²æˆåŠŸåŒ¯å‡ºï¼š${fileName}`);
}


function arrayToWordHtmlList(arr, ordered = false) {
    if (!arr || !Array.isArray(arr) || arr.length === 0) return '';
    const tag = ordered ? 'ol' : 'ul';
    return `<${tag}>${arr.map(item => `<li>${textToWordHtmlWithLists(item)}</li>`).join('')}</${tag}>`;
}

function textToWordHtmlWithLists(text) {
  if (!text) return '';
  
  let processedText = String(text)
      .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

  const lines = processedText.split(/\r?\n/);
  let html = '';
  let inUl = false;
  let inOl = false;

  const flushLists = () => {
    if (inUl) { html += '</ul>'; inUl = false; }
    if (inOl) { html += '</ol>'; inOl = false; }
  };

  for (let line of lines) {
    line = escapeHtml(line.trim()).replace(/&lt;b&gt;/g, '<b>').replace(/&lt;\/b&gt;/g, '</b>');

    if (!line) {
      flushLists();
      html += '<p>&nbsp;</p>';
      continue;
    }

    const isBullet = /^[-â€¢*ï¼]\s+/.test(line);
    const isNumbered = /^\d+[\.\)]\s+/.test(line);

    if (isBullet) {
      if (inOl) flushLists();
      if (!inUl) { html += '<ul>'; inUl = true; }
      html += `<li>${line.replace(/^[-â€¢*ï¼]\s+/, '')}</li>`;
    } else if (isNumbered) {
      if (inUl) flushLists();
      if (!inOl) { html += '<ol>'; inOl = true; }
      html += `<li>${line.replace(/^\d+[\.\)]\s+/, '')}</li>`;
    } else {
      flushLists();
      html += `<p>${line}</p>`;
    }
  }
  flushLists();
  return html.replace(/<p>&nbsp;<\/p>/g, '').replace(/<p><\/p>/g, '');
}


/* ---------------- ç¸½è¦½é  ---------------- */

function setCritiqueData(id, data) {
    const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (!el) return;
    for (const key in data) {
        if (data[key]) {
            el.dataset[key] = data[key];
        } else {
            delete el.dataset[key];
        }
    }
}

function populateCategoryDropdown() {
  const select = document.getElementById('new-critique-category-select');
  const allCritiques = document.querySelectorAll('#critique-data div[data-id]');
  const existingCategories = [...new Set(Array.from(allCritiques).map(el => el.dataset.category))].filter(Boolean);
  
  select.innerHTML = '';
  existingCategories.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    select.appendChild(opt);
  });
  const newOpt = document.createElement('option');
  newOpt.value = '__new__';
  newOpt.textContent = 'æ–°å¢åˆ†é¡...';
  select.appendChild(newOpt);
}

function deleteCritique(id) {
    const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (critiqueEl) {
        critiqueEl.remove();
    }
    buildOverviewPage();
    buildChecklist();
    updateAllOutputs();
}

function buildOverviewPage() {
  const overviewList = document.getElementById('overview-list');
  overviewList.innerHTML = '';
  const allCritiques = document.querySelectorAll('#critique-data div[data-id]');

  populateCategoryDropdown();

  if (allCritiques.length === 0) {
    overviewList.innerHTML = `<div class="empty-state-message">æ‚¨çš„è©•èªåº«ç›®å‰æ˜¯ç©ºçš„ã€‚<br>è«‹ä½¿ç”¨ä¸Šæ–¹çš„ã€Œæ–°å¢è©•èªé …ç›®ã€æˆ–ã€Œå°å…¥ã€åŠŸèƒ½ä¾†å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹è©•èªã€‚</div>`;
    return;
  }

  const critiquesByCategory = {};
  allCritiques.forEach(critiqueEl => {
    const category = critiqueEl.dataset.category || 'æœªåˆ†é¡';
    if (!critiquesByCategory[category]) {
      critiquesByCategory[category] = [];
    }
    critiquesByCategory[category].push(critiqueEl);
  });

  const sortedCategories = Object.keys(critiquesByCategory).sort();

  sortedCategories.forEach(categoryName => {
    const categoryGroup = document.createElement('details');
    categoryGroup.className = 'category-group';
    categoryGroup.open = true;

    const categorySummary = document.createElement('summary');
    categorySummary.innerHTML = `<h3>${categoryName}</h3>`;
    categoryGroup.appendChild(categorySummary);
    
    const categoryContent = document.createElement('div');
    categoryContent.className = 'category-content';

    critiquesByCategory[categoryName].forEach(critiqueEl => {
      const id = critiqueEl.dataset.id;
      const type = critiqueEl.dataset.type;
      const title = critiqueEl.querySelector('h4')?.textContent || critiqueEl.dataset.title || '(ç„¡æ¨™é¡Œ)';
      const optionsRaw = (critiqueEl.dataset.options || '').replace(/,/g, '\n');
      const optionsLabel = critiqueEl.dataset.optionsLabel || '';

      const wrapper = document.createElement('details');
      wrapper.className = `overview-item ${type === 'problem' ? 'is-problem' : 'is-excellent'}`;
      wrapper.open = false;

      const header = document.createElement('summary');
      header.innerHTML = `${title} <span class="badge">${critiqueEl.dataset.category}</span>`;
      wrapper.appendChild(header);

      const body = document.createElement('div');
      body.className = 'overview-body';

      const headerRow = document.createElement('div');
      headerRow.style.cssText = 'display:flex; justify-content:space-between; align-items:flex-end; gap:10px; margin-bottom: 15px;';
      headerRow.innerHTML = `
          <div class="overview-row" style="flex:1; margin-bottom:0;">
              <label>é …ç›®æ¨™é¡Œ</label>
              <input type="text" value="${escapeHtmlAttr(title)}" />
          </div>
          <button class="danger-btn">åˆªé™¤æ­¤é …ç›®</button>
      `;
      const inputTitle = headerRow.querySelector('input');
      const deleteBtn = headerRow.querySelector('button');

      inputTitle.addEventListener('input', () => {
        const h4 = critiqueEl.querySelector('h4');
        if (h4) h4.textContent = inputTitle.value;
        else critiqueEl.dataset.title = inputTitle.value;
        rebuildChecklistAndOutputsDebounced();
        header.innerHTML = `${inputTitle.value} <span class="badge">${critiqueEl.dataset.category}</span>`;
      });
      deleteBtn.onclick = () => confirmUI(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ã€Œ${title}ã€é€™å€‹è©•èªé …ç›®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`, () => deleteCritique(id));

      const fieldsBox = document.createElement('div');
      fieldsBox.className = 'col-box';
      fieldsBox.style.cssText = 'border:1px solid var(--border-color); border-radius:8px; background:#fff; padding:12px;';
      
      const isExcellent = type === 'excellent';
      const problemFieldDisplay = isExcellent ? 'none' : 'block';
      const strengthFieldDisplay = isExcellent ? 'block' : 'none';

      fieldsBox.innerHTML = `
        <h5 style="margin:0 0 8px 0; color:var(--title-color);">ä¾†æºæ¬„ä½</h5>
        <div class="overview-row" style="display:${strengthFieldDisplay};">
          <label>å„ªé»ç¸½çµ</label>
          <textarea data-field="strengthSummary">${critiqueEl.dataset.strengthSummary || ''}</textarea>
        </div>
        <div class="overview-row" style="display:${problemFieldDisplay};">
          <label>å•é¡Œ</label>
          <textarea data-field="problemCore">${critiqueEl.dataset.problemCore || ''}</textarea>
        </div>
        <div class="overview-row" style="display:${problemFieldDisplay};">
          <label>å®œï¼ˆå¯ç”¨ [é¸é …] ä½œç‚ºä¸‹æ‹‰é¸å–®çš„ä½”ä½ç¬¦ï¼‰</label>
          <textarea data-field="suggestion">${critiqueEl.dataset.suggestion || ''}</textarea>
        </div>
        <div class="overview-row">
          <label>ä¾‹å­ï¼ˆæ¯è¡Œä¸€æ¢ï¼‰</label>
          <textarea data-field="example">${(critiqueEl.dataset.example || '').replace(/<p>/g, '').replace(/<\/p>/g, '\n').replace(/ä¾‹ï¼š/g, '')}</textarea>
        </div>
        <div class="overview-row">
          <label>ä¸‹æ‹‰é¸é …çš„æè¿°æ–‡å­—</label>
          <textarea data-field="optionsLabel" placeholder="ä¾‹å¦‚ï¼šå›°é›£æƒ…ç¯€">${optionsLabel}</textarea>
        </div>
        <div class="overview-row">
          <label>ä¸‹æ‹‰é¸é … (æ¯è¡Œä¸€é …ï¼Œç•™ç©ºå‰‡ç„¡)</label>
          <textarea data-field="options" placeholder="å¤©æ°£çªè®Š&#10;é«”åŠ›é€æ”¯&#10;å…¶ä»–">${optionsRaw}</textarea>
        </div>
      `;

      body.appendChild(headerRow);
      body.appendChild(fieldsBox);

      fieldsBox.querySelectorAll('textarea[data-field]').forEach(ta => {
        ta.addEventListener('input', () => {
          const field = ta.dataset.field;
          const payload = {};
          payload[field] = ta.value;
          setCritiqueData(id, payload);
          rebuildChecklistAndOutputsDebounced();
        });
      });

      wrapper.appendChild(body);
      categoryContent.appendChild(wrapper);
    });

    categoryGroup.appendChild(categoryContent);
    overviewList.appendChild(categoryGroup);
  });
}

function escapeHtmlAttr(s) {
  return (s || '').toString().replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

let rebuildTimer = null;
function rebuildChecklistAndOutputsDebounced() {
  clearTimeout(rebuildTimer);
  rebuildTimer = setTimeout(() => {
    buildChecklist();
    updateAllOutputs();
  }, 120);
}

function bindOverviewEvents() {
  document.getElementById('import-critique-excel').addEventListener('change', handleCritiqueImportExcel);
  document.getElementById('import-critique-json').addEventListener('change', handleCritiqueImportJSON);

  document.querySelectorAll('input[name="new-critique-type"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      document.querySelectorAll('#new-critique-fields [data-type-scope]').forEach(el => {
        el.style.display = 'none';
      });
      document.querySelectorAll(`#new-critique-fields [data-type-scope="${e.target.value}"]`).forEach(el => {
        el.style.display = 'block';
      });
    });
  });

  document.getElementById('new-critique-category-select').addEventListener('change', (e) => {
    const wrapper = document.getElementById('new-critique-category-new-wrapper');
    wrapper.style.display = e.target.value === '__new__' ? 'block' : 'none';
  });
}

function addNewCritique() {
  const title = document.getElementById('new-critique-title').value.trim();
  const type = document.querySelector('input[name="new-critique-type"]:checked').value;
  
  const categorySelect = document.getElementById('new-critique-category-select');
  let category = categorySelect.value;
  if (category === '__new__') {
    category = document.getElementById('new-critique-category-new').value.trim();
  }

  if (!title || !category) {
    alert('ã€Œè©•èªæ¨™é¡Œã€å’Œã€Œç¯„ç–‡åˆ†é¡ã€ç‚ºå¿…å¡«é …ç›®ã€‚');
    return;
  }

  const newId = 'custom_' + Date.now();
  const dataContainer = document.getElementById('critique-data');
  const newCritiqueDiv = document.createElement('div');
  
  newCritiqueDiv.dataset.id = newId;
  newCritiqueDiv.dataset.type = type;
  newCritiqueDiv.dataset.category = category;

  const h4 = document.createElement('h4');
  h4.textContent = title;
  newCritiqueDiv.appendChild(h4);

  document.querySelectorAll('#new-critique-fields textarea[data-field]').forEach(ta => {
    const field = ta.dataset.field;
    if (ta.value.trim()) {
      newCritiqueDiv.dataset[field] = ta.value.trim();
    }
  });
  
  dataContainer.appendChild(newCritiqueDiv);

  document.getElementById('new-critique-title').value = '';
  document.getElementById('new-critique-category-new').value = '';
  document.querySelectorAll('#new-critique-fields textarea').forEach(ta => ta.value = '');
  document.getElementById('add-critique-section').open = false;

  buildOverviewPage();
  buildChecklist();
  updateAllOutputs();

  alert('æ–°è©•èªé …ç›®å·²æˆåŠŸæ–°å¢ï¼');
}

function collectExportData() {
  const items = [];
  document.querySelectorAll('#critique-data div[data-id]').forEach(el => {
    items.push({
      id: el.dataset.id,
      category: el.dataset.category,
      type: el.dataset.type,
      title: el.querySelector('h4')?.textContent || el.dataset.title || '',
      strengthSummary: el.dataset.strengthSummary || '',
      problemCore: el.dataset.problemCore || '',
      suggestion: el.dataset.suggestion || '',
      example: el.dataset.example || '',
      options: el.dataset.options || '',
      optionsLabel: el.dataset.optionsLabel || '',
    });
  });
  return items;
}

function applyImportedData(data) {
  if (Array.isArray(data)) { 
    data = { items: data };
  }
  if (Array.isArray(data.items)) {
    const dataContainer = document.getElementById('critique-data');
    dataContainer.innerHTML = '';
    
    data.items.forEach(item => {
        const div = document.createElement('div');
        div.dataset.id = item.id || `imported_${Date.now()}_${Math.random()}`;
        div.dataset.category = item.category || 'æœªåˆ†é¡';
        div.dataset.type = item.type;
        if(item.strengthSummary) div.dataset.strengthSummary = item.strengthSummary;
        if(item.problemCore) div.dataset.problemCore = item.problemCore;
        if(item.suggestion) div.dataset.suggestion = item.suggestion;
        if(item.example) div.dataset.example = item.example;
        if(item.options) div.dataset.options = item.options;
        if(item.optionsLabel) div.dataset.optionsLabel = item.optionsLabel;

        const h4 = document.createElement('h4');
        h4.textContent = item.title || 'ï¼ˆç„¡æ¨™é¡Œï¼‰';
        div.appendChild(h4);

        dataContainer.appendChild(div);
    });
  }
}


function handleManualEdit(which) {
  const ta = which === 'full' ? document.getElementById('full-output') : document.getElementById('student-report-output');
  if (ta) ta.dataset.userEditing = '1';
}

function clearAllCore(doUpdate = true) {
  document.getElementById('unique-comment').value = '';
  ['score-content','score-expression','score-structure','score-punctuation','score-typos','score-total'].forEach(id=>{ const el = document.getElementById(id); if (el) el.value='';});
  currentTypos = [];
  renderTypoList();

  document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(cb => { 
    cb.checked = false; 
    handleCheckboxChange(cb, false); 
  });
  document.querySelectorAll('.editable-comment textarea').forEach(t => t.value = '');

  document.querySelectorAll('#typo-saved-list input[type="checkbox"]').forEach(cb => {
    cb.checked = false;
  });

  if (doUpdate) {
    renderCommonTyposCheckedState();
    updateAllOutputs();
  }
}

/* ======================================================== */
/* ====== å°å…¥å°å‡ºç›¸é—œåŠŸèƒ½ (Excel & JSON & Word) ====== */
/* ======================================================== */

function getSanitizedTopicFilename() {
    const topic = document.getElementById('topic').value.trim();
    if (!topic) return 'æœªå‘½åæ–‡ç« ';
    return topic.replace(/[\\/:*?"<>|]/g, '').substring(0, 20);
}

function getDateTimeString() {
  const d = new Date();
  const pad = n => n.toString().padStart(2,'0');
  return d.getFullYear().toString() +
         pad(d.getMonth()+1) +
         pad(d.getDate()) + '_' +
         pad(d.getHours()) +
         pad(d.getMinutes()) +
         pad(d.getSeconds());
}

function checkXlsxLibrary() {
    if (typeof XLSX === 'undefined') {
        alert('è™•ç† Excel åŠŸèƒ½åˆå§‹åŒ–å¤±æ•—ã€‚\n\nè«‹æª¢æŸ¥æ‚¨çš„ç¶²çµ¡é€£ç·šæ˜¯å¦æ­£å¸¸ï¼Œç„¶å¾Œé‡æ–°æ•´ç†é é¢ã€‚\næ­¤åŠŸèƒ½éœ€è¦åŠ è¼‰ä¸€å€‹å¤–éƒ¨å‡½å¼åº«(xlsx.js)ã€‚');
        return false;
    }
    return true;
}

function handleFileImport(file, onDataReady) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => onDataReady(e.target.result);
    reader.onerror = (error) => {
        console.error('è®€å–æª”æ¡ˆæ™‚å‡ºéŒ¯:', error);
        alert('è®€å–æª”æ¡ˆå¤±æ•—ï¼');
    };
    reader.readAsText(file, 'UTF-8');
}

function downloadFile(filename, content, mimeType) {
    const base64 = btoa(unescape(encodeURIComponent(content)));
    const dataUri = `data:${mimeType};charset=utf-8;base64,${base64}`;

    const a = document.createElement('a');
    a.href = dataUri;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}


function exportOverviewToExcel() {
    if (!checkXlsxLibrary()) return;

    const savedRecords = allStudentRecords.filter(r => r.data);
    if (savedRecords.length === 0) {
        alert('æ²’æœ‰ä»»ä½•å·²å„²å­˜çš„å­¸ç”Ÿè¨˜éŒ„å¯ä¾›åŒ¯å‡ºã€‚');
        return;
    }
    
    savedRecords.sort((a, b) => {
        if (a.number !== null && b.number !== null) return a.number - b.number;
        if (a.number !== null) return -1;
        if (b.number !== null) return 1;
        return a.name.localeCompare(b.name, 'zh-Hant');
    });

    const firstRecord = savedRecords[0];
    const className = firstRecord.data.class || 'æœªæŒ‡å®šç­åˆ¥';

    const dataToExport = savedRecords.map(record => {
        const s = record.data.scores;
        return {
            'å­¸è™Ÿ': record.number,
            'å§“å': record.name,
            'å…§å®¹è©•åˆ†': s.content,
            'è¡¨é”è©•åˆ†': s.expression,
            'çµæ§‹è©•åˆ†': s.structure,
            'æ¨™é»å­—é«”è©•åˆ†': s.punctuation,
            'éŒ¯åˆ¥å­—åŠ æ¸›åˆ†': s.typos,
            'ç¸½åˆ†': s.total,
            'å·²é¸è©•èªæ¨™é¡Œ': record.data.selectedTitles || '',
            'å®Œæ•´ç‰ˆè©•èª': record.data.pureFullComment,
            'å­¸ç”Ÿç‰ˆè©•èª': record.data.pureStudentComment,
        };
    });

    const wsMain = XLSX.utils.json_to_sheet(dataToExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, wsMain, 'å­¸ç”Ÿè©•èªç¸½è¦½');

    const analysisData = getAnalysisData();
    if (analysisData) {
        const { scoreSummary, topEntries } = analysisData;
        const scoreRows = scoreSummary.map(r => ({
            æŒ‡æ¨™: r.æŒ‡æ¨™,
            å¹³å‡åˆ†: r.å¹³å‡åˆ† == null ? '' : Number(r.å¹³å‡åˆ†.toFixed(2))
        }));
        const wsScore = XLSX.utils.json_to_sheet(scoreRows);
        XLSX.utils.book_append_sheet(wb, wsScore, 'åˆ†æ•¸å¹³å‡');

        const wsTop = XLSX.utils.json_to_sheet(topEntries);
        XLSX.utils.book_append_sheet(wb, wsTop, 'è©•èªTOP10');
    }

    const filename = `å­¸ç”Ÿè©•èªç¸½è¦½-${className}-${getSanitizedTopicFilename()}.xlsx`;
    XLSX.writeFile(wb, filename);
    alert(`å­¸ç”Ÿè©•èªç¸½è¦½å·²æˆåŠŸå°å‡ºç‚º ${filename}ï¼`);
}

function exportOverviewToWord() {
  const records = allStudentRecords.filter(r => r.data);
  if (records.length === 0) {
    alert('æ²’æœ‰ä»»ä½•å·²å„²å­˜çš„å­¸ç”Ÿè¨˜éŒ„å¯ä¾›åŒ¯å‡ºã€‚');
    return;
  }

  records.sort((a, b) => {
    if (a.number !== null && b.number !== null) return a.number - b.number;
    if (a.number !== null) return -1;
    if (b.number !== null) return 1;
    return a.name.localeCompare(b.name, 'zh-Hant');
  });

  const topic = document.getElementById('topic').value.trim() || 'æœªå‘½åæ–‡ç« ';
  const className = records[0].data.class || 'æœªæŒ‡å®šç­åˆ¥';

  let content = `
  <html xmlns:o="urn:schemas-microsoft-com:office:office"
        xmlns:w="urn:schemas-microsoft-com:office:word"
        xmlns="http://www.w3.org/TR/REC-html40">
  <head>
    <meta charset="utf-8" />
    <title>å­¸ç”Ÿè©•èª-${escapeHtmlAttr(topic)}</title>
    <style>
      body { font-family: "PMingLiU","æ–°ç´°æ˜é«”","Microsoft JhengHei",sans-serif; font-size: 11pt; line-height: 1.6; }
      .meta-line { margin: 4pt 0; }
      .section-title { font-weight: bold; margin: 10pt 0 4pt 0; }
      .line { border-top: 1px solid #000; margin: 4pt 0; }
      table.score { border-collapse: collapse; margin: 4pt 0; width: 100%; font-size: 10.5pt; }
      table.score th, table.score td { border: 1px solid #000; padding: 3pt 6pt; text-align: center; }
      .box { border: 1px solid #000; padding: 4pt 6pt; margin: 4pt 0; font-size: 11pt; }
      .student-page { page-break-after: always; }
      ul, ol { margin-top: 0; margin-bottom: 0; padding-left: 24pt; }
      p { margin: 0 0 4pt 0; }
      b, strong { font-weight: bold; }
    </style>
  </head>
  <body>
  `;

  records.forEach((record, idx) => {
    const s = record.data.scores || {};
    const typos = record.data.typos || [];
    const typoLines = buildTypoSectionRaw(typos);
    const pureStudent = record.data.pureStudentComment || '';
    const num = record.number !== null ? String(record.number) : '';

    if (idx > 0) {
      content += `<br style="page-break-before:always" />`;
    }

    content += `
      <div class="student-page">
        <p class="meta-line">é¡Œç›®ï¼š${escapeHtml(topic)}</p>
        <p class="meta-line">ç­åˆ¥ï¼š${escapeHtml(record.data.class || className)}ã€€ã€€å­¸è™Ÿï¼š${escapeHtml(num)}ã€€ã€€å§“åï¼š${escapeHtml(record.name)}</p>
        <p class="section-title">ä¸€ã€åˆ†æ•¸æ¦‚è¦½</p>
        <div class="line"></div>
        <table class="score">
          <tr><th>å…§å®¹</th><th>è¡¨é”</th><th>çµæ§‹</th><th>æ¨™é»</th><th>éŒ¯åˆ¥å­—</th><th>ç¸½åˆ†</th></tr>
          <tr>
            <td>${escapeHtmlAttr(s.content || '')}</td>
            <td>${escapeHtmlAttr(s.expression || '')}</td>
            <td>${escapeHtmlAttr(s.structure || '')}</td>
            <td>${escapeHtmlAttr(s.punctuation || '')}</td>
            <td>${escapeHtmlAttr(s.typos || '')}</td>
            <td><b>${escapeHtmlAttr(s.total || '')}</b></td>
          </tr>
        </table>
        <div class="line"></div>
        <p class="section-title">äºŒã€éŒ¯åˆ¥å­—è¨˜éŒ„</p>
        <div class="box">
    `;

    if (!typoLines.length) {
      content += escapeHtml("æœ¬æ¬¡æ²’æœ‰è¨˜éŒ„éŒ¯åˆ¥å­—ã€‚");
    } else {
      content += '<ul>';
      typoLines.forEach(line => {
        content += `<li>${escapeHtml(line)}</li>`;
      });
      content += '</ul>';
    }

    content += `
        </div>
        <p class="section-title">ä¸‰ã€å›é¥‹</p>
        <div class="box">
          ${textToWordHtmlWithLists(pureStudent || 'â€”')}
        </div>
      </div>
    `;
  });

  content += `</body></html>`;
  
  const fileName = `å­¸ç”Ÿè©•èª_å­¸ç”Ÿç‰ˆ_${getDateTimeString()}.doc`;
  downloadFile(fileName, content, 'application/msword;charset=utf-8');
  alert(`Word æª”å·²æˆåŠŸåŒ¯å‡ºï¼š${fileName}`);
}


function getAnalysisData() {
  const records = allStudentRecords.filter(r => r.data);
  if (!records.length) return null;

  let sumContent=0,sumExpr=0,sumStruct=0,sumPunc=0,sumTypos=0,sumTotal=0;
  let cntContent=0,cntExpr=0,cntStruct=0,cntPunc=0,cntTypos=0,cntTotal=0;
  records.forEach(r=>{
    const s = r.data.scores || {};
    const c = parseFloat(s.content); 
    const e = parseFloat(s.expression);
    const st = parseFloat(s.structure);
    const p = parseFloat(s.punctuation);
    const t = parseFloat(s.typos);
    const tot = parseFloat(s.total);
    if (!isNaN(c)) { sumContent+=c; cntContent++; }
    if (!isNaN(e)) { sumExpr+=e; cntExpr++; }
    if (!isNaN(st)) { sumStruct+=st; cntStruct++; }
    if (!isNaN(p)) { sumPunc+=p; cntPunc++; }
    if (!isNaN(t)) { sumTypos+=t; cntTypos++; }
    if (!isNaN(tot)) { sumTotal+=tot; cntTotal++; }
  });
  const avgFn = (sum,cnt)=> cnt? (sum/cnt) : null;

  const scoreSummary = [
    { æŒ‡æ¨™:'å…§å®¹', å¹³å‡åˆ†: avgFn(sumContent,cntContent) },
    { æŒ‡æ¨™:'è¡¨é”', å¹³å‡åˆ†: avgFn(sumExpr,cntExpr) },
    { æŒ‡æ¨™:'çµæ§‹', å¹³å‡åˆ†: avgFn(sumStruct,cntStruct) },
    { æŒ‡æ¨™:'æ¨™é»åŠå­—é«”', å¹³å‡åˆ†: avgFn(sumPunc,cntPunc) },
    { æŒ‡æ¨™:'éŒ¯åˆ¥å­—åŠ æ¸›åˆ†', å¹³å‡åˆ†: avgFn(sumTypos,cntTypos) },
    { æŒ‡æ¨™:'ç¸½åˆ†', å¹³å‡åˆ†: avgFn(sumTotal,cntTotal) },
  ];

  const freq = {};
  records.forEach(r=>{
    const checked = r.data.checkedCritiques || [];
    const seen = new Set();
    checked.forEach(item=>{
      const title = getCritiqueData(item.id,'title');
      if (!title || seen.has(title)) return;
      seen.add(title);
      freq[title]=(freq[title]||0)+1;
    });
  });
  const topEntries = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,10)
                      .map(([title,count],idx)=>({ æ’å: idx+1, è©•èªæ¨™é¡Œ: title, è¢«é¸æ¬¡æ•¸: count }));

  return { scoreSummary, topEntries, studentCount: records.length };
}

function buildAnalysisWordHtmlSection(analysisData) {
    if (!analysisData) return '';
    const { scoreSummary, topEntries } = analysisData;

    let html = `<h2>ä¸€ã€æ•¸æ“šåˆ†æ (å…¨ç­æ¦‚æ³)</h2>`;
    
    html += `<h3>åˆ†æ•¸æ¦‚è¦½ï¼ˆå¹³å‡å€¼ï¼‰</h3><table><tr><th>æŒ‡æ¨™</th><th>å¹³å‡åˆ†</th></tr>`;
    scoreSummary.forEach(row => {
        html += `<tr><td>${escapeHtml(row.æŒ‡æ¨™)}</td><td style="text-align:center;">${row.å¹³å‡åˆ† != null ? row.å¹³å‡åˆ†.toFixed(2) : '-'}</td></tr>`;
    });
    html += `</table>`;

    html += `<h3>æœ€å¸¸è¦‹è©•èªé …ç›® TOP 10</h3>`;
    if (topEntries.length > 0) {
        html += `<table><tr><th>æ’å</th><th>è©•èªæ¨™é¡Œ</th><th style="text-align:center;">è¢«é¸æ¬¡æ•¸</th></tr>`;
        topEntries.forEach(row => {
            html += `<tr><td style="text-align:center;">${row.æ’å}</td><td>${escapeHtml(row.è©•èªæ¨™é¡Œ)}</td><td style="text-align:center;">${row.è¢«é¸æ¬¡æ•¸}</td></tr>`;
        });
        html += `</table>`;
    } else {
        html += `<p>ï¼ˆæš«ç„¡æ•¸æ“šï¼‰</p>`;
    }
    return html;
}


function exportAnalysisToExcel() {
  if (!checkXlsxLibrary()) return;
  const data = getAnalysisData();
  if (!data) {
    alert('ç›®å‰å°šæœªæœ‰å·²å„²å­˜çš„å­¸ç”Ÿè©•èªï¼Œç„¡æ³•åŒ¯å‡ºåˆ†æã€‚');
    return;
  }
  const wb = XLSX.utils.book_new();
  const scoreRows = data.scoreSummary.map(r=>({
    æŒ‡æ¨™: r.æŒ‡æ¨™,
    å¹³å‡åˆ†: r.å¹³å‡åˆ† == null ? '' : Number(r.å¹³å‡åˆ†.toFixed(2))
  }));
  const wsScore = XLSX.utils.json_to_sheet(scoreRows);
  XLSX.utils.book_append_sheet(wb, wsScore, 'åˆ†æ•¸å¹³å‡');

  const wsTop = XLSX.utils.json_to_sheet(data.topEntries);
  XLSX.utils.book_append_sheet(wb, wsTop, 'è©•èªTOP10');

  const className = (allStudentRecords.find(r=>r.data)?.data.class) || 'æœªæŒ‡å®šç­åˆ¥';
  const filename = `è©•èªåˆ†æ-${className}-${getSanitizedTopicFilename()}.xlsx`;
  XLSX.writeFile(wb, filename);
  alert(`è©•èªåˆ†æå·²æˆåŠŸåŒ¯å‡ºç‚º ${filename}ï¼`);
}

function buildTeachingHintFromAnalysis(data) {
  if (!data) return 'ç›®å‰æ¨£æœ¬è¼ƒå°‘ï¼Œå»ºè­°å¾…æ›´å¤šä½œå“æ‰¹æ”¹å¾Œå†é€²ä¸€æ­¥åˆ†æã€‚';
  let lines = [];
  const avgTotal = data.scoreSummary.find(r=>r.æŒ‡æ¨™==='ç¸½åˆ†')?.å¹³å‡åˆ†;
  if (avgTotal != null) {
    lines.push(`æœ¬ç­å·²æ‰¹æ”¹ä½œå“ ${data.studentCount} ä»½ï¼Œå¹³å‡ç¸½åˆ†ç´„ç‚º ${avgTotal.toFixed(1)} åˆ†ã€‚`);
  }
  const lowOnes = data.scoreSummary
    .filter(r=>r.å¹³å‡åˆ† != null && r.æŒ‡æ¨™!=='ç¸½åˆ†')
    .sort((a,b)=>a.å¹³å‡åˆ† - b.å¹³å‡åˆ†)
    .slice(0,2);
  if (lowOnes.length) {
    const names = lowOnes.map(r=>r.æŒ‡æ¨™).join('ã€');
    lines.push(`åœ¨å„è©•åˆ†é …ç›®ä¸­ï¼Œä»¥ã€Œ${names}ã€çš„å¹³å‡åˆ†æ•¸ç›¸å°è¼ƒä½ï¼Œå¯ä½œç‚ºä¸‹éšæ®µè£œæ•‘æ•™å­¸é‡é»ã€‚`);
  }
  if (data.topEntries.length) {
    const first = data.topEntries[0];
    lines.push(`æœ€å¸¸è¢«å‹¾é¸çš„è©•èªç‚ºã€Œ${first.è©•èªæ¨™é¡Œ}ã€ï¼ˆå…± ${first.è¢«é¸æ¬¡æ•¸} æ¬¡ï¼‰ï¼Œåæ˜ æ­¤ç‚ºæ™®éå•é¡Œæˆ–å„ªé»ï¼Œå€¼å¾—èª²å ‚ä¸Šè·Ÿé€²ã€‚`);
  }
  return lines.join('\n');
}

function exportAnalysisToWord() {
  const data = getAnalysisData();
  if (!data) {
    alert('ç›®å‰å°šæœªæœ‰å·²å„²å­˜çš„å­¸ç”Ÿè©•èªï¼Œç„¡æ³•åŒ¯å‡ºåˆ†æã€‚');
    return;
  }
  const topic = document.getElementById('topic').value.trim() || 'æœªå‘½åæ–‡ç« ';
  const className = (allStudentRecords.find(r=>r.data)?.data.class) || 'æœªæŒ‡å®šç­åˆ¥';
  const hint = buildTeachingHintFromAnalysis(data);

  const today = new Date();
  const dateStr = `${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')}`;

  let content = `
  <html xmlns:o="urn:schemas-microsoft-com:office:office"
        xmlns:w="urn:schemas-microsoft-com:office:word"
        xmlns="http://www.w3.org/TR/REC-html40">
  <head>
    <meta charset="utf-8" />
    <title>è©•èªåˆ†æ-${escapeHtmlAttr(topic)}</title>
    <style>
      body { font-family: "PMingLiU","æ–°ç´°æ˜é«”","Microsoft JhengHei",sans-serif; font-size: 11pt; line-height: 1.6; }
      h1 { font-size: 16pt; margin-bottom: 6pt; }
      h2 { font-size: 14pt; border-bottom: 1px solid #000; padding-bottom: 3pt; margin-top: 15pt;}
      h3 { font-size: 12pt; margin-top: 12pt; }
      .meta-line { margin: 2pt 0; }
      pre { font-family: "PMingLiU","æ–°ç´°æ˜é«”","Microsoft JhengHei",sans-serif; white-space: pre-wrap; border: 1px solid #ccc; padding: 8pt; background: #f9f9f9; }
      table { border-collapse: collapse; width: 100%; margin: 10pt 0; }
      th, td { border: 1px solid #666; padding: 5pt; text-align: left; vertical-align: top; }
      th { background-color: #f2f2f2; }
    </style>
  </head>
  <body>
    <h1>è©•èªåˆ†æå‚™å¿˜</h1>
    <div class="meta-line">ç­åˆ¥ï¼š${escapeHtml(className)}</div>
    <div class="meta-line">é¡Œç›®ï¼š${escapeHtml(topic)}</div>
    <div class="meta-line">æ—¥æœŸï¼š${escapeHtml(dateStr)}</div>
    <div class="meta-line">å·²æ‰¹æ”¹ä½œå“æ•¸ï¼š${data.studentCount}</div>
    ${buildAnalysisWordHtmlSection(data).replace(/<h2>/g, '<h2>').replace(/<h3>/g, '<h3>')}
    <h2>ä¸‰ã€æ•™å­¸æç¤ºï¼ˆè‰ç¨¿ï¼‰</h2>
    <pre>${escapeHtml(hint)}</pre>
  </body>
  </html>
  `;

  const filename = `è©•èªåˆ†æ_${getDateTimeString()}.doc`;
  downloadFile(filename, content, 'application/msword;charset=utf-8');
  alert(`è©•èªåˆ†æ Word æª”å·²æˆåŠŸåŒ¯å‡ºï¼š${filename}`);
}

function downloadStudentListTemplate() {
    if (!checkXlsxLibrary()) return;
    const templateData = [{'å­¸è™Ÿ (å¯é¸)': '1', 'å§“å': 'é™³å¤§æ–‡'},{'å­¸è™Ÿ (å¯é¸)': '2', 'å§“å': 'å¼µå°ç¾'},{'å­¸è™Ÿ (å¯é¸)': '', 'å§“å': 'æå‰æ˜'}];
    const ws = XLSX.utils.json_to_sheet(templateData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'å­¸ç”Ÿåå–®ç¯„æœ¬');
    XLSX.writeFile(wb, 'å­¸ç”Ÿåå–®ç¯„æœ¬.xlsx');
}

function handleStudentListImport(event) {
    if (!checkXlsxLibrary()) return;
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            if (jsonData.length === 0) {
                alert('Excel æª”æ¡ˆç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºã€‚');
                return;
            }

            const studentList = jsonData.map(row => {
                const numKey = Object.keys(row).find(k => /å­¸è™Ÿ|number|no/i.test(k));
                const nameKey = Object.keys(row).find(k => /å§“å|name/i.test(k));
                if (!nameKey) return null;
                const num = numKey ? (row[numKey] || '').toString().trim() : '';
                const name = (row[nameKey] || '').toString().trim();
                if (!name) return null;
                return num ? `${num}-${name}` : name;
            }).filter(Boolean).join('\n');

            const textarea = document.getElementById('student-names');
            textarea.value = studentList;
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            alert(`æˆåŠŸåŒ¯å…¥ ${jsonData.length} ä½å­¸ç”Ÿï¼`);
        } catch (error) {
            alert(`åŒ¯å…¥å­¸ç”Ÿåå–®å¤±æ•—: ${error.message}`);
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsArrayBuffer(file);
}

function downloadCritiqueTemplate() {
    if (!checkXlsxLibrary()) return;
    const templateData = [
        { id: "c1", category: "æ‰£é¡Œèˆ‡ç«‹æ„", type: "excellent", title: "æ‰£é¡Œæº–ç¢ºï¼Œç«‹æ„æ˜ç¢º", strengthSummary: "èƒ½ç·Šæ‰£é¡Œç›®è¦æ±‚ï¼Œç«‹æ„æ˜ç¢ºï¼Œä¸­å¿ƒæ€æƒ³æ¸…æ™°ã€‚", problemCore: "", suggestion: "", example: "æ–‡ç« é¡Œç‚ºã€Œä¸€æ¬¡é›£å¿˜çš„ç¶“æ­·ã€ï¼Œå…§æ–‡ç¢ºå¯¦åœç¹è©²æ¬¡ç¶“æ­·çš„å§‹æœ«èˆ‡æ„Ÿå—æå¯«ï¼Œæ²’æœ‰é›¢é¡Œã€‚", options: "", optionsLabel: "" },
        { id: "c2", category: "æ‰£é¡Œèˆ‡ç«‹æ„", type: "problem", title: "ç«‹æ„è†šæ·º", strengthSummary: "", problemCore: "ç«‹æ„ä¸å¤ æ·±åˆ»ï¼Œæœªèƒ½å¾äº‹ä»¶ä¸­æç…‰å‡ºæ›´æ·±å±¤çš„æ„ç¾©ã€‚", suggestion: "å¯æ€è€ƒäº‹ä»¶èƒŒå¾Œå¸¶ä¾†çš„åæ€æˆ–å•Ÿç™¼ï¼Œæ·±åŒ–ä¸»é¡Œã€‚", example: "åªåœç•™åœ¨ã€Œè¨˜ä¸€æ¬¡æ„‰å¿«çš„æ—…è¡Œã€ï¼Œæœªæ˜‡è¯è‡³ã€Œæ—…è¡Œçš„æ„ç¾©ã€æˆ–ã€Œå€‹äººæˆé•·ã€ç­‰å±¤é¢ã€‚", options: "", optionsLabel: "" },
        { id: "c10", category: "çµæ§‹èˆ‡é‹ªæ’", type: "problem", title: "ç¯‡ç« è½‰æŠ˜ç•¥æ„Ÿçªå…€", strengthSummary: "", problemCore: "æ–‡ç« åœ¨ç”±é€åˆ¥ç¾å ´éæ¸¡è‡³ã€Œå›æ†¶ç‰‡æ®µã€çš„æ®µè½æ™‚ï¼Œæƒ…æ„Ÿè½‰æŠ˜éå¿«ï¼Œç¼ºä¹é‹ªå¢Šã€‚", suggestion: "å¯åŠ ä¸Šä¸€å…©å¥å…§å¿ƒéæ¸¡å¥ï¼Œè®“æƒ…æ„Ÿé€£æ¥æ›´é †æš¢ã€‚", example: "å¯«å®Œé“åˆ¥å ´é¢å¾Œï¼Œå¯åŠ ä¸€å¥ã€Œé‚£å¤©ä¹‹å¾Œï¼Œæˆ‘å¸¸æƒ³èµ·æˆ‘å€‘ä¸€èµ·æ”¾å­¸çš„åˆå¾Œã€ï¼Œè‡ªç„¶å¼•å‡ºå›æ†¶ã€‚", options: "é€åˆ¥ç¾å ´\nå›æ†¶ç‰‡æ®µ", optionsLabel: "è½‰æŠ˜éƒ¨åˆ†" }
    ];
    const ws = XLSX.utils.json_to_sheet(templateData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'è©•èªåº«ç¯„æœ¬');
    XLSX.writeFile(wb, 'è©•èªåº«-ç¯„æœ¬.xlsx');
}

function exportCritiquesToExcel() {
    if (!checkXlsxLibrary()) return;
    const dataToExport = collectExportData();
    if (dataToExport.length === 0) {
        alert('è©•èªåº«ç›®å‰ç‚ºç©ºï¼Œæ²’æœ‰å…§å®¹å¯ä»¥å°å‡ºã€‚');
        return;
    }
    const ws = XLSX.utils.json_to_sheet(dataToExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'è©•èªåº«');
    const filename = `è©•èªåº«-${getSanitizedTopicFilename()}.xlsx`;
    XLSX.writeFile(wb, filename);
    alert(`è©•èªåº«å·²æˆåŠŸå°å‡ºç‚º ${filename}ï¼`);
}

function handleCritiqueImportExcel(event) {
    if (!checkXlsxLibrary()) return;
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            if (jsonData.length > 0) {
                const required = ['category', 'type', 'title'];
                if (!required.every(field => field in jsonData[0])) {
                    alert(`å°å…¥å¤±æ•—ï¼Excel çš„æ¨™é¡Œè¡Œå¿…é ˆåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š\n${required.join(', ')}`);
                    return;
                }
            }
            applyImportedData({ items: jsonData });
            buildOverviewPage();
            buildChecklist();
            updateAllOutputs();
            alert('è©•èªåº«å·²æˆåŠŸå¾ Excel æª”æ¡ˆå°å…¥ï¼');
        } catch (error) {
            alert(`å°å…¥ Excel å¤±æ•—: ${error.message}`);
        }
    };
    reader.readAsArrayBuffer(file);
    event.target.value = '';
}

function exportCritiquesToJSON() {
    const dataToExport = collectExportData();
    if (dataToExport.length === 0) {
        alert('è©•èªåº«ç›®å‰ç‚ºç©ºï¼Œæ²’æœ‰å…§å®¹å¯ä»¥å°å‡ºã€‚');
        return;
    }
    const jsonString = JSON.stringify({ items: dataToExport }, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `è©•èªåº«-${getSanitizedTopicFilename()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert(`è©•èªåº«å·²æˆåŠŸå°å‡ºç‚º JSON æª”æ¡ˆï¼`);
}

function handleCritiqueImportJSON(event) {
    handleFileImport(event.target.files[0], (fileContent) => {
        try {
            const data = JSON.parse(fileContent);
            applyImportedData(data);
            buildOverviewPage();
            buildChecklist();
            updateAllOutputs();
            alert('è©•èªåº«å·²æˆåŠŸå¾ JSON æª”æ¡ˆå°å…¥ï¼');
        } catch (error) {
            alert(`å°å…¥ JSON å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚\néŒ¯èª¤è¨Šæ¯: ${error.message}`);
        }
    });
    event.target.value = '';
}

function downloadTypoTemplate() {
    if (!checkXlsxLibrary()) return;
    const templateData = [ { id: 'typo_1', wrong: 'æƒ…æ³', correct: 'æƒ…æ³' }, { id: 'typo_2', wrong: 'å¾ä½¿', correct: 'å¾äº‹' }, { id: 'typo_3', wrong: '', correct: 'æ¿«ç«½å……æ•¸' } ];
    const ws = XLSX.utils.json_to_sheet(templateData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'éŒ¯åˆ¥å­—åº«ç¯„æœ¬');
    XLSX.writeFile(wb, 'å¸¸è¦‹éŒ¯åˆ¥å­—åº«ç¯„æœ¬.xlsx');
}

function exportCommonTyposToExcel() {
    if (!checkXlsxLibrary()) return;
    if (commonTypos.length === 0) {
        alert('å¸¸è¦‹éŒ¯åˆ¥å­—åº«ç›®å‰ç‚ºç©ºï¼Œæ²’æœ‰å…§å®¹å¯ä»¥å°å‡ºã€‚');
        return;
    }
    const dataToExport = commonTypos.map(t => ({ id: t.id, wrong: t.wrong, correct: t.correct }));
    const ws = XLSX.utils.json_to_sheet(dataToExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'éŒ¯åˆ¥å­—åº«');
    const filename = `å¸¸è¦‹éŒ¯åˆ¥å­—åº«-${getSanitizedTopicFilename()}.xlsx`;
    XLSX.writeFile(wb, filename);
    alert(`å¸¸è¦‹éŒ¯åˆ¥å­—åº«å·²æˆåŠŸå°å‡ºç‚º ${filename}ï¼`);
}

function handleTypoImportExcel(event) {
    if (!checkXlsxLibrary()) return;
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            if (jsonData.length > 0 && !('correct' in jsonData[0])) {
                alert('å°å…¥å¤±æ•—ï¼Excel çš„æ¨™é¡Œè¡Œå¿…é ˆåŒ…å« `correct` æ¬„ä½ã€‚');
                return;
            }
            commonTypos = jsonData
                .map((item, index) => ({
                    id: item.id || `imported_typo_${Date.now()}_${index}`,
                    wrong: (item.wrong || '').toString().trim(),
                    correct: (item.correct || '').toString().trim()
                }))
                .filter(item => item.correct);
            persistCommonTypos(true);
            renderCommonTypoList();
            alert(`å¸¸è¦‹éŒ¯åˆ¥å­—åº«å·²æˆåŠŸå°å…¥ï¼å…±å°å…¥ ${commonTypos.length} æ¢è¨˜éŒ„ã€‚`);
        } catch (error) {
            alert(`å°å…¥ Excel å¤±æ•—: ${error.message}`);
        }
    };
    reader.readAsArrayBuffer(file);
    event.target.value = '';
}

function exportCommonTyposToJSON() {
    if (commonTypos.length === 0) {
        alert('å¸¸è¦‹éŒ¯åˆ¥å­—åº«ç›®å‰ç‚ºç©ºï¼Œæ²’æœ‰å…§å®¹å¯ä»¥å°å‡ºã€‚');
        return;
    }
    const jsonString = JSON.stringify(commonTypos, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `å¸¸è¦‹éŒ¯åˆ¥å­—åº«-${getSanitizedTopicFilename()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert(`å¸¸è¦‹éŒ¯åˆ¥å­—åº«å·²æˆåŠŸå°å‡ºç‚º JSON æª”æ¡ˆï¼`);
}

function handleTypoImportJSON(event) {
    handleFileImport(event.target.files[0], (fileContent) => {
        try {
            const data = JSON.parse(fileContent);
            if (Array.isArray(data)) {
                commonTypos = data
                    .map((item, index) => ({
                        id: item.id || `imported_typo_${Date.now()}_${index}`,
                        wrong: (item.wrong || '').toString().trim(),
                        correct: (item.correct || '').toString().trim()
                    }))
                    .filter(item => item.correct);
                persistCommonTypos(true);
                renderCommonTypoList();
                alert(`å¸¸è¦‹éŒ¯åˆ¥å­—åº«å·²æˆåŠŸå°å…¥ï¼å…±å°å…¥ ${commonTypos.length} æ¢è¨˜éŒ„ã€‚`);
            } else {
                throw new Error("JSON æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰ç‚ºä¸€å€‹é™£åˆ—ã€‚");
            }
        } catch (error) {
            alert(`å°å…¥ JSON å¤±æ•—: ${error.message}`);
        }
    });
    event.target.value = '';
}

function exportProgressToExcel() {
  if (!checkXlsxLibrary()) return;

  if (!allStudentRecords.length) {
    alert('ç›®å‰æ²’æœ‰å­¸ç”Ÿåå–®ï¼Œç„¡æ³•åŒ¯å‡ºé€²åº¦ã€‚');
    return;
  }

  const rows = allStudentRecords.map(r => {
    const d = r.data || {};
    const s = d.scores || {};
    return {
      studentNumber: r.number,
      studentName: r.name,
      originalName: r.originalName,
      class: d.class || '',
      topic: d.topic || '',
      uniqueComment: d.uniqueComment || '',
      scoreContent: s.content || '',
      scoreExpression: s.expression || '',
      scoreStructure: s.structure || '',
      scorePunctuation: s.punctuation || '',
      scoreTypos: s.typos || '',
      scoreTotal: s.total || '',
      typosJSON: JSON.stringify(d.typos || []),
      checkedCritiquesJSON: JSON.stringify(d.checkedCritiques || []),
      selectedTitles: d.selectedTitles || '',
      fullComment: d.fullComment || '',
      studentComment: d.studentComment || '',
      pureFullComment: d.pureFullComment || '',
      pureStudentComment: d.pureStudentComment || ''
    };
  });

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'è©•èªé€²åº¦');
  const filename = `è©•èªé€²åº¦_${getDateTimeString()}.xlsx`;
  XLSX.writeFile(wb, filename);
  alert(`è©•èªé€²åº¦å·²åŒ¯å‡ºç‚º ${filename}`);
}

function handleProgressImportExcel(event) {
  if (!checkXlsxLibrary()) return;
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(sheet);

      if (!jsonData.length) {
        alert('åŒ¯å…¥é€²åº¦å¤±æ•—ï¼šå·¥ä½œè¡¨ç‚ºç©ºã€‚');
        return;
      }

      allStudentRecords = jsonData.map(row => {
        const typos = safeParseJSON(row.typosJSON);
        const checkedCritiques = safeParseJSON(row.checkedCritiquesJSON);
        const scores = {
          content: row.scoreContent,
          expression: row.scoreExpression,
          structure: row.scoreStructure,
          punctuation: row.scorePunctuation,
          typos: row.scoreTypos,
          total: row.scoreTotal
        };
        const dataObj = {
          class: row.class || '',
          topic: row.topic || '',
          uniqueComment: row.uniqueComment || '',
          scores,
          typos: Array.isArray(typos) ? typos : [],
          checkedCritiques: Array.isArray(checkedCritiques) ? checkedCritiques : [],
          selectedTitles: row.selectedTitles || '',
          fullComment: row.fullComment || '',
          studentComment: row.studentComment || '',
          pureFullComment: row.pureFullComment || '',
          pureStudentComment: row.pureStudentComment || ''
        };
        return {
          number: row.studentNumber ?? null,
          name: row.studentName || '',
          originalName: row.originalName || row.studentName || '',
          data: dataObj
        };
      });

      const firstWithData = allStudentRecords.find(r => r.data && (r.data.class || r.data.topic));
      if (firstWithData && firstWithData.data) {
        document.getElementById('student-class').value = firstWithData.data.class || '';
        document.getElementById('topic').value = firstWithData.data.topic || '';
      }

      const lines = allStudentRecords.map(r => {
        return r.number != null && r.number !== '' ? `${r.number}-${r.name}` : r.name;
      });
      document.getElementById('student-names').value = lines.join('\n');
      updateStudentDropdown();

      renderStudentOverviewTable();
      updateAllOutputs();
      alert('è©•èªé€²åº¦å·²æˆåŠŸåŒ¯å…¥ã€‚');

    } catch (err) {
      console.error(err);
      alert('åŒ¯å…¥é€²åº¦å¤±æ•—ï¼š' + err.message);
    } finally {
      event.target.value = '';
    }
  };
  reader.readAsArrayBuffer(file);
}

function safeParseJSON(str) {
  if (!str) return [];
  try {
    const val = JSON.parse(str);
    return val;
  } catch {
    return [];
  }
}

function escapeHtml(text) {
  if (!text && text !== 0) return "";
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}
// ==========================================
  // Supabase é›²ç«¯åŒæ­¥æ¨¡çµ„ (çµ‚æ¥µä¹¾æ·¨ç‰ˆ)
  // ==========================================

  // å…¨åŸŸè®Šæ•¸ï¼šç”¨ä¾†å­˜æ”¾å„²å­˜çš„è¨ˆæ™‚å™¨
  let saveTimeout;

  // 1. å®šç¾©å„²å­˜å‡½æ•¸ (æœ€å„ªå…ˆå®šç¾©ï¼Œç¢ºä¿å…¨åŸŸå¯è¦‹)
  async function saveToCloud() {
    // å–å¾—ç•¶å‰ç”¨æˆ¶
    const { data: { user } } = await supabase.auth.getUser();
    
    // å¦‚æœæ²’ç™»å…¥ï¼Œå°±ä¸åŸ·è¡Œå„²å­˜
    if (!user) return; 

    // é˜²æŠ–å‹•ï¼šæ¸…é™¤ä¹‹å‰çš„æ’ç¨‹
    clearTimeout(saveTimeout);

    // è¨­å®š 1 ç§’å¾ŒåŸ·è¡Œå„²å­˜
    saveTimeout = setTimeout(async () => {
      const updates = {
        id: user.id,
        critiques: critiques,       // ç¢ºä¿é€™äº›å…¨åŸŸè®Šæ•¸åœ¨ä½ çš„åŸä»£ç¢¼ä¸­æœ‰å®šç¾©
        common_typos: commonTypos,
        updated_at: new Date(),
      };

      const { error } = await supabase.from('users_data').upsert(updates);
      
      // æ›´æ–° UI ç‹€æ…‹
      const emailSpan = document.getElementById('user-email');
      if (error) {
        console.error('å„²å­˜å¤±æ•—:', error);
        if(emailSpan) emailSpan.textContent = "âŒ å„²å­˜å¤±æ•—";
      } else {
        console.log('é›²ç«¯å„²å­˜æˆåŠŸ');
        if(emailSpan) {
            const originalText = user.email;
            emailSpan.textContent = "âœ… å·²å„²å­˜";
            // 2ç§’å¾Œè®Šå› Email
            setTimeout(() => { 
                if(document.getElementById('user-email').textContent === "âœ… å·²å„²å­˜") {
                    emailSpan.textContent = originalText; 
                }
            }, 2000);
        }
      }
    }, 1000);
  }

  // 2. è™•ç†ç™»å…¥
  async function login() {
    const email = prompt("è«‹è¼¸å…¥ä½ çš„ Email ä»¥æ¥æ”¶ç™»å…¥é€£çµ (Magic Link):");
    if (!email) return;
    
    const { error } = await supabase.auth.signInWithOtp({
      email: email,
      options: { emailRedirectTo: window.location.href }
    });

    if (error) alert("ç™»å…¥éŒ¯èª¤: " + error.message);
    else alert("ç™»å…¥é€£çµå·²å¯„å‡ºï¼è«‹æª¢æŸ¥ Emailã€‚");
  }

  // 3. è™•ç†ç™»å‡º
  async function logout() {
    await supabase.auth.signOut();
    window.location.reload();
  }

  // 4. å¾é›²ç«¯è¼‰å…¥è³‡æ–™
  async function loadCloudData(userId) {
    if (!userId) return;
    const emailSpan = document.getElementById('user-email');
    if(emailSpan) emailSpan.textContent = "è³‡æ–™åŒæ­¥ä¸­...";

    const { data, error } = await supabase
      .from('users_data')
      .select('critiques, common_typos')
      .eq('id', userId)
      .single();

    if (data) {
      // æ›´æ–°å…¨åŸŸè®Šæ•¸
      if (data.critiques) critiques = data.critiques;
      if (data.common_typos) commonTypos = data.common_typos;
      
      // é‡æ–°æ¸²æŸ“ç•«é¢ (å‘¼å«ä½ åŸæœ¬çš„å‡½æ•¸)
      if (typeof renderCritiqueList === 'function') renderCritiqueList();
      if (typeof renderCommonTypoList === 'function') renderCommonTypoList();
      console.log("é›²ç«¯è³‡æ–™è¼‰å…¥å®Œæˆ");
    }
    
    // æ¢å¾© Email é¡¯ç¤º
    if(emailSpan) {
        const { data: { user } } = await supabase.auth.getUser();
        if(user) emailSpan.textContent = user.email;
    }
  }

  // 5. åˆå§‹åŒ– & ç›£è½å™¨è¨­å®š
  
  // ç¶å®šæŒ‰éˆ•
  const btnLogin = document.getElementById('btn-login');
  const btnLogout = document.getElementById('btn-logout');
  if(btnLogin) btnLogin.addEventListener('click', login);
  if(btnLogout) btnLogout.addEventListener('click', logout);

  // ç›£è½ç™»å…¥ç‹€æ…‹
  supabase.auth.onAuthStateChange(async (event, session) => {
    const user = session?.user;
    const emailSpan = document.getElementById('user-email');

    if (user) {
      // å·²ç™»å…¥
      if(btnLogin) btnLogin.style.display = 'none';
      if(btnLogout) btnLogout.style.display = 'block';
      if(emailSpan) {
        emailSpan.style.display = 'block';
        emailSpan.textContent = user.email;
      }
      await loadCloudData(user.id);
    } else {
      // æœªç™»å…¥
      if(btnLogin) btnLogin.style.display = 'block';
      if(btnLogout) btnLogout.style.display = 'none';
      if(emailSpan) emailSpan.style.display = 'none';
    }
  });

  // 6. å¼·åŠ›è£œä¸ï¼šå…¨åŸŸæ‰“å­—ç›£è½ (æœ€é—œéµçš„ä¸€æ­¥ï¼)
  document.addEventListener('input', function(e) {
     // ä»»ä½•è¼¸å…¥éƒ½è§¸ç™¼å„²å­˜
     saveToCloud();
  });

  // 7. æ””æˆªèˆŠæœ‰çš„ localStorage å„²å­˜ (ä½œç‚ºå‚™ç”¨)
  // ä½¿ç”¨ IIFE (ç«‹å³åŸ·è¡Œå‡½æ•¸) ä¾†é¿å…è®Šæ•¸æ±¡æŸ“
  (function() {
      const originalPersistCritiques = window.persistCritiques;
      const originalPersistCommonTypos = window.persistCommonTypos;

      window.persistCritiques = function() {
        if(typeof originalPersistCritiques === 'function') originalPersistCritiques.apply(this, arguments);
        saveToCloud();
      };

      window.persistCommonTypos = function() {
        if(typeof originalPersistCommonTypos === 'function') originalPersistCommonTypos.apply(this, arguments);
        saveToCloud();
      };
  })();
</script> </body>   </html>   ```

