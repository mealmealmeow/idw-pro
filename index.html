<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æˆ‘ä¸æƒ³åŠªåŠ›äº† - ç¨ç«‹è©•èªåº«ç‰ˆ</title>
  <!-- å¼•å…¥ xlsx.js å‡½å¼åº« -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- å¼•å…¥ Supabase.js å‡½å¼åº« -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- å¼•å…¥ Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC&display=swap" rel="stylesheet">

<style>
  /* --- Pop Art å½ˆçª—æ¨£å¼ --- */
  .pop-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(105, 129, 118, 0.6);
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .pop-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }
  .pop-modal {
    background: #ffffff;
    width: 90%;
    max-width: 500px;
    border-radius: 30px;
    box-shadow: -8px 8px 0px 0px #F2C037; 
    border: 2px solid #F2C037;
    padding: 30px;
    position: relative;
    text-align: center;
    color: #4a4a4a;
    transform: scale(0.95);
    transition: transform 0.2s;
  }
  .pop-overlay.active .pop-modal { transform: scale(1); }
  .pop-icon { font-size: 32px; margin-bottom: 10px; display: block; }
  .pop-modal h3 { margin: 0 0 10px 0; font-size: 1.3rem; color: #333; font-weight: 700; }
  .pop-desc { font-size: 0.95rem; color: #666; margin-bottom: 20px; line-height: 1.5; }
  .pop-scroll-area {
    text-align: left; background: #fffdf5; border-radius: 15px;
    padding: 15px; max-height: 200px; overflow-y: auto;
    margin-bottom: 20px; border: 2px solid #eee;
  }
  .pop-list-item {
    padding: 8px 12px; border-bottom: 1px dashed #ddd;
    font-size: 0.9rem; color: #555; cursor: pointer;
    border-radius: 8px; transition: background 0.2s;
  }
  .pop-list-item:hover { background-color: #fcf4d6; color: #333; }
  .pop-list-item strong { color: #d48806; margin-right: 5px; }
  .pop-input {
    width: 80%; padding: 12px 20px; border: 2px solid #e0e0e0;
    border-radius: 50px; font-size: 16px; outline: none;
    text-align: center; transition: border-color 0.3s;
    font-family: inherit; margin-bottom: 20px; display: block;
    margin-left: auto; margin-right: auto;
  }
  .pop-input:focus { border-color: #F2C037; }
  .pop-footer { display: flex; justify-content: center; gap: 15px; }
  .pop-btn {
    padding: 10px 30px; border: none; border-radius: 50px;
    font-size: 1rem; font-weight: bold; cursor: pointer;
    font-family: inherit; transition: transform 0.1s;
  }
  .pop-btn:active { transform: scale(0.95); }
  .pop-btn-cancel { background: #f0f0f0; color: #888; }
  .pop-btn-confirm { background: #F2C037; color: #fff; box-shadow: 0 4px 10px rgba(242, 192, 55, 0.4); }
  .pop-btn-confirm:hover { background: #e0b132; }

  /* --- åŸæœ‰æ¨£å¼ --- */
  :root {
    --primary-bg: #f7f3eb; --secondary-bg: #fcfaf6; --text-color: #5b5044;
    --border-color: #e1d8c8; --accent-color: #5A8F7B; --accent-color-soft: #cfe3d9;
    --title-color: #3d5c4f; --header-bg: linear-gradient(120deg, #5A8F7B, #93b8a5);
    --nav-bg: #f1ece4; --nav-active-bg: #5A8F7B; --nav-active-color: #fff;
    --problem-color: #c86a5a; --excellent-color: #7a9e78; --copy-success-bg: #5f9f80;
    --modal-bg: rgba(0,0,0,0.28); --modal-card-bg: #fffdf8; --shadow-color: rgba(52, 43, 32, 0.10);
    --btn-brown-bg: #a18b73; --btn-brown-hover: #8f7a63; --dashed-box-bg: #f9fbff;
    --empty-state-bg: #f7f2ea; --empty-state-text: #93897a; --missing-bg: #fff0f0;
    --missing-text: #c86a5a; --danger-bg-soft: #fef2f2; --danger-border-soft: #fecaca;
    --radius-lg: 14px; --radius-md: 10px; --radius-sm: 6px;
    --transition-fast: 0.18s ease-out; --transition-normal: 0.25s ease-out;
  }
  html { scroll-behavior: smooth; font-size: 16px; }
  body {
    font-family: 'LXGW WenKai TC', -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    line-height: 1.7; letter-spacing: 0.04em;
    background: radial-gradient(circle at top left, #faf3e4, #f5f3ef 55%, #f1f5f4);
    color: var(--text-color); margin: 0; padding: 0; font-size: 1rem;
  }
  .main-container { 
    max-width: 1200px; margin: 2rem auto 2.5rem; background-color: var(--secondary-bg); 
    box-shadow: 0 18px 45px var(--shadow-color); border-radius: 20px; overflow: hidden;
    border: 1px solid rgba(255,255,255,0.7); backdrop-filter: blur(10px); position: relative;
  }
  .sticky-top-bar { position: sticky; top: 0; z-index: 100; background-color: var(--secondary-bg); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  header { 
    padding: 1.6rem 2rem 1.4rem; background: var(--header-bg); color: white; 
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;
    box-shadow: 0 10px 26px rgba(0,0,0,0.16); position: relative; z-index: 2;
  }
  h1 { margin: 0; font-size: 2.25rem; font-weight: 500; letter-spacing: 0.16em; }
  .auth-container {
    display: flex; align-items: center; gap: 0.75rem; background-color: rgba(255, 255, 255, 0.1);
    padding: 0.4rem 0.6rem; border-radius: 999px; box-shadow: 0 0 0 1px rgba(255,255,255,0.25); flex-shrink: 0;
  }
  #auth-status { font-size: 0.8rem; padding: 0.3rem 0.8rem; background-color: rgba(0,0,0,0.15); border-radius: 999px; white-space: nowrap; }
  #auth-buttons { display: flex; gap: 0.5rem; }
  #auth-buttons .btn { padding: 0.4rem 1rem; font-size: 0.85rem; border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
  #auth-buttons .btn:hover { background-color: rgba(255,255,255,0.2); }
  .font-controls { display: flex; align-items: center; gap: 0.5rem; background-color: rgba(255,255,255,0.12); padding: 0.3rem 0.4rem; border-radius: 999px; box-shadow: 0 0 0 1px rgba(255,255,255,0.35); }
  .font-control-btn {
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.7); color: white;
    border-radius: 999px; cursor: pointer; font-family: inherit; font-size: 0.9rem; width: 2.35rem; height: 2.35rem;
    display: flex; align-items: center; justify-content: center; transition: all var(--transition-fast);
    box-shadow: 0 5px 10px rgba(0,0,0,0.15);
  }
  .font-control-btn:hover { background-color: rgba(255,255,255,0.18); transform: translateY(-1px); }
  h2 { color: var(--title-color); border-bottom: 1px solid rgba(90,143,123,0.25); padding-bottom: 0.75rem; margin-top: 0; font-weight: 500; font-size: 1.8rem; }
  h3 { color: var(--title-color); font-weight: 500; font-size: 1.45rem; }
  .page-nav { display: flex; background-color: var(--nav-bg); border-bottom: 1px solid var(--border-color); flex-wrap:wrap; }
  .nav-btn { 
    flex: 1 0 auto; padding: 0.9rem 1rem; text-align: center; font-size: 1.02rem; cursor: pointer; 
    border: none; background: transparent; color: #6c776f; 
    transition: all var(--transition-normal); border-bottom: 3px solid transparent; font-family: inherit;
    min-width: 150px; position: relative; white-space: nowrap;
  }
  .nav-btn:hover { background-color: rgba(255,255,255,0.7); color: var(--title-color); }
  .nav-btn.active { background: linear-gradient(135deg, var(--nav-active-bg), #6caa91); color: var(--nav-active-color); border-bottom-color: #e7dccc; box-shadow: 0 5px 15px rgba(0,0,0,0.18); }
  .page-content { display: none; background: radial-gradient(circle at top, #fdfbf7 0, #fbf8f3 45%, #f7f3eb 100%); }
  .page-content.active { display: block; }
  .section-box { padding: 2rem; border-bottom: 1px solid rgba(225,216,200,0.6); background-color: rgba(252,250,246,0.88); }
  .section-box:nth-child(odd) { background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(251,246,238,0.9)); }
  .input-group { margin-bottom: 1.25rem; }
  .input-group label { display: block; font-weight: 600; margin-bottom: 0.55rem; font-size: 1.05rem; color: #716659; }
  .input-group input, .input-group textarea, .input-group select {
    width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);
    font-size: 0.96rem; box-sizing: border-box; background-color: #fefcf9; font-family: inherit;
    transition: all var(--transition-fast);
  }
  .input-group textarea { resize: vertical; min-height: 90px; }
  .input-group input:focus, .input-group textarea:focus, .input-group select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(90, 143, 123, 0.25); background-color: #ffffff; }
  .two-column-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start; }
  @media (max-width: 768px) { .two-column-grid { grid-template-columns: 1fr; gap: 1.25rem; } }
  .score-main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1.25rem; }
  .score-total-box input[readonly] { background-color: #f6f1e7; font-weight: bold; font-size: 1.1rem; text-align: center; }
  details { background: #fdfdfc; border: 1px solid rgba(225,216,200,0.9); border-radius: var(--radius-md); margin-bottom: 1rem; box-shadow: 0 8px 18px rgba(0,0,0,0.04); overflow: hidden; }
  summary { padding: 1rem 1.25rem; font-weight: 500; font-size: 1.2rem; color: var(--title-color); cursor: pointer; display: flex; justify-content:space-between; align-items:center; background: linear-gradient(90deg, rgba(250,247,241,0.95), rgba(239,247,243,0.9)); }
  summary::after { content: 'ï¼‹'; font-size: 1.4rem; transition: transform var(--transition-fast); color: var(--accent-color); }
  details[open] > summary::after { transform: rotate(45deg); color: #44725f; }
  .check-item { border: 1px solid rgba(225,216,200,0.9); border-radius: var(--radius-md); padding: 1rem; margin-bottom: 0.9rem; background: #fffdf9; cursor: pointer; transition: all var(--transition-fast); }
  .check-item:hover { transform: translateY(-2px); box-shadow: 0 12px 26px rgba(0,0,0,0.08); background-color: #ffffff; }
  .check-item-header { display: flex; align-items: center; gap: 0.4rem; }
  .check-item.is-problem label { color: var(--problem-color); }
  .check-item.is-excellent label { color: var(--excellent-color); }
  .interactive-module { display: none; background-color: #f7faf7; border: 1px dashed rgba(90,143,123,0.5); border-radius: var(--radius-md); padding: 0.9rem; margin-top: 0.8rem; }
  .panel { border: 1px solid rgba(225,216,200,0.9); border-radius: 16px; background: #fefdfb; padding: 1.1rem; display: flex; flex-direction: column; box-shadow: 0 14px 30px rgba(0,0,0,0.08); }
  .panel textarea { min-height: 350px; padding: 1rem; border-radius: 10px; line-height: 1.8; resize: vertical; background: #fffdfa; border: 1px solid rgba(225,216,200,0.9); }
  .panel textarea:focus { border-color: var(--accent-color); }
  .action-btn, .secondary-btn, .danger-btn, .light-btn, .btn { border-radius: 999px; border: none; cursor: pointer; font-family: inherit; font-size: 0.98rem; padding: 0.7rem 1.5rem; transition: all var(--transition-fast); display: inline-flex; align-items: center; justify-content: center; gap: 0.25rem; white-space: nowrap; }
  .action-btn { color: white; background: linear-gradient(135deg, #5A8F7B, #78a693); box-shadow: 0 10px 20px rgba(41,81,64,0.35); }
  .action-btn:hover { opacity: 0.95; transform: translateY(-1px); }
  .secondary-btn { background: linear-gradient(135deg, var(--btn-brown-bg), var(--btn-brown-hover)); color:#fff; box-shadow: 0 8px 16px rgba(87,69,50,0.35); }
  .danger-btn { background: linear-gradient(135deg, #c86a5a, #de8b7c); color:#fff; box-shadow: 0 7px 15px rgba(133,54,41,0.4); }
  .light-btn { background: linear-gradient(135deg, #cfe3d9, #9fbfaf); color:#305244; box-shadow: 0 7px 14px rgba(60,90,80,0.28); }
  .light-btn.brown { background: linear-gradient(135deg, #dac5a8, #b29372); color:#3f3327; }
  
  /* Student Table Frozen Header */
  #student-overview-table-wrapper { overflow: auto; max-height: 70vh; margin-top: 1.25rem; background-color: #fdfbf8; border-radius: 12px; border: 1px solid rgba(225,216,200,0.9); }
  #student-overview-table { width: 100%; min-width: 1200px; border-collapse: separate; border-spacing: 0; font-size: 0.85em; }
  #student-overview-table th, #student-overview-table td { border: 1px solid rgba(225,216,200,0.9); padding: 0.55rem 0.75rem; text-align: center; vertical-align: top; background: #fdfbf8; }
  #student-overview-table thead th { position: sticky; top: 0; z-index: 15; background: linear-gradient(135deg, #f1ece4, #e8f0ea); color: var(--title-color); }
  #student-overview-table th:nth-child(1), #student-overview-table td:nth-child(1) { position: sticky; left: 0; z-index: 10; width: 80px; border-right: 1px solid rgba(225,216,200,0.9); }
  #student-overview-table th:nth-child(2), #student-overview-table td:nth-child(2) { position: sticky; left: 80px; z-index: 10; width: 110px; border-right: 2px solid #d1c8b8; }
  #student-overview-table thead th:nth-child(1), #student-overview-table thead th:nth-child(2) { z-index: 20; background: #e8f0ea; }
  .row-missing td { background-color: var(--danger-bg-soft) !important; }
  
  /* Floating Nav */
  #floating-nav { position: fixed; top: 50%; right: 20px; transform: translateY(-50%); z-index: 1050; display: flex; flex-direction: column; gap: 12px; background-color: rgba(255,255,255,0.6); padding: 12px; border-radius: 99px; backdrop-filter: blur(10px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); opacity: 0; pointer-events: none; transition: all 0.3s; }
  #floating-nav.visible { opacity: 1; pointer-events: auto; }
  .floating-nav-btn { width: 48px; height: 48px; border-radius: 50%; background-color: var(--accent-color-soft); color: var(--accent-color); display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 1.5rem; transition: all 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  .floating-nav-btn:hover { background-color: var(--accent-color); color: white; transform: scale(1.1); }
  
  /* Toast */
  #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 99999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
  .toast-notification { background-color: white; color: var(--text-color); padding: 12px 20px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid var(--border-color); font-size: 0.95rem; display: flex; align-items: center; gap: 10px; pointer-events: auto; opacity: 0; transform: translateY(-20px); animation: toastSlideIn 0.4s forwards; }
  .toast-notification.success { border-left: 5px solid var(--excellent-color); }
  .toast-notification.warning { border-left: 5px solid #e6a23c; }
  .toast-notification.error { border-left: 5px solid var(--problem-color); }
  .toast-notification.info { border-left: 5px solid var(--accent-color); }
  @keyframes toastSlideIn { to { opacity: 1; transform: translateY(0); } }
  @keyframes toastFadeOut { to { opacity: 0; transform: translateY(-20px); } }
  
  /* Modal */
  .modal-backdrop { position: fixed; inset: 0; background: var(--modal-bg); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(3px); }
  .modal-backdrop.active { display: flex; }
  .modal-card { width: min(92vw, 420px); background: var(--modal-card-bg); border-radius: 18px; box-shadow: 0 24px 55px rgba(0,0,0,0.30); padding: 1.25rem 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
</style>
</head>
<body>

  <div id="toast-container"></div>

  <!-- Project Selection Modal -->
  <div id="pop-project-modal" class="pop-overlay">
    <div class="pop-modal">
      <div class="pop-icon">ğŸ“‚</div>
      <h3>é›²ç«¯å°ˆæ¡ˆè®€å–</h3>
      <p class="pop-desc">åœ¨é›²ç«¯æ‰¾åˆ°ä»¥ä¸‹å°ˆæ¡ˆã€‚<br>è«‹è¼¸å…¥æ•¸å­—é¸æ“‡ï¼Œæˆ–ç›´æ¥é»æ“Šåˆ—è¡¨é …ç›®ã€‚</p>
      <div class="pop-scroll-area" id="pop-project-list"></div>
      <input type="number" id="pop-project-input" class="pop-input" placeholder="è¼¸å…¥ç·¨è™Ÿ..." min="1">
      <div class="pop-footer">
        <button class="pop-btn pop-btn-cancel" id="pop-project-cancel">é–‹æ–°å°ˆæ¡ˆ (ä¸è¼‰å…¥)</button>
        <button class="pop-btn pop-btn-confirm" id="pop-project-confirm">ç¢ºå®šè¼‰å…¥</button>
      </div>
    </div>
  </div>

  <div class="main-container">
    <div class="sticky-top-bar">
      <header>
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          <h1>æˆ‘ä¸æƒ³åŠªåŠ›äº†</h1>
          <div class="auth-container">
            <span id="auth-status">æœªé€£æ¥</span>
            <div id="auth-buttons">
              <button id="login-btn" class="btn light-btn">ç™»å…¥/è¨»å†Š</button>
              <button id="logout-btn" class="btn danger-btn" style="display: none;">ç™»å‡º</button>
              <button id="sync-btn" class="btn action-btn" style="display: none;" disabled>åŒæ­¥è‡³é›²ç«¯</button>
            </div>
          </div>
        </div>
        <div class="font-controls">
          <button class="font-control-btn" onclick="adjustFontSize('decrease')" title="ç¸®å°å­—é«”">A-</button>
          <button class="font-control-btn" onclick="adjustFontSize('reset')" title="é‡è¨­å­—é«”å¤§å°">é‡è¨­</button>
          <button class="font-control-btn" onclick="adjustFontSize('increase')" title="æ”¾å¤§å­—é«”">A+</button>
        </div>
      </header>
      
      <nav class="page-nav">
        <button id="nav-page1" class="nav-btn active" onclick="showPage('page1')">åŸºæœ¬è¨­å®š</button>
        <button id="nav-page2" class="nav-btn" onclick="showPage('page2')">æ‰¹æ”¹é </button>
        <button id="nav-page3" class="nav-btn" onclick="showPage('page3')">è©•èªç¸½è¦½èˆ‡ä¿®è¨‚</button>
        <button id="nav-page4" class="nav-btn" onclick="showPage('page4')">å­¸ç”Ÿç¸½è¦½</button>
        <button id="nav-page5" class="nav-btn" onclick="showPage('page5')">è©•èªåˆ†æ</button>
        <button id="nav-page6" class="nav-btn" onclick="showPage('page6')">AI è©•èªåº«ç”Ÿæˆ</button>
        <button id="nav-page7" class="nav-btn" onclick="showPage('page7')">AI ç”Ÿæˆå›é¥‹</button>
      </nav>
    </div>

    <main>
      <!-- Page 1 -->
      <div id="page1" class="page-content active">
        <div class="section-box">
            <h2>æ­¥é©Ÿä¸€ï¼šåŸºæœ¬è¨­å®š</h2>
            <div class="two-column-grid">
                <div class="input-group">
                    <label for="topic">ä½œæ–‡é¡Œç›®</label>
                    <input type="text" id="topic" placeholder="ä¾‹å¦‚ï¼šè¨˜ä¸€æ¬¡é›£å¿˜çš„ç¶“æ­·">
                </div>
                <div class="input-group">
                    <label for="student-class">ç­åˆ¥ / çµ„åˆ¥ (å¯é¸)</label>
                    <input type="text" id="student-class" placeholder="ä¾‹å¦‚ï¼š6A, S.3A">
                </div>
            </div>
        </div>
        <div class="section-box">
            <h2>æ­¥é©ŸäºŒï¼šé¸æ“‡è©•èªåº«</h2>
            <p style="font-size:0.9rem;color:#777; margin-top:-0.7rem;">è«‹é¸æ“‡ä¸€ç¨®æ–¹å¼ä¾†å»ºç«‹æœ¬æ¬¡æ‰¹æ”¹çš„è©•èªåº«ã€‚è©•èªåº«å»ºç«‹å¾Œï¼Œå°‡è‡ªå‹•è·³è½‰è‡³ã€Œæ‰¹æ”¹é ã€ã€‚</p>
            
            <details class="io-details" open>
                <summary><h3>é¸é … Aï¼šä½¿ç”¨é è¨­ç½é ­è©•èª</h3></summary>
                <div class="io-details-content">
                    <p>è«‹é¸æ“‡æ–‡ç« ä¸»è¦é¡å‹ï¼ˆå¯å¤šé¸ï¼‰ï¼Œç³»çµ±å°‡ç‚ºæ‚¨è¼‰å…¥ç›¸é—œçš„é€šç”¨è©•èªã€‚</p>
                    <div id="genre-selection" class="checkbox-group">
                        <label><input type="checkbox" name="genre" value="narrative"> è¨˜æ•˜</label>
                        <label><input type="checkbox" name="genre" value="lyrical"> æŠ’æƒ…</label>
                        <label><input type="checkbox" name="genre" value="descriptive"> æå¯«</label>
                        <label><input type="checkbox" name="genre" value="argumentative"> è­°è«–</label>
                    </div>
                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="action-btn" onclick="loadCannedCritiquesAndFocus()">ç¢ºå®šä¸¦è¼‰å…¥é è¨­è©•èª</button>
                    </div>
                </div>
            </details>

            <details class="io-details">
                <summary><h3>é¸é … Bï¼šå¾é›²ç«¯è®€å–æˆ–æ‰‹å‹•å»ºç«‹</h3></summary>
                <div class="io-details-content">
                    <p>æ‚¨å¯ä»¥å¾é›²ç«¯è®€å–ä¹‹å‰å„²å­˜çš„æ•´å€‹å°ˆæ¡ˆï¼ˆåŒ…å«å­¸ç”Ÿåå–®åŠé€²åº¦ï¼‰ï¼Œæˆ–è·³è‡³å…¶ä»–é é¢æ‰‹å‹•å»ºç«‹/å°å…¥è©•èªåº«ã€‚</p>
                    <div class="btn-group">
                        <button id="select-project-btn" class="secondary-btn" style="display: none;">å¾é›²ç«¯é¸å–å°ˆæ¡ˆ</button>
                        <button class="light-btn brown" onclick="showPage('page6', 'ai-student-level')">å‰å¾€ AI è©•èªåº«ç”Ÿæˆ</button>
                        <button class="light-btn" onclick="showPage('page3', 'overview-controls')">å‰å¾€æ‰‹å‹•ä¿®è¨‚è©•èªåº«</button>
                    </div>
                </div>
            </details>
        </div>
      </div>

      <!-- Page 2 -->
      <div id="page2" class="page-content">
        <div class="grading-page-grid">
            <div id="grading-section-student" class="section-box">
                <h2>ä¸€ã€é¸æ“‡å­¸ç”Ÿ</h2>
                <div class="input-group">
                    <label for="student-names">å­¸ç”Ÿåå–®ï¼ˆæ¯è¡Œä¸€ä½ï¼Œå¯åŒ…å«å­¸è™Ÿï¼‰</label>
                    <textarea id="student-names" rows="5" placeholder="01-é™³å¤§æ–‡&#10;02 å¼µå°ç¾&#10;æå‰æ˜"></textarea>
                </div>
                <div class="btn-group" style="margin-bottom: 1rem;">
                    <button class="light-btn" onclick="downloadStudentListTemplate()">ä¸‹è¼‰ç¯„æœ¬</button>
                    <label class="light-btn brown" for="import-student-list" style="cursor: pointer;">åŒ¯å…¥åå–® (Excel)</label>
                    <input type="file" id="import-student-list" accept=".xlsx, .xls" style="display:none;">
                </div>
                <div class="input-group">
                    <label for="student-select">é¸æ“‡å­¸ç”Ÿ</label>
                    <select id="student-select"><option value="">è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥å­¸ç”Ÿåå–®</option></select>
                </div>
                <div class="btn-group">
                    <button class="secondary-btn" onclick="navigateToStudent('prev')">ä¸Šä¸€ä½</button>
                    <button class="secondary-btn" onclick="navigateToStudent('next')">ä¸‹ä¸€ä½</button>
                </div>
            </div>

            <div id="grading-section-checklist" class="section-box">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <h2>äºŒã€è©•èªé …ç›®é¸æ“‡</h2>
                    <div class="btn-group">
                    <button class="light-btn" onclick="toggleAllDetails('checklist-container', true)">å…¨å±•</button>
                    <button class="light-btn brown" onclick="toggleAllDetails('checklist-container', false)">å…¨æ”¶</button>
                    </div>
                </div>
                <div id="checklist-container">
                    <div class="empty-state-message">è«‹å…ˆåœ¨ã€ŒåŸºæœ¬è¨­å®šã€é é¸æ“‡æˆ–å»ºç«‹è©•èªåº«ã€‚</div>
                </div>
            </div>

            <div id="grading-section-typo-score" class="section-box">
                <h2>ä¸‰ã€éŒ¯åˆ¥å­—åŠè©•åˆ†</h2>
                <details class="sub-section-card">
                    <summary><h3>éŒ¯åˆ¥å­—è¨˜éŒ„èˆ‡å¸¸è¦‹åº«</h3></summary>
                    <div class="sub-section-card-content">
                        <div id="typo-module" style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end;">
                            <div class="input-group" style="flex:1; min-width:140px; margin-bottom:0;">
                            <label for="typo-wrong">éŒ¯å­—</label>
                            <input type="text" id="typo-wrong">
                            </div>
                            <div class="input-group" style="flex:1; min-width:140px; margin-bottom:0;">
                            <label for="typo-correct">æ­£å­—</label>
                            <input type="text" id="typo-correct">
                            </div>
                            <button class="action-btn" onclick="addTypo()">æ–°å¢</button>
                            <button class="secondary-btn" onclick="saveTypoToCommon()">å­˜å¸¸è¦‹</button>
                        </div>
                        <ul id="typo-list" style="list-style:none; padding:0; margin-top:0.75rem;"></ul>
                        <div class="typo-saved-box">
                            <h3 class="io-box-title">å¸¸è¦‹éŒ¯åˆ¥å­—åº«</h3>
                            <ul id="typo-saved-list" class="typo-saved-list"></ul>
                        </div>
                    </div>
                </details>

                <details open class="sub-section-card">
                    <summary><h3>ä½œæ–‡è©•åˆ† (1-10åˆ†)</h3></summary>
                    <div class="sub-section-card-content">
                        <div class="score-main-grid">
                            <div class="input-group"><label for="score-content">å…§å®¹</label><input type="number" id="score-content"></div>
                            <div class="input-group"><label for="score-expression">è¡¨é”</label><input type="number" id="score-expression"></div>
                            <div class="input-group"><label for="score-structure">çµæ§‹</label><input type="number" id="score-structure"></div>
                            <div class="input-group"><label for="score-punctuation">æ¨™é»</label><input type="number" id="score-punctuation"></div>
                            <div class="input-group"><label for="score-typos">éŒ¯åˆ¥å­—</label><input type="number" id="score-typos"></div>
                        </div>
                        <div class="score-total-box" style="margin-top: 1rem;">
                            <div class="input-group"><label for="score-total">ç¸½åˆ†</label><input type="number" id="score-total" readonly></div>
                        </div>
                    </div>
                </details>
            </div>

            <div id="grading-section-feedback" class="section-box">
                <h2>å››ã€å­¸ç”Ÿè©•èª</h2>
                <div class="input-group">
                    <label for="unique-comment">ç‰¹åˆ¥ç•™è¨€</label>
                    <textarea id="unique-comment" rows="4"></textarea>
                </div>
                <div class="panel" style="margin-top: 1rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>å­¸ç”Ÿç‰ˆæœ¬</h3>
                        <div class="panel-actions"><button class="action-btn" onclick="copyOutput('student-report-output', this)">è¤‡è£½</button></div>
                    </div>
                    <textarea id="student-report-output" oninput="handleManualEdit('student')"></textarea>
                </div>
                <div class="panel" style="margin-top: 1rem;">
                    <details>
                        <summary><h3>å®Œæ•´ç‰ˆæœ¬</h3></summary>
                        <div class="panel-content-wrapper">
                        <div class="panel-actions"><button class="action-btn" onclick="copyOutput('full-output', this)">è¤‡è£½</button></div>
                        <textarea id="full-output" oninput="handleManualEdit('full')"></textarea>
                        </div>
                    </details>
                </div>
            </div>
            <div id="grading-section-save" class="section-box" style="background: transparent; border-top: none; text-align: center;">
                <div class="btn-group" style="justify-content: center;">
                    <button class="action-btn" onclick="saveCurrentStudentData()">ğŸ’¾ å„²å­˜ç•¶å‰å­¸ç”Ÿ</button>
                    <button class="action-btn clear-all" onclick="confirmUI('ç¢ºå®šæ¸…ç©ºï¼Ÿ', () => clearAllCore())">æ¸…ç©ºç•¶å‰</button>
                </div>
            </div>
            <div style="height: 8rem;"></div>
        </div>
      </div>

      <!-- Page 3 -->
      <div id="page3" class="page-content">
        <div class="overview-container">
          <h2>è©•èªç¸½è¦½èˆ‡ä¿®è¨‚</h2>
          <details id="add-critique-section">
            <summary>æ–°å¢è©•èªé …ç›®</summary>
            <div class="add-critique-form">
              <div class="add-critique-grid">
                <div class="input-group"><label>è©•èªæ¨™é¡Œ*</label><input type="text" id="new-critique-title"></div>
                <div class="input-group"><label>é¡å‹*</label><div class="radio-group"><label><input type="radio" name="new-critique-type" value="excellent" checked> å„ªé»</label><label><input type="radio" name="new-critique-type" value="problem"> å¾…æ”¹é€²</label></div></div>
                <div class="input-group"><label>åˆ†é¡*</label><select id="new-critique-category-select"></select></div>
                <div class="input-group" id="new-critique-category-new-wrapper" style="display:none;"><label>æ–°åˆ†é¡åç¨±</label><input type="text" id="new-critique-category-new"></div>
              </div>
              <div id="new-critique-fields">
                <div class="input-group" data-type-scope="excellent"><label>å„ªé»ç¸½çµ</label><textarea data-field="strengthSummary"></textarea></div>
                <div class="input-group" data-type-scope="problem" style="display:none;"><label>å•é¡Œ</label><textarea data-field="problemCore"></textarea></div>
                <div class="input-group" data-type-scope="problem" style="display:none;"><label>å®œ</label><textarea data-field="suggestion"></textarea></div>
                <div class="input-group"><label>ä¾‹å­</label><textarea data-field="example"></textarea></div>
                <div class="input-group"><label>é¸é …æè¿°</label><textarea data-field="optionsLabel"></textarea></div>
                <div class="input-group"><label>ä¸‹æ‹‰é¸é …</label><textarea data-field="options"></textarea></div>
              </div>
              <button class="action-btn" onclick="addNewCritique()">æ–°å¢é …ç›®</button>
            </div>
          </details>
          <details class="io-details">
            <summary><h3>è©•èªåº«ç®¡ç†</h3></summary>
            <div class="io-details-content">
                <div class="btn-group">
                    <button class="action-btn" onclick="downloadCritiqueTemplate()">ä¸‹è¼‰ç¯„æœ¬</button>
                    <button class="action-btn" onclick="exportCritiquesToExcel()">å°å‡º Excel</button>
                    <label class="action-btn" for="import-critique-excel">å°å…¥ Excel</label>
                    <input type="file" id="import-critique-excel" style="display:none;"/>
                </div>
                <div class="btn-group" style="margin-top: 1rem;">
                    <button class="danger-btn" onclick="confirmUI('ç¢ºå®šé‡è¨­ï¼Ÿ', resetToDefaultCritiques)">é‡è¨­ç‚ºé è¨­</button>
                </div>
            </div>
          </details>
          <div id="overview-controls" class="btn-group" style="margin: 1rem 0;"><button class="light-btn" onclick="toggleAllDetails('overview-list', true)">å…¨éƒ¨å±•é–‹</button><button class="light-btn brown" onclick="toggleAllDetails('overview-list', false)">å…¨éƒ¨æ”¶åˆ</button></div>
          <div id="overview-list" class="overview-panel"></div>
        </div>
      </div>

      <!-- Page 4 -->
      <div id="page4" class="page-content">
        <div class="overview-container">
          <div class="page-header"><h2>å­¸ç”Ÿè©•èªè¨˜éŒ„ç¸½è¦½</h2><div class="btn-group"><button class="action-btn" onclick="exportOverviewToExcel()">åŒ¯å‡º Excel</button><button class="secondary-btn" onclick="exportOverviewToWord()">åŒ¯å‡º Word</button></div></div>
          <h3 id="overview-class-display"></h3>
          <div id="student-overview-table-wrapper">
              <table id="student-overview-table">
                  <thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>å…§å®¹</th><th>è¡¨é”</th><th>çµæ§‹</th><th>æ¨™é»</th><th>éŒ¯åˆ¥å­—</th><th>ç¸½åˆ†</th><th>å­¸ç”Ÿç‰ˆè©•èª</th><th>å®Œæ•´ç‰ˆè©•èª</th></tr></thead>
                  <tbody></tbody>
              </table>
          </div>
        </div>
      </div>

      <!-- Page 5/6/7 ... (Simplified for brevity, logic remains) -->
      <div id="page5" class="page-content"><div class="overview-container"><h2>è©•èªåˆ†æ</h2><div class="btn-group"><button class="action-btn" onclick="exportAnalysisToExcel()">åŒ¯å‡º Excel</button><button class="secondary-btn" onclick="exportAnalysisToWord()">åŒ¯å‡º Word</button></div><div class="analysis-grid"><div class="analysis-card"><h3>åˆ†æ•¸æ¦‚è¦½</h3><div id="analysis-score-summary"></div></div><div class="analysis-card"><h3>å¸¸è¦‹è©•èª</h3><div id="analysis-top-critique"></div></div></div></div></div>
      <div id="page6" class="page-content"><div class="overview-container"><h2>AI è©•èªåº«ç”Ÿæˆ</h2><div class="ai-page-grid"><div><div class="section-box"><h3>æ­¥é©Ÿä¸€</h3><div class="add-critique-grid"><div class="input-group"><label>ç´šåˆ¥</label><select id="ai-student-level"><option>åˆç´š</option><option selected>ä¸­ç´š</option><option>é«˜ç´š</option></select></div><div class="input-group"><label>é¡Œç›®</label><input type="text" id="ai-topic"></div><div class="input-group"><label>é‡é»</label><select id="ai-focus"><option>å¹³è¡¡</option></select></div><div class="input-group"><label>å„ªé»æ•¸</label><input type="number" id="ai-excellent-count"></div><div class="input-group"><label>æ”¹é€²æ•¸</label><input type="number" id="ai-problem-count"></div></div><div class="input-group"><label>Highlights</label><textarea id="ai-highlights"></textarea></div></div><div class="section-box"><h3>æ­¥é©ŸäºŒ</h3><button class="action-btn" onclick="generateAIPrompt()">ç”Ÿæˆ Prompt</button><textarea id="ai-prompt-preview"></textarea></div></div><div><div class="section-box"><h3>æ­¥é©Ÿä¸‰</h3><textarea id="ai-json-input"></textarea><button class="action-btn" onclick="applyAIJson()">æ‡‰ç”¨ JSON</button></div></div></div></div></div>
      <div id="page7" class="page-content"><div class="overview-container"><h2>AI ç”Ÿæˆå›é¥‹</h2><div class="section-box"><div class="input-group"><label>é¡å¤–æç¤º</label><textarea id="ai-feedback-extra-hints"></textarea></div></div><div class="section-box"><h3>æ­¥é©ŸäºŒ</h3><button class="action-btn" onclick="exportStudentDataForAI()">åŒ¯å‡ºè³‡æ–™</button><br><br><button class="action-btn" onclick="generateFeedbackPromptV2()">ç”Ÿæˆ Prompt</button><textarea id="ai-feedback-prompt-preview"></textarea></div><div class="section-box"><h3>æ­¥é©Ÿä¸‰</h3><textarea id="ai-feedback-json-input"></textarea><button class="action-btn" onclick="generateTeacherWord()">åŒ¯å‡ºè€å¸«ç‰ˆ</button><button class="secondary-btn" onclick="generateStudentWord()">åŒ¯å‡ºå­¸ç”Ÿç‰ˆ</button></div></div></div>

    </main>
  </div>

  <div id="modal" class="modal-backdrop"><div class="modal-card"><div class="modal-title" id="modal-title">è«‹ç¢ºèª</div><div id="modal-text"></div><div class="modal-actions"><button class="btn btn-secondary" id="modal-cancel">å–æ¶ˆ</button><button class="btn btn-danger" id="modal-ok">ç¢ºå®š</button></div></div></div>
  <div id="critique-data" style="display:none;"></div>

  <!-- Floating Nav -->
  <nav id="floating-nav">
    <a href="#grading-section-student" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-student')" data-tooltip="å­¸ç”Ÿ">ğŸ˜½</a>
    <a href="#grading-section-checklist" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-checklist')" data-tooltip="è©•èªé …ç›®">âœ…</a>
    <a href="#grading-section-typo-score" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-typo-score')" data-tooltip="éŒ¯åˆ¥å­—">ğŸ“</a>
    <a href="#grading-section-feedback" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-feedback')" data-tooltip="è©•èª">ğŸ“„</a>
    <a href="javascript:void(0)" class="floating-nav-btn" onclick="saveCurrentStudentData()" data-tooltip="å„²å­˜å­¸ç”Ÿ">ğŸ’¾</a>
    <a href="javascript:void(0)" class="floating-nav-btn" onclick="syncDataToCloud()" data-tooltip="åŒæ­¥è‡³é›²ç«¯">â˜ï¸</a>
  </nav>

<script>
const SUPABASE_URL = 'https://wtcegbkfuklnkurrouka.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0Y2VnYmtmdWtsbmt1cnJvdWthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MTU5MjgsImV4cCI6MjA3ODk5MTkyOH0.mQT2TXLR6m41D1WzmqH35mKdoGDGqHaHhZm-sTpPmpQ';
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let isDataDirty = false; 
let allStudentRecords = [];
let currentTypos = [];
let commonTypos = [];
let cannedCritiques = {}; 
const CATEGORY_ORDER = ['æ‰£é¡Œèˆ‡ç«‹æ„', 'å–æèˆ‡åˆ»ç•«', 'çµæ§‹èˆ‡é‹ªæ’', 'èªè¨€èˆ‡è¡¨é”'];

document.addEventListener('DOMContentLoaded', () => {
  loadDefaultCritiques();
  buildChecklist();
  buildOverviewPage();
  attachGlobalListeners();
  updateStudentDropdown(); 
  updateAllOutputs();
  checkUser();
  loadFontSize();
  initFloatingNavObserver();
});

const modal = {
  el: null, okBtn: null, cancelBtn: null, textEl: null, resolve: null,
  init() {
    this.el = document.getElementById('modal');
    this.okBtn = document.getElementById('modal-ok');
    this.cancelBtn = document.getElementById('modal-cancel');
    this.textEl = document.getElementById('modal-text');
    this.okBtn.addEventListener('click', ()=>{ this.hide(); if (this.resolve) this.resolve(true); });
    this.cancelBtn.addEventListener('click', ()=>{ this.hide(); if (this.resolve) this.resolve(false); });
  },
  show(message) {
    if (!this.el) this.init();
    this.textEl.textContent = message || 'è«‹ç¢ºèª';
    this.el.classList.add('active');
    return new Promise(res => { this.resolve = res; });
  },
  hide() { this.el.classList.remove('active'); }
};
function confirmUI(message, onOk) {
  modal.show(message).then(ok => { if (ok && typeof onOk === 'function') onOk(); });
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.innerHTML = `<span>${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'toastFadeOut 0.4s forwards';
        setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 400);
    }, 3000);
}

async function checkUser() {
  const { data: { session } } = await supabaseClient.auth.getSession();
  currentUser = session ? session.user : null;
  updateUIBasedOnAuthState();
  if (currentUser) {
    loadDataFromCloud();
  } else {
    renderCommonTypoList();
  }
  supabaseClient.auth.onAuthStateChange((event, session) => {
    currentUser = session ? session.user : null;
    updateUIBasedOnAuthState();
    if (event === 'SIGNED_IN') loadDataFromCloud();
    else if (event === 'SIGNED_OUT') {
      sessionStorage.removeItem('projectPromptShownThisSession');
      commonTypos = []; allStudentRecords = [];
      resetToDefaultCritiques(false);
      clearAllCore();
      alert("å·²ç™»å‡ºã€‚");
    }
  });
}

async function handleLogin() {
  const email = prompt("è«‹è¼¸å…¥ä½ çš„é›»éƒµåœ°å€ï¼š");
  if (!email) return;
  const { error } = await supabaseClient.auth.signInWithOtp({ email });
  if (error) alert(`ç™»å…¥å¤±æ•—ï¼š${error.message}`);
  else alert("ç™»å…¥é€£çµå·²ç™¼é€ã€‚");
}

function handleLogout() {
  confirmUI("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ", async () => {
    await supabaseClient.auth.signOut();
  });
}

async function loadDataFromCloud() {
  if (!currentUser) return;
  try {
    const { data: critiquesData } = await supabaseClient.from('critiques').select('*').eq('user_id', currentUser.id);
    if (critiquesData && critiquesData.length > 0) {
      applyCritiquesToDOM(critiquesData.map(c => ({
        id: c.critique_id, category: c.category, type: c.type, title: c.title,
        strengthSummary: c.strength_summary, problemCore: c.problem_core,
        suggestion: c.suggestion, example: c.example, options: c.options, optionsLabel: c.options_label
      })));
    } else {
      resetToDefaultCritiques(false);
    }
    buildChecklist(); buildOverviewPage();

    const { data: typosData } = await supabaseClient.from('common_typos').select('*').eq('user_id', currentUser.id);
    commonTypos = typosData ? typosData.map(t => ({ id: t.typo_id, wrong: t.wrong, correct: t.correct })) : [];
    renderCommonTypoList();

    if (!sessionStorage.getItem('projectPromptShownThisSession')) {
        await promptAndLoadCloudProject();
        sessionStorage.setItem('projectPromptShownThisSession', 'true');
    }
    updateUIBasedOnAuthState();
  } catch (error) { console.error(error); }
}

/* === é‡å¯«çš„æ ¸å¿ƒå‡½æ•¸ === */

// 1. è¼‰å…¥å°ˆæ¡ˆæç¤º (Pop Art Modal)
// 1. ä¿®æ­£å¾Œçš„è¼‰å…¥å°ˆæ¡ˆæç¤º (è™•ç†é–‹æ–°å°ˆæ¡ˆæ™‚çš„è©•èªæ®˜ç•™å•é¡Œ)
async function promptAndLoadCloudProject() {
    if (!currentUser) return;
    const { data: projectsData } = await supabaseClient.from('student_projects').select('id, class_name, topic, updated_at').eq('user_id', currentUser.id);
    
    if (!projectsData || projectsData.length === 0) {
        if (sessionStorage.getItem('projectPromptShownThisSession')) showToast("é›²ç«¯ä¸Šæ²’æœ‰æ‰¾åˆ°ä»»ä½•å°ˆæ¡ˆã€‚", "info");
        return;
    }

    const sortedProjects = projectsData.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
    
    return new Promise((resolve) => {
        const modal = document.getElementById('pop-project-modal');
        const listContainer = document.getElementById('pop-project-list');
        const input = document.getElementById('pop-project-input');
        const confirmBtn = document.getElementById('pop-project-confirm');
        const cancelBtn = document.getElementById('pop-project-cancel');
        
        listContainer.innerHTML = '';
        sortedProjects.forEach((p, index) => {
            const dateStr = new Date(p.updated_at).toLocaleDateString();
            const div = document.createElement('div');
            div.className = 'pop-list-item';
            div.innerHTML = `<strong>${index + 1}.</strong> ${escapeHtmlAttr(p.class_name || 'æœªå‘½å')} - ${escapeHtmlAttr(p.topic || 'æœªå‘½å')} <span style="font-size:0.8em;color:#999">(${dateStr})</span>`;
            div.onclick = () => { input.value = index + 1; triggerConfirm(); };
            listContainer.appendChild(div);
        });

        modal.classList.add('active');
        input.value = '';
        setTimeout(() => input.focus(), 100); 

        const triggerConfirm = async () => {
            const val = parseInt(input.value, 10);
            if (!isNaN(val) && val >= 1 && val <= sortedProjects.length) {
                const projectId = sortedProjects[val - 1].id;
                modal.classList.remove('active');
                confirmBtn.onclick = null; cancelBtn.onclick = null; input.onkeydown = null;
                await loadProjectById(projectId);
                resolve(true);
            } else {
                input.style.borderColor = '#c86a5a'; setTimeout(() => input.style.borderColor = '#e0e0e0', 500);
            }
        };

        // --- ä¿®æ­£é‡é»ï¼šé–‹æ–°å°ˆæ¡ˆæ™‚ï¼Œå¿…é ˆé‡ç½®è©•èªåº« ---
        const handleCreateNew = async () => {
            modal.classList.remove('active');
            confirmBtn.onclick = null; cancelBtn.onclick = null; input.onkeydown = null;
            
            // 1. æ¸…ç©ºå­¸ç”Ÿèˆ‡åŸºæœ¬è³‡æ–™
            clearAllCore(false);
            allStudentRecords = [];
            document.getElementById('student-names').value = '';
            document.getElementById('student-class').value = '';
            document.getElementById('topic').value = '';
            
            // 2. é‡ç½®è©•èªåº«ï¼šå…ˆæ¸…ç©º DOMï¼Œå†è¼‰å…¥å…¨åŸŸè¨­å®šæˆ–ç³»çµ±é è¨­
            const critiqueDataParams = document.getElementById('critique-data');
            if(critiqueDataParams) critiqueDataParams.innerHTML = ''; 

            if (currentUser) {
                // å¦‚æœå·²ç™»å…¥ï¼Œå˜—è©¦æŠ“å–è©²ç”¨æˆ¶çš„å…¨åŸŸè©•èªè¨­å®š
                try {
                    const { data: globalData } = await supabaseClient.from('critiques').select('*').eq('user_id', currentUser.id);
                    if (globalData && globalData.length > 0) {
                        applyCritiquesToDOM(globalData.map(c => ({
                            id: c.critique_id, category: c.category, type: c.type, title: c.title,
                            strengthSummary: c.strength_summary, problemCore: c.problem_core,
                            suggestion: c.suggestion, example: c.example, options: c.options, optionsLabel: c.options_label
                        })));
                    } else {
                        resetToDefaultCritiques(false); // æ²’å…¨åŸŸè¨­å®šå°±ç”¨ç³»çµ±ç½é ­
                    }
                } catch(e) {
                    console.error("é‡ç½®è©•èªå¤±æ•—", e);
                    resetToDefaultCritiques(false);
                }
            } else {
                resetToDefaultCritiques(false);
            }

            // 3. åˆ·æ–°ä»‹é¢
            updateStudentDropdown();
            renderStudentOverviewTable();
            buildChecklist(); 
            buildOverviewPage();
            showPage('page1'); // å›åˆ°åŸºæœ¬è¨­å®šé 
            
            showToast("å·²å»ºç«‹æ–°å°ˆæ¡ˆ (è©•èªåº«å·²é‡ç½®)", "info");
            resolve(false);
        };

        confirmBtn.onclick = triggerConfirm;
        cancelBtn.onclick = handleCreateNew;
        input.onkeydown = (e) => { if (e.key === 'Enter') triggerConfirm(); };
    });
}

// 2. ä¿®æ­£å¾Œçš„è®€å–å°ˆæ¡ˆ (ç¢ºä¿åˆ‡æ›å°ˆæ¡ˆæ™‚å…ˆæ¸…ç©ºèˆŠè³‡æ–™)
async function loadProjectById(projectId) {
    const authStatus = document.getElementById('auth-status');
    const originalText = authStatus.textContent;
    authStatus.textContent = "æ­£åœ¨è¼‰å…¥...";
    try {
        const { data: fullProject, error } = await supabaseClient.from('student_projects').select('project_data, class_name, topic').eq('id', projectId).single();
        if (error) throw error;
        
        clearAllCore(false);
        const rawData = fullProject.project_data;
        let loadedStudents = [];
        let loadedCritiques = null;

        if (Array.isArray(rawData)) {
            loadedStudents = rawData;
        } else if (rawData && rawData.students) {
            loadedStudents = rawData.students || [];
            loadedCritiques = rawData.critiques || [];
        }

        allStudentRecords = loadedStudents;
        document.getElementById('student-names').value = allStudentRecords.map(r => r.originalName).join('\n');
        document.getElementById('student-class').value = fullProject.class_name || '';
        document.getElementById('topic').value = fullProject.topic || '';
        
        // --- ä¿®æ­£é‡é»ï¼šè™•ç†è©•èªåº«è¼‰å…¥é‚è¼¯ ---
        const critiqueContainer = document.getElementById('critique-data');
        if(critiqueContainer) critiqueContainer.innerHTML = ''; // !! é—œéµä¿®æ­£ï¼šè¼‰å…¥æ–°å°ˆæ¡ˆå‰ï¼Œå¼·åˆ¶æ¸…ç©ºèˆŠè©•èª DOM !!

        if (loadedCritiques && loadedCritiques.length > 0) {
            // A. å°ˆæ¡ˆæœ‰è‡ªå¸¶è©•èªï¼šè¼‰å…¥å°ˆæ¡ˆå°ˆå±¬è©•èª
            applyCritiquesToDOM(loadedCritiques);
        } else {
            // B. å°ˆæ¡ˆç„¡è©•èªï¼ˆèˆŠç‰ˆè³‡æ–™ï¼‰ï¼šå˜—è©¦è¼‰å…¥å…¨åŸŸè¨­å®šï¼Œå¦å‰‡ç”¨é è¨­
            const { data: globalData } = await supabaseClient.from('critiques').select('*').eq('user_id', currentUser.id);
            if (globalData && globalData.length > 0) {
                 applyCritiquesToDOM(globalData.map(c => ({
                    id: c.critique_id, category: c.category, type: c.type, title: c.title,
                    strengthSummary: c.strength_summary, problemCore: c.problem_core,
                    suggestion: c.suggestion, example: c.example, options: c.options, optionsLabel: c.options_label
                })));
            } else {
                 // C. é€£å…¨åŸŸéƒ½ç„¡ï¼Œè¼‰å…¥ç³»çµ±é è¨­
                 const allDefault = Object.values(cannedCritiques).flat();
                 const unique = Array.from(new Map(allDefault.map(c => [c.id, c])).values());
                 applyCritiquesToDOM(unique);
            }
        }

        buildChecklist(); 
        buildOverviewPage(); 
        updateStudentDropdown(); 
        renderStudentOverviewTable();
        
        const studentSelect = document.getElementById('student-select');
        if (studentSelect.options.length > 0) {
            studentSelect.selectedIndex = 0;
            loadStudentData(studentSelect.value);
        }
        showPage('page2');
        showToast(`å·²è¼‰å…¥ï¼š${fullProject.class_name || 'æœªå‘½å'}`, "success");

    } catch (error) {
        alert(`è¼‰å…¥å¤±æ•—ï¼š${error.message}`);
    } finally {
        authStatus.textContent = originalText;
        updateUIBasedOnAuthState();
    }
}

function updateUIBasedOnAuthState() {
    const authStatus = document.getElementById('auth-status');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const syncBtn = document.getElementById('sync-btn');
    if (currentUser) {
        authStatus.textContent = `å·²ç™»å…¥: ${currentUser.email}`;
        loginBtn.style.display = 'none'; logoutBtn.style.display = 'inline-flex'; syncBtn.style.display = 'inline-flex';
        if (isDataDirty) {
            syncBtn.disabled = false; syncBtn.classList.add('dirty'); syncBtn.textContent = 'å„²å­˜è®Šæ›´åˆ°é›²ç«¯';
        } else {
            syncBtn.disabled = false; syncBtn.classList.remove('dirty'); syncBtn.textContent = 'è³‡æ–™å·²åŒæ­¥';
        }
    } else {
        authStatus.textContent = 'é›¢ç·šæ¨¡å¼';
        loginBtn.style.display = 'inline-flex'; logoutBtn.style.display = 'none'; syncBtn.style.display = 'none';
    }
}

/* ... (Other unchanged functions) ... */

function adjustFontSize(direction) {
    const root = document.documentElement;
    let currentScale = parseFloat(root.style.getPropertyValue('--font-scale') || DEFAULT_FONT_SCALE);
    if (direction === 'increase') currentScale = Math.min(MAX_FONT_SCALE, currentScale + FONT_SCALE_STEP);
    else if (direction === 'decrease') currentScale = Math.max(MIN_FONT_SCALE, currentScale - FONT_SCALE_STEP);
    else currentScale = DEFAULT_FONT_SCALE;
    root.style.setProperty('--font-scale', currentScale);
    root.style.fontSize = `calc(16px * ${currentScale})`;
    saveFontSize(currentScale);
}
function saveFontSize(scale) { try { localStorage.setItem(FONT_SCALE_KEY, scale); } catch (e) {} }
function loadFontSize() { try { const savedScale = localStorage.getItem(FONT_SCALE_KEY); const scale = parseFloat(savedScale) || DEFAULT_FONT_SCALE; const root = document.documentElement; root.style.setProperty('--font-scale', scale); root.style.fontSize = `calc(16px * ${scale})`; } catch (e) {} }
function scrollToSection(event, targetId) { event.preventDefault(); const target = document.getElementById(targetId); if(target) { const top = target.getBoundingClientRect().top + window.pageYOffset - 80; window.scrollTo({top, behavior: 'smooth'}); } }
function showPage(pageId, focusId) { document.querySelectorAll('.page-content').forEach(p=>p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active')); document.getElementById('nav-'+pageId).classList.add('active'); if(pageId==='page2' && document.getElementById('student-select').value) loadStudentData(document.getElementById('student-select').value); if(focusId) setTimeout(()=>document.getElementById(focusId)?.focus(),100); }
function initFloatingNavObserver() { const sections = document.querySelectorAll('#page2 .section-box'); const links = document.querySelectorAll('#floating-nav .floating-nav-btn'); const obs = new IntersectionObserver(ent=>{ ent.forEach(e=>{ if(e.isIntersecting) { links.forEach(l=>l.classList.remove('active')); const id=e.target.id; const link=document.querySelector(`#floating-nav a[href="#${id}"]`); if(link) link.classList.add('active'); } }) }, {threshold:0.2}); sections.forEach(s=>obs.observe(s)); }
function toggleAllDetails(id, open) { document.getElementById(id)?.querySelectorAll('details').forEach(d=>d.open=open); }
/* ... (Keep loadDefaultCritiques, etc.) ... */
function saveCurrentStudentData() {
  const studentOriginalName = document.getElementById('student-select').value;
  if (!studentOriginalName) { alert('è«‹å…ˆé¸æ“‡ä¸€ä½å­¸ç”Ÿã€‚'); return; }
  const record = allStudentRecords.find(r => r.originalName === studentOriginalName);
  if (!record) return;

  const checkedCritiques = [];
  const excellentCritiques = [];
  const problemCritiques = [];
  document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
    const id = cb.id;
    const data = { id, selectValues: [] };
    const module = document.getElementById(`module-${id}`);
    if(module) {
        module.querySelectorAll('select').forEach((s, i) => {
            let val = s.value; 
            if(val==='å…¶ä»–') val = document.getElementById(`${id}-other-${i+1}-text`)?.value || '';
            data.selectValues.push({ value: s.value, otherValue: val });
        });
    }
    checkedCritiques.push(data);
    const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if(el) (el.dataset.type==='excellent' ? excellentCritiques : problemCritiques).push({id});
  });

  const uC = document.getElementById('unique-comment').value;
  const uCB = uC.trim() ? `ã€ç‰¹åˆ¥ç•™è¨€ã€‘\n${uC.trim()}\n\n` : '';

  record.data = {
      class: document.getElementById('student-class').value,
      topic: document.getElementById('topic').value,
      uniqueComment: uC,
      scores: {
        content: document.getElementById('score-content').value,
        expression: document.getElementById('score-expression').value,
        structure: document.getElementById('score-structure').value,
        punctuation: document.getElementById('score-punctuation').value,
        typos: document.getElementById('score-typos').value,
        total: document.getElementById('score-total').value
      },
      typos: [...currentTypos],
      checkedCritiques,
      selectedTitles: checkedCritiques.map(c => getCritiqueData(c.id, 'title')).join('ï¼›'),
      fullComment: document.getElementById('full-output').value,
      studentComment: document.getElementById('student-report-output').value,
      pureFullComment: uCB + generatePureFullVersion(excellentCritiques, problemCritiques),
      pureStudentComment: uCB + generatePureStudentReport(excellentCritiques, problemCritiques)
  };
  
  renderStudentOverviewTable();
  isDataDirty = true;
  updateUIBasedOnAuthState();
  showToast(`å·²å„²å­˜ ${studentOriginalName}`, "success");
  scrollToSection(new Event('d'), 'grading-section-student');
}
// ... (Other helper functions remain unchanged) ...
</script>
</body>
</html>
